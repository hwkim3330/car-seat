<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>KETI Smart Seat Monitor</title>
    <script src="libs/three.min.js"></script>
    <script src="libs/OrbitControls.js"></script>
    <script src="libs/GLTFLoader.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        :root {
            --bg: #000000;
            --bg-card: #1c1c1e;
            --bg-elevated: #2c2c2e;
            --bg-sheet: #1c1c1e;
            --border: rgba(255,255,255,0.08);
            --text: #ffffff;
            --text-secondary: #8e8e93;
            --text-tertiary: #48484a;
            --blue: #0a84ff;
            --green: #30d158;
            --red: #ff453a;
            --orange: #ff9f0a;
            --cyan: #64d2ff;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --safe-top: env(safe-area-inset-top, 0px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
            position: fixed; width: 100%; height: 100%;
        }
        .app { display: flex; flex-direction: column; height: 100%; height: 100dvh; }

        /* Top Bar - Compact mobile header */
        .top-bar {
            height: 44px;
            padding-top: var(--safe-top);
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding-left: 16px; padding-right: 16px;
            flex-shrink: 0; z-index: 30;
        }
        .top-bar-left { display: flex; align-items: center; gap: 8px; }
        .top-bar-left img { height: 18px; opacity: 0.8; }
        .top-bar h1 { font-size: 15px; font-weight: 600; letter-spacing: -0.3px; }
        .top-bar-right { display: flex; align-items: center; gap: 4px; }
        .top-bar-btn {
            width: 32px; height: 32px; border-radius: 8px; border: none;
            background: rgba(255,255,255,0.08); color: var(--text-secondary);
            font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .top-bar-btn:active { background: rgba(255,255,255,0.15); }
        .live-indicator { display: flex; align-items: center; gap: 4px; font-size: 10px; font-weight: 600; color: var(--green); }
        .live-dot { width: 5px; height: 5px; border-radius: 50%; background: var(--green); animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

        /* 3D Canvas - takes most of the screen */
        .canvas-area {
            flex: 1; position: relative; background: #000;
            min-height: 0;
        }
        #canvas3d { width: 100%; height: 100%; display: block; touch-action: none; }

        /* Floating sensor tabs over canvas */
        .sensor-tabs {
            position: absolute; top: 12px; left: 12px; right: 12px;
            display: flex; gap: 6px; z-index: 10;
            overflow-x: auto; -webkit-overflow-scrolling: touch;
            scrollbar-width: none; padding-bottom: 4px;
        }
        .sensor-tabs::-webkit-scrollbar { display: none; }
        .sensor-tab {
            flex-shrink: 0;
            padding: 8px 14px; border-radius: 20px;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.08);
            color: var(--text-secondary); font-size: 12px; font-weight: 500;
            cursor: pointer; display: flex; align-items: center; gap: 6px;
            transition: all 0.2s ease; white-space: nowrap;
        }
        .sensor-tab:active { transform: scale(0.95); }
        .sensor-tab.active { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.2); color: var(--text); }
        .sensor-tab .dot { width: 6px; height: 6px; border-radius: 50%; }

        /* Floating stats overlay */
        .floating-stats {
            position: absolute; bottom: 12px; left: 12px; right: 12px;
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;
            z-index: 10;
        }
        .float-stat {
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px; padding: 10px 8px; text-align: center;
        }
        .float-stat .val {
            font-size: 18px; font-weight: 700; font-variant-numeric: tabular-nums;
            letter-spacing: -0.5px;
        }
        .float-stat .lbl {
            font-size: 8px; color: var(--text-secondary); margin-top: 2px;
            text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500;
        }

        /* Legend - centered above stats */
        .legend {
            position: absolute; bottom: 86px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px; padding: 6px 12px; display: none;
            align-items: center; gap: 8px; z-index: 10;
        }
        .legend.show { display: flex; }
        .legend-title { font-size: 9px; color: var(--text-secondary); font-weight: 600; white-space: nowrap; }
        .legend-labels { display: flex; justify-content: space-between; width: 120px; font-size: 7px; color: var(--text-tertiary); font-weight: 500; }

        /* Bottom Sheet - sliding panel */
        .bottom-sheet {
            flex-shrink: 0;
            background: var(--bg-sheet);
            border-top: 1px solid var(--border);
            border-radius: 16px 16px 0 0;
            max-height: 55vh; min-height: 56px;
            overflow: hidden;
            transition: max-height 0.35s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 20;
        }
        .bottom-sheet.collapsed { max-height: 56px; }

        /* Drag handle */
        .sheet-handle {
            padding: 10px 0 6px;
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            cursor: pointer;
        }
        .sheet-handle-bar { width: 36px; height: 4px; border-radius: 2px; background: rgba(255,255,255,0.15); }
        .sheet-handle-label { font-size: 12px; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 6px; }
        .sheet-handle-arrow { font-size: 10px; color: var(--text-secondary); transition: transform 0.3s ease; }
        .bottom-sheet.collapsed .sheet-handle-arrow { transform: rotate(180deg); }

        /* Sheet content */
        .sheet-content {
            padding: 0 16px 16px;
            padding-bottom: calc(16px + var(--safe-bottom));
            overflow-y: auto; max-height: calc(55vh - 56px);
            -webkit-overflow-scrolling: touch;
        }

        /* Control cards */
        .ctrl-card {
            background: var(--bg-elevated); border-radius: 12px;
            padding: 14px; margin-bottom: 10px;
            border: 1px solid var(--border);
        }
        .ctrl-card-title {
            font-size: 11px; font-weight: 600; color: var(--text-secondary);
            text-transform: uppercase; letter-spacing: 0.5px;
            margin-bottom: 10px; display: flex; align-items: center; gap: 6px;
        }
        .ctrl-card-title i { font-size: 10px; }

        /* Slider */
        .ctrl-row { margin-bottom: 12px; }
        .ctrl-row:last-child { margin-bottom: 0; }
        .ctrl-row-label {
            display: flex; justify-content: space-between;
            font-size: 13px; color: var(--text); margin-bottom: 6px;
        }
        .ctrl-row-val { font-weight: 600; font-variant-numeric: tabular-nums; }
        input[type="range"] {
            width: 100%; height: 6px; appearance: none; -webkit-appearance: none;
            background: var(--text-tertiary); border-radius: 3px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%;
            background: white; cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* Preset buttons - large touch targets */
        .preset-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .preset-btn {
            padding: 12px 6px; border-radius: 10px;
            border: 1px solid var(--border); background: var(--bg-card);
            color: var(--text-secondary); font-size: 12px; font-weight: 500;
            cursor: pointer; text-align: center; font-family: inherit;
            transition: all 0.15s ease;
        }
        .preset-btn:active { transform: scale(0.95); }
        .preset-btn.active { background: var(--blue); border-color: var(--blue); color: white; }

        /* Temperature list */
        .temp-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        .temp-item:last-child { border-bottom: none; }
        .temp-item-left { display: flex; align-items: center; gap: 8px; }
        .temp-item-dot { width: 4px; height: 20px; border-radius: 2px; }
        .temp-item-name { font-size: 13px; color: var(--text); }
        .temp-item-right { display: flex; align-items: center; gap: 8px; }
        .temp-item-val { font-size: 15px; font-weight: 600; font-variant-numeric: tabular-nums; }
        .temp-btn {
            width: 36px; height: 36px; border-radius: 10px;
            border: 1px solid var(--border); background: var(--bg-card);
            color: var(--text-tertiary); font-size: 14px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .temp-btn:active { background: var(--bg-elevated); }
        .temp-btn.on { background: var(--red); border-color: var(--red); color: white; }
        .temp-btn.cool { background: var(--blue); border-color: var(--blue); color: white; }

        /* Motion bars */
        .motion-row { margin-bottom: 12px; }
        .motion-row:last-child { margin-bottom: 0; }
        .motion-row-head {
            display: flex; justify-content: space-between;
            font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;
        }
        .motion-row-head span:last-child { font-variant-numeric: tabular-nums; color: var(--text); font-weight: 500; }
        .motion-bar-bg { height: 4px; background: var(--text-tertiary); border-radius: 2px; position: relative; overflow: hidden; }
        .motion-bar { position: absolute; top: 0; height: 100%; border-radius: 2px; transition: width 0.15s, left 0.15s; }

        /* Toast */
        .toast {
            position: fixed; top: 60px; left: 50%; transform: translateX(-50%) translateY(-100%);
            background: rgba(30,30,30,0.95);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 12px; padding: 10px 20px; font-size: 13px;
            color: var(--text); font-weight: 500; white-space: nowrap;
            z-index: 100; opacity: 0;
            transition: all 0.3s ease; pointer-events: none;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* Mini heatmap */
        .mini-heatmap-wrap { display: flex; justify-content: center; margin-top: 8px; }
        #miniHeatmap { width: 140px; height: 140px; border-radius: 10px; background: var(--bg-card); border: 1px solid var(--border); }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 0; height: 0; }

        /* Alert badge */
        .alert-badge {
            position: absolute; top: -4px; right: -4px;
            width: 16px; height: 16px; border-radius: 50%;
            background: var(--red); color: white; font-size: 9px; font-weight: 700;
            display: flex; align-items: center; justify-content: center;
        }

        /* Sim toggle */
        .sim-toggle {
            display: flex; align-items: center; gap: 8px;
            padding: 10px; background: var(--bg-card); border-radius: 10px;
            border: 1px solid var(--border); margin-bottom: 10px;
        }
        .sim-dot { width: 6px; height: 6px; border-radius: 50%; }
        .sim-dot.running { background: var(--green); animation: pulse 1.5s ease-in-out infinite; }
        .sim-dot.paused { background: var(--orange); }
        .sim-toggle-label { flex: 1; font-size: 13px; font-weight: 500; }
        .sim-toggle-btn {
            width: 36px; height: 36px; border-radius: 10px;
            border: 1px solid var(--border); background: var(--bg-elevated);
            color: var(--text); font-size: 14px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .sim-toggle-btn:active { background: var(--text-tertiary); }
    </style>
</head>
<body>
<div class="app">
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="top-bar-left">
            <img src="keti.png" alt="KETI">
            <h1>Smart Seat</h1>
        </div>
        <div class="live-indicator"><div class="live-dot"></div>LIVE</div>
        <div class="top-bar-right">
            <button class="top-bar-btn" onclick="exportJSON()"><i class="fas fa-download"></i></button>
            <button class="top-bar-btn" onclick="toggleAutoRotate()"><i class="fas fa-sync-alt"></i></button>
        </div>
    </div>

    <!-- 3D Canvas with overlays -->
    <div class="canvas-area">
        <div id="canvas3d"></div>

        <!-- Sensor tabs -->
        <div class="sensor-tabs">
            <div class="sensor-tab active" data-sensor="pressure" onclick="toggleSensor('pressure')">
                <div class="dot" style="background:var(--red);"></div>Pressure
            </div>
            <div class="sensor-tab" data-sensor="temperature" onclick="toggleSensor('temperature')">
                <div class="dot" style="background:var(--orange);"></div>Temp
            </div>
            <div class="sensor-tab" data-sensor="position" onclick="toggleSensor('position')">
                <div class="dot" style="background:var(--blue);"></div>Position
            </div>
            <div class="sensor-tab" data-sensor="motion" onclick="toggleSensor('motion')">
                <div class="dot" style="background:var(--green);"></div>Motion
            </div>
        </div>

        <!-- Floating stats -->
        <div class="floating-stats" id="floatingStats">
            <div class="float-stat"><div class="val" id="fStat1" style="color:var(--red);">0</div><div class="lbl">Load (kg)</div></div>
            <div class="float-stat"><div class="val" id="fStat2" style="color:var(--green);">--</div><div class="lbl">Status</div></div>
            <div class="float-stat"><div class="val" id="fStat3">0</div><div class="lbl">Avg kPa</div></div>
            <div class="float-stat"><div class="val" id="fStat4" style="color:var(--orange);">0</div><div class="lbl">Peak kPa</div></div>
        </div>

        <!-- Legend -->
        <div class="legend" id="pressureLegend">
            <span class="legend-title">kPa</span>
            <div>
                <canvas id="legendBar" width="120" height="8" style="border-radius:4px;"></canvas>
                <div class="legend-labels"><span>0</span><span>50</span><span>100</span></div>
            </div>
        </div>
    </div>

    <!-- Bottom Sheet -->
    <div class="bottom-sheet" id="bottomSheet">
        <div class="sheet-handle" onclick="toggleSheet()">
            <div class="sheet-handle-bar"></div>
            <div class="sheet-handle-label">
                Controls
                <i class="fas fa-chevron-down sheet-handle-arrow"></i>
            </div>
        </div>
        <div class="sheet-content" id="sheetContent">
            <!-- Simulation -->
            <div class="sim-toggle">
                <div class="sim-dot running" id="simDot"></div>
                <span class="sim-toggle-label" id="simLabel">Simulation Running</span>
                <button class="sim-toggle-btn" id="simBtn" onclick="toggleSimulation()"><i class="fas fa-pause"></i></button>
            </div>

            <!-- Pressure controls -->
            <div class="ctrl-card" id="pressureCtrl">
                <div class="ctrl-card-title"><i class="fas fa-weight-hanging"></i> Pressure Settings</div>
                <div class="ctrl-row">
                    <div class="ctrl-row-label"><span>Occupant Weight</span><span class="ctrl-row-val" id="weightVal">70 kg</span></div>
                    <input type="range" min="30" max="130" value="70" id="weightSlider" oninput="updateWeight(this.value)">
                </div>
                <div class="ctrl-row">
                    <div class="ctrl-row-label"><span>Occupancy</span></div>
                    <div class="preset-row">
                        <button class="preset-btn active" onclick="setOccupancy('seated',this)">Seated</button>
                        <button class="preset-btn" onclick="setOccupancy('empty',this)">Empty</button>
                        <button class="preset-btn" onclick="setOccupancy('child',this)">Child</button>
                        <button class="preset-btn" onclick="setOccupancy('heavy',this)">Heavy</button>
                    </div>
                </div>
                <div class="mini-heatmap-wrap"><canvas id="miniHeatmap" width="140" height="140"></canvas></div>
            </div>

            <!-- Temperature controls -->
            <div class="ctrl-card" id="tempCtrl" style="display:none;">
                <div class="ctrl-card-title"><i class="fas fa-thermometer-half"></i> Temperature Zones</div>
                <div id="tempZoneList"></div>
            </div>

            <!-- Position controls -->
            <div class="ctrl-card" id="posCtrl" style="display:none;">
                <div class="ctrl-card-title"><i class="fas fa-arrows-alt"></i> Seat Position</div>
                <div class="preset-row" style="margin-bottom:12px;">
                    <button class="preset-btn active" onclick="applyPreset('normal',this)">Drive</button>
                    <button class="preset-btn" onclick="applyPreset('sport',this)">Sport</button>
                    <button class="preset-btn" onclick="applyPreset('relax',this)">Relax</button>
                    <button class="preset-btn" onclick="applyPreset('entry',this)">Entry</button>
                </div>
                <div class="ctrl-row">
                    <div class="ctrl-row-label"><span>Fore / Aft</span><span class="ctrl-row-val" id="fbVal">0</span></div>
                    <input type="range" min="-100" max="100" value="0" id="fbSlider" oninput="updatePosition('forwardBack',this.value)">
                </div>
                <div class="ctrl-row">
                    <div class="ctrl-row-label"><span>Height</span><span class="ctrl-row-val" id="udVal">0</span></div>
                    <input type="range" min="-100" max="100" value="0" id="udSlider" oninput="updatePosition('upDown',this.value)">
                </div>
                <div class="ctrl-row">
                    <div class="ctrl-row-label"><span>Recline</span><span class="ctrl-row-val" id="recVal">18°</span></div>
                    <input type="range" min="5" max="50" value="18" id="recSlider" oninput="updatePosition('recline',this.value)">
                </div>
                <div class="ctrl-row">
                    <div class="ctrl-row-label"><span>Headrest</span><span class="ctrl-row-val" id="hrVal">0</span></div>
                    <input type="range" min="0" max="100" value="0" id="hrSlider" oninput="updatePosition('headrest',this.value)">
                </div>
            </div>

            <!-- Motion controls -->
            <div class="ctrl-card" id="motionCtrl" style="display:none;">
                <div class="ctrl-card-title"><i class="fas fa-wave-square"></i> Motion Data</div>
                <div class="ctrl-row">
                    <div class="ctrl-row-label"><span>Vehicle Speed</span><span class="ctrl-row-val" id="speedVal">0 km/h</span></div>
                    <input type="range" min="0" max="200" value="0" id="speedSlider" oninput="updateSpeed(this.value)">
                </div>
                <div class="motion-row">
                    <div class="motion-row-head"><span>X-Axis (Lateral)</span><span id="rAX">0.00 G</span></div>
                    <div class="motion-bar-bg"><div class="motion-bar" id="barAX" style="background:var(--red);width:50%;left:25%;"></div></div>
                </div>
                <div class="motion-row">
                    <div class="motion-row-head"><span>Y-Axis (Vertical)</span><span id="rAY">0.00 G</span></div>
                    <div class="motion-bar-bg"><div class="motion-bar" id="barAY" style="background:var(--green);width:50%;left:25%;"></div></div>
                </div>
                <div class="motion-row">
                    <div class="motion-row-head"><span>Z-Axis (Longitudinal)</span><span id="rAZ">0.00 G</span></div>
                    <div class="motion-bar-bg"><div class="motion-bar" id="barAZ" style="background:var(--blue);width:50%;left:25%;"></div></div>
                </div>
            </div>

            <!-- View Settings -->
            <div class="ctrl-card">
                <div class="ctrl-card-title"><i class="fas fa-eye"></i> View Settings</div>
                <div class="ctrl-row">
                    <div class="ctrl-row-label"><span>Seat Opacity</span><span class="ctrl-row-val" id="opVal">100%</span></div>
                    <input type="range" min="10" max="100" value="100" id="opSlider" oninput="setSeatOpacity(this.value)">
                </div>
                <div class="preset-row" style="grid-template-columns:1fr 1fr;">
                    <button class="preset-btn" onclick="resetCamera()">Reset View</button>
                    <button class="preset-btn" onclick="exportCSV()"><i class="fas fa-table"></i> CSV</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ==================== State ====================
const activeSensors = new Set(['pressure']);
let simulationRunning = true;
const thresholds = { pressure: 80, temperature: 40, vibration: 0.7 };

const seatState = {
    occupied: true, occupantWeight: 70, vehicleSpeed: 0,
    forwardBack: 0, upDown: 0, recline: 18, headrest: 0
};

const temperatureZones = [
    { name: 'L-Cushion', temp: 22, target: 28, heating: false, cooling: false },
    { name: 'R-Cushion', temp: 22, target: 28, heating: false, cooling: false },
    { name: 'L-Back', temp: 22, target: 30, heating: false, cooling: false },
    { name: 'R-Back', temp: 22, target: 30, heating: false, cooling: false },
    { name: 'L-Bolster', temp: 22, target: 26, heating: false, cooling: false },
    { name: 'R-Bolster', temp: 22, target: 26, heating: false, cooling: false }
];

const motionState = { accelX: 0, accelY: 0, accelZ: 0, vibAmp: 0, vibFreq: 30 };
const pressureGrid = new Float32Array(16 * 16);

// ==================== Bottom Sheet ====================
let sheetOpen = true;
function toggleSheet() {
    sheetOpen = !sheetOpen;
    document.getElementById('bottomSheet').classList.toggle('collapsed', !sheetOpen);
}

// Swipe gesture for sheet
let touchStartY = 0;
const sheetEl = document.getElementById('bottomSheet');
sheetEl.addEventListener('touchstart', e => { touchStartY = e.touches[0].clientY; }, { passive: true });
sheetEl.addEventListener('touchend', e => {
    const dy = e.changedTouches[0].clientY - touchStartY;
    if (dy > 40 && sheetOpen) toggleSheet();
    else if (dy < -40 && !sheetOpen) toggleSheet();
}, { passive: true });

// ==================== Three.js Setup ====================
let scene, camera, renderer, controls;
let seatGroup;
let cushionMesh, backrestMesh, headrestMesh, leftBolsterMesh, rightBolsterMesh;
let railMeshes = [];
let pressureOverlayCushion, pressureOverlayBack;
let pressureCanvasCushion, pressureCtxCushion, pressureTextureCushion;
let pressureCanvasBack, pressureCtxBack, pressureTextureBack;
let arrowX, arrowY, arrowZ, arrowGroup;
const clock = new THREE.Clock();

function initScene() {
    const container = document.getElementById('canvas3d');
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a0a0a);

    camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.01, 100);
    camera.position.set(0.8, 0.8, 1.2);

    renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: 'high-performance' });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.1;
    container.appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.08;
    controls.target.set(0, 0.30, 0);
    controls.minDistance = 0.4;
    controls.maxDistance = 3;
    controls.maxPolarAngle = Math.PI * 0.85;
    // Mobile-friendly touch
    controls.touches = { ONE: THREE.TOUCH.ROTATE, TWO: THREE.TOUCH.DOLLY_PAN };

    // Lighting
    scene.add(new THREE.AmbientLight(0x222222, 0.8));
    const main = new THREE.DirectionalLight(0xffeedd, 0.9);
    main.position.set(2, 3, 2);
    main.castShadow = true;
    main.shadow.mapSize.set(512, 512);
    scene.add(main);
    const fill = new THREE.DirectionalLight(0x446688, 0.3);
    fill.position.set(-2, 2, -1);
    scene.add(fill);
    const accent = new THREE.PointLight(0x0a84ff, 0.1, 3);
    accent.position.set(0, -0.3, 0.5);
    scene.add(accent);

    const grid = new THREE.GridHelper(2, 12, 0x1a1a1a, 0x111111);
    grid.material.opacity = 0.5;
    grid.material.transparent = true;
    scene.add(grid);

    const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(4, 4),
        new THREE.MeshStandardMaterial({ color: 0x0a0a0a, roughness: 0.95 })
    );
    floor.rotation.x = -Math.PI / 2;
    floor.position.y = -0.01;
    floor.receiveShadow = true;
    scene.add(floor);

    seatGroup = new THREE.Group();
    scene.add(seatGroup);

    const loader = new THREE.GLTFLoader();
    loader.load('./models/car-seat.glb',
        (gltf) => {
            const model = gltf.scene;
            const box = new THREE.Box3().setFromObject(model);
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());
            const scale = 0.9 / Math.max(size.x, size.y, size.z);
            model.scale.set(scale, scale, scale);
            model.position.set(-center.x * scale, -box.min.y * scale, -center.z * scale);
            model.traverse(c => { if (c.isMesh) { c.castShadow = true; c.receiveShadow = true; } });
            seatGroup.add(model);
            buildProceduralSeat();
        },
        undefined,
        () => { buildProceduralSeat(); }
    );

    setupPressureOverlays();
    setupMotionArrows();

    window.addEventListener('resize', () => {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    });
}

// ==================== Procedural Seat ====================
function buildProceduralSeat() {
    const seatMat = new THREE.MeshStandardMaterial({ color: 0x222222, roughness: 0.45, metalness: 0.1 });
    const frameMat = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.2, metalness: 0.7 });
    const bolsterMat = new THREE.MeshStandardMaterial({ color: 0x262626, roughness: 0.4, metalness: 0.1 });

    const railGeo = new THREE.BoxGeometry(0.04, 0.02, 0.45);
    const rail1 = new THREE.Mesh(railGeo, frameMat); rail1.position.set(-0.15, 0.01, 0); rail1.castShadow = true;
    seatGroup.add(rail1); railMeshes.push(rail1);
    const rail2 = new THREE.Mesh(railGeo, frameMat); rail2.position.set(0.15, 0.01, 0); rail2.castShadow = true;
    seatGroup.add(rail2); railMeshes.push(rail2);

    cushionMesh = new THREE.Mesh(new THREE.BoxGeometry(0.44, 0.07, 0.44), seatMat.clone());
    cushionMesh.position.set(0, 0.09, 0); cushionMesh.castShadow = true; cushionMesh.receiveShadow = true;
    seatGroup.add(cushionMesh);

    backrestMesh = new THREE.Mesh(new THREE.BoxGeometry(0.42, 0.55, 0.07), seatMat.clone());
    backrestMesh.position.set(0, 0.42, -0.2);
    backrestMesh.rotation.x = -THREE.MathUtils.degToRad(seatState.recline);
    backrestMesh.castShadow = true; backrestMesh.receiveShadow = true;
    seatGroup.add(backrestMesh);

    headrestMesh = new THREE.Mesh(new THREE.BoxGeometry(0.22, 0.16, 0.06), seatMat.clone());
    headrestMesh.position.set(0, 0.78, -0.25); headrestMesh.castShadow = true;
    seatGroup.add(headrestMesh);

    leftBolsterMesh = new THREE.Mesh(new THREE.BoxGeometry(0.06, 0.12, 0.42), bolsterMat.clone());
    leftBolsterMesh.position.set(-0.24, 0.14, 0); leftBolsterMesh.castShadow = true;
    seatGroup.add(leftBolsterMesh);
    rightBolsterMesh = new THREE.Mesh(new THREE.BoxGeometry(0.06, 0.12, 0.42), bolsterMat.clone());
    rightBolsterMesh.position.set(0.24, 0.14, 0); rightBolsterMesh.castShadow = true;
    seatGroup.add(rightBolsterMesh);

    const bbolGeo = new THREE.BoxGeometry(0.06, 0.5, 0.06);
    const lbb = new THREE.Mesh(bbolGeo, bolsterMat.clone());
    lbb.position.set(-0.23, 0.42, -0.16); lbb.rotation.x = -THREE.MathUtils.degToRad(seatState.recline);
    seatGroup.add(lbb);
    const rbb = new THREE.Mesh(bbolGeo, bolsterMat.clone());
    rbb.position.set(0.23, 0.42, -0.16); rbb.rotation.x = -THREE.MathUtils.degToRad(seatState.recline);
    seatGroup.add(rbb);
}

// ==================== Pressure Overlay ====================
function setupPressureOverlays() {
    pressureCanvasCushion = document.createElement('canvas');
    pressureCanvasCushion.width = 128; pressureCanvasCushion.height = 128;
    pressureCtxCushion = pressureCanvasCushion.getContext('2d');
    pressureTextureCushion = new THREE.CanvasTexture(pressureCanvasCushion);
    pressureTextureCushion.minFilter = THREE.LinearFilter;
    pressureOverlayCushion = new THREE.Mesh(
        new THREE.PlaneGeometry(0.42, 0.42),
        new THREE.MeshBasicMaterial({ map: pressureTextureCushion, transparent: true, opacity: 0.85, depthWrite: false, side: THREE.DoubleSide })
    );
    pressureOverlayCushion.rotation.x = -Math.PI / 2;
    pressureOverlayCushion.position.set(0, 0.131, 0);
    seatGroup.add(pressureOverlayCushion);

    pressureCanvasBack = document.createElement('canvas');
    pressureCanvasBack.width = 128; pressureCanvasBack.height = 128;
    pressureCtxBack = pressureCanvasBack.getContext('2d');
    pressureTextureBack = new THREE.CanvasTexture(pressureCanvasBack);
    pressureTextureBack.minFilter = THREE.LinearFilter;
    pressureOverlayBack = new THREE.Mesh(
        new THREE.PlaneGeometry(0.40, 0.50),
        new THREE.MeshBasicMaterial({ map: pressureTextureBack, transparent: true, opacity: 0.75, depthWrite: false, side: THREE.DoubleSide })
    );
    pressureOverlayBack.position.set(0, 0.42, -0.165);
    pressureOverlayBack.rotation.x = -THREE.MathUtils.degToRad(seatState.recline);
    seatGroup.add(pressureOverlayBack);
}

// ==================== Motion Arrows ====================
function setupMotionArrows() {
    arrowGroup = new THREE.Group();
    arrowGroup.visible = false;
    arrowX = new THREE.ArrowHelper(new THREE.Vector3(1,0,0), new THREE.Vector3(0,0.5,0.3), 0.2, 0xff453a, 0.04, 0.025);
    arrowY = new THREE.ArrowHelper(new THREE.Vector3(0,1,0), new THREE.Vector3(0,0.5,0.3), 0.2, 0x30d158, 0.04, 0.025);
    arrowZ = new THREE.ArrowHelper(new THREE.Vector3(0,0,1), new THREE.Vector3(0,0.5,0.3), 0.2, 0x0a84ff, 0.04, 0.025);
    arrowGroup.add(arrowX, arrowY, arrowZ);
    seatGroup.add(arrowGroup);
}

// ==================== Colors ====================
function pressureColor(t) {
    t = Math.max(0, Math.min(1, t));
    let r, g, b;
    if (t < 0.25) { const f = t/0.25; r=0; g=Math.round(f*255); b=255; }
    else if (t < 0.5) { const f=(t-0.25)/0.25; r=0; g=255; b=Math.round(255*(1-f)); }
    else if (t < 0.75) { const f=(t-0.5)/0.25; r=Math.round(255*f); g=255; b=0; }
    else { const f=(t-0.75)/0.25; r=255; g=Math.round(255*(1-f)); b=0; }
    return `rgba(${r},${g},${b},${0.3+t*0.7})`;
}

function temperatureColor(temp) {
    const t = Math.max(0, Math.min(1, (temp-15)/25));
    const c = new THREE.Color();
    if (t < 0.3) c.lerpColors(new THREE.Color(0x0a84ff), new THREE.Color(0x222222), t/0.3);
    else if (t < 0.6) c.set(0x222222);
    else c.lerpColors(new THREE.Color(0xff9f0a), new THREE.Color(0xff453a), (t-0.6)/0.4);
    return c;
}

function gaussian2D(x, y, sx, sy) { return Math.exp(-(x*x)/(2*sx*sx) - (y*y)/(2*sy*sy)); }

// ==================== Simulation ====================
function simulatePressure(time) {
    if (!seatState.occupied) { pressureGrid.fill(0); return; }
    const wFactor = seatState.occupantWeight / 80;
    for (let y=0; y<16; y++) for (let x=0; x<16; x++) {
        const nx=(x/15)*2-1, ny=(y/15)*2-1;
        const lp=gaussian2D(nx+0.35,ny-0.1,0.28,0.32);
        const rp=gaussian2D(nx-0.35,ny-0.1,0.28,0.32);
        const lt=gaussian2D(nx+0.3,ny+0.25,0.22,0.4)*0.35;
        const rt=gaussian2D(nx-0.3,ny+0.25,0.22,0.4)*0.35;
        pressureGrid[y*16+x] = Math.max(0, Math.min(1,
            (lp+rp+lt+rt)*wFactor + Math.sin(time*0.35)*0.015 + Math.sin(time*0.07)*0.025*nx + (Math.random()-0.5)*0.008));
    }
}

function simulateTemperature(dt) {
    temperatureZones.forEach(z => {
        if (z.heating) z.temp += (z.target-z.temp)*dt*0.04;
        else if (z.cooling) z.temp += (18-z.temp)*dt*0.03;
        else z.temp += (22-z.temp)*dt*0.005;
        z.temp = Math.max(5, Math.min(50, z.temp + (Math.random()-0.5)*0.05));
    });
}

function simulateMotion(time) {
    const s = seatState.vehicleSpeed;
    const eFreq = 25+s*0.3, eAmp = 0.05+s*0.004;
    const road = Math.sin(time*2.3)*0.2 + Math.sin(time*5.7)*0.08;
    motionState.accelX = Math.sin(time*0.8)*s*0.008 + (Math.random()-0.5)*0.3;
    motionState.accelY = road*s*0.008 + Math.sin(time*eFreq*0.1)*eAmp;
    motionState.accelZ = Math.cos(time*0.3)*s*0.004 + (Math.random()-0.5)*0.15;
    motionState.vibAmp = (eAmp+Math.abs(road)*0.5)*Math.min(1,s/80);
    motionState.vibFreq = eFreq;
}

// ==================== Render Updates ====================
function updatePressureHeatmapCushion() {
    const ctx=pressureCtxCushion, w=128, h=128;
    ctx.clearRect(0,0,w,h);
    const cw=w/16, ch=h/16;
    for (let y=0;y<16;y++) for (let x=0;x<16;x++) {
        const v=pressureGrid[y*16+x];
        if (v>0.01) { ctx.fillStyle=pressureColor(v); ctx.beginPath(); ctx.arc(x*cw+cw/2,y*ch+ch/2,cw*0.6,0,Math.PI*2); ctx.fill(); }
    }
    pressureTextureCushion.needsUpdate = true;
}

function updatePressureHeatmapBack() {
    const ctx=pressureCtxBack, w=128, h=128;
    ctx.clearRect(0,0,w,h);
    if (!seatState.occupied) { pressureTextureBack.needsUpdate=true; return; }
    const wF=seatState.occupantWeight/80*0.4, cw=w/12, ch=h/16;
    for (let y=0;y<16;y++) for (let x=0;x<12;x++) {
        const nx=(x/11)*2-1, ny=(y/15)*2-1;
        const v=(gaussian2D(nx+0.3,ny+0.1,0.4,0.35)+gaussian2D(nx-0.3,ny+0.1,0.4,0.35))*wF;
        if (v>0.01) { ctx.fillStyle=pressureColor(v); ctx.beginPath(); ctx.arc(x*cw+cw/2,y*ch+ch/2,cw*0.6,0,Math.PI*2); ctx.fill(); }
    }
    pressureTextureBack.needsUpdate = true;
}

function updateTemperatureVisuals() {
    const meshes = [cushionMesh,cushionMesh,backrestMesh,backrestMesh,leftBolsterMesh,rightBolsterMesh];
    temperatureZones.forEach((z,i) => {
        const m=meshes[i]; if (!m) return;
        m.material.emissive = temperatureColor(z.temp);
        m.material.emissiveIntensity = (z.heating||z.cooling) ? 0.5 : 0.15;
    });
}

function updateSeatPositionVisuals() {
    seatGroup.position.z = seatState.forwardBack/100*0.12;
    seatGroup.position.y = seatState.upDown/100*0.04;
    const rec = THREE.MathUtils.degToRad(seatState.recline);
    if (backrestMesh) backrestMesh.rotation.x = -rec;
    if (pressureOverlayBack) pressureOverlayBack.rotation.x = -rec;
    if (headrestMesh) headrestMesh.position.y = 0.78 + seatState.headrest/100*0.06;
}

function updateMotionVisuals(time) {
    if (!arrowGroup.visible) return;
    const s=0.3;
    arrowX.setLength(Math.max(0.05,Math.abs(motionState.accelX)*s),0.04,0.025);
    arrowX.setDirection(new THREE.Vector3(Math.sign(motionState.accelX)||1,0,0).normalize());
    arrowY.setLength(Math.max(0.05,Math.abs(motionState.accelY)*s),0.04,0.025);
    arrowY.setDirection(new THREE.Vector3(0,Math.sign(motionState.accelY)||1,0).normalize());
    arrowZ.setLength(Math.max(0.05,Math.abs(motionState.accelZ)*s),0.04,0.025);
    arrowZ.setDirection(new THREE.Vector3(0,0,Math.sign(motionState.accelZ)||1).normalize());
    if (motionState.vibAmp > 0.01) {
        seatGroup.rotation.z = Math.sin(time*motionState.vibFreq*0.3)*motionState.vibAmp*0.002;
        seatGroup.position.y = (seatState.upDown/100*0.04) + Math.sin(time*motionState.vibFreq*0.5)*motionState.vibAmp*0.003;
    }
}

// ==================== Dashboard ====================
let lastUIUpdate = 0;

function updateFloatingStats() {
    if (activeSensors.has('pressure')) {
        let sum=0, max=0, count=0;
        for (let i=0;i<pressureGrid.length;i++) if (pressureGrid[i]>0.01) { sum+=pressureGrid[i]; count++; max=Math.max(max,pressureGrid[i]); }
        const avg = count>0 ? (sum/count*100).toFixed(0) : '0';
        const peak = (max*100).toFixed(0);
        document.getElementById('fStat1').textContent = seatState.occupied ? seatState.occupantWeight : '0';
        document.getElementById('fStat2').textContent = seatState.occupied ? 'ON' : 'OFF';
        document.getElementById('fStat3').textContent = avg;
        document.getElementById('fStat4').textContent = peak;

        // Mini heatmap
        const mc=document.getElementById('miniHeatmap'), mctx=mc.getContext('2d');
        mctx.clearRect(0,0,140,140);
        const cw=140/16;
        for (let y=0;y<16;y++) for (let x=0;x<16;x++) {
            const v=pressureGrid[y*16+x];
            if (v>0.01) { mctx.fillStyle=pressureColor(v); mctx.fillRect(x*cw,y*cw,cw,cw); }
        }
    }
    if (activeSensors.has('temperature')) {
        const avgT = temperatureZones.reduce((a,z)=>a+z.temp,0)/temperatureZones.length;
        document.getElementById('fStat1').textContent = avgT.toFixed(1);
        document.getElementById('fStat1').parentElement.querySelector('.lbl').textContent = 'Avg °C';
        const maxT = Math.max(...temperatureZones.map(z=>z.temp));
        document.getElementById('fStat2').textContent = maxT.toFixed(1);
        document.getElementById('fStat2').parentElement.querySelector('.lbl').textContent = 'Max °C';
        const heating = temperatureZones.filter(z=>z.heating).length;
        document.getElementById('fStat3').textContent = heating;
        document.getElementById('fStat3').parentElement.querySelector('.lbl').textContent = 'Heating';
        const cooling = temperatureZones.filter(z=>z.cooling).length;
        document.getElementById('fStat4').textContent = cooling;
        document.getElementById('fStat4').parentElement.querySelector('.lbl').textContent = 'Cooling';
    }
    if (activeSensors.has('motion')) {
        document.getElementById('fStat1').textContent = motionState.vibAmp.toFixed(2);
        document.getElementById('fStat1').parentElement.querySelector('.lbl').textContent = 'Vib (G)';
        document.getElementById('fStat2').textContent = Math.round(motionState.vibFreq);
        document.getElementById('fStat2').parentElement.querySelector('.lbl').textContent = 'Freq Hz';
        document.getElementById('fStat3').textContent = seatState.vehicleSpeed;
        document.getElementById('fStat3').parentElement.querySelector('.lbl').textContent = 'Speed';
        document.getElementById('fStat4').textContent = motionState.accelX.toFixed(1);
        document.getElementById('fStat4').parentElement.querySelector('.lbl').textContent = 'Accel X';
        document.getElementById('rAX').textContent = motionState.accelX.toFixed(2)+' G';
        document.getElementById('rAY').textContent = motionState.accelY.toFixed(2)+' G';
        document.getElementById('rAZ').textContent = motionState.accelZ.toFixed(2)+' G';
        setMotionBar('barAX',motionState.accelX,2);
        setMotionBar('barAY',motionState.accelY,2);
        setMotionBar('barAZ',motionState.accelZ,2);
    }
    if (activeSensors.has('position')) {
        document.getElementById('fStat1').textContent = Math.round(seatState.forwardBack*1.5);
        document.getElementById('fStat1').parentElement.querySelector('.lbl').textContent = 'Fore/Aft';
        document.getElementById('fStat2').textContent = Math.round(seatState.upDown*0.5);
        document.getElementById('fStat2').parentElement.querySelector('.lbl').textContent = 'Height';
        document.getElementById('fStat3').textContent = seatState.recline+'°';
        document.getElementById('fStat3').parentElement.querySelector('.lbl').textContent = 'Recline';
        document.getElementById('fStat4').textContent = Math.round(seatState.headrest*0.8);
        document.getElementById('fStat4').parentElement.querySelector('.lbl').textContent = 'Headrest';
    }
}

function setMotionBar(id, value, maxVal) {
    const bar=document.getElementById(id), pct=(value/maxVal)*50;
    if (pct>=0) { bar.style.left='50%'; bar.style.width=Math.min(50,pct)+'%'; }
    else { const w=Math.min(50,Math.abs(pct)); bar.style.left=(50-w)+'%'; bar.style.width=w+'%'; }
}

// ==================== Sensor Toggle ====================
function toggleSensor(name) {
    const tab = document.querySelector(`.sensor-tab[data-sensor="${name}"]`);
    const isActive = tab.classList.toggle('active');
    if (isActive) activeSensors.add(name); else activeSensors.delete(name);

    if (pressureOverlayCushion) pressureOverlayCushion.visible = activeSensors.has('pressure');
    if (pressureOverlayBack) pressureOverlayBack.visible = activeSensors.has('pressure');
    document.getElementById('pressureLegend').classList.toggle('show', activeSensors.has('pressure'));
    document.getElementById('pressureCtrl').style.display = activeSensors.has('pressure') ? '' : 'none';
    document.getElementById('tempCtrl').style.display = activeSensors.has('temperature') ? '' : 'none';
    document.getElementById('posCtrl').style.display = activeSensors.has('position') ? '' : 'none';
    document.getElementById('motionCtrl').style.display = activeSensors.has('motion') ? '' : 'none';
    if (arrowGroup) arrowGroup.visible = activeSensors.has('motion');
    if (!activeSensors.has('temperature'))
        [cushionMesh,backrestMesh,leftBolsterMesh,rightBolsterMesh].forEach(m => { if(m){m.material.emissive=new THREE.Color(0);m.material.emissiveIntensity=0;} });

    // Reset floating stat labels for current primary sensor
    resetStatLabels();
}

function resetStatLabels() {
    if (activeSensors.has('pressure')) {
        const labels = ['Load (kg)', 'Status', 'Avg kPa', 'Peak kPa'];
        const colors = ['var(--red)', 'var(--green)', '', 'var(--orange)'];
        labels.forEach((l, i) => {
            document.getElementById('fStat'+(i+1)).parentElement.querySelector('.lbl').textContent = l;
            if (colors[i]) document.getElementById('fStat'+(i+1)).style.color = colors[i];
            else document.getElementById('fStat'+(i+1)).style.color = '';
        });
    }
}

// ==================== Controls ====================
function toggleSimulation() {
    simulationRunning = !simulationRunning;
    document.getElementById('simDot').className = 'sim-dot '+(simulationRunning?'running':'paused');
    document.getElementById('simLabel').textContent = simulationRunning ? 'Simulation Running' : 'Paused';
    document.getElementById('simBtn').innerHTML = simulationRunning ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
}
function updateWeight(v) { seatState.occupantWeight=+v; document.getElementById('weightVal').textContent=v+' kg'; }
function updateSpeed(v) { seatState.vehicleSpeed=+v; document.getElementById('speedVal').textContent=v+' km/h'; }
function setOccupancy(type, btn) {
    btn.parentElement.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    switch(type) {
        case 'seated': seatState.occupied=true; seatState.occupantWeight=70; document.getElementById('weightSlider').value=70; updateWeight(70); break;
        case 'empty': seatState.occupied=false; break;
        case 'child': seatState.occupied=true; seatState.occupantWeight=25; document.getElementById('weightSlider').value=25; updateWeight(25); break;
        case 'heavy': seatState.occupied=true; seatState.occupantWeight=110; document.getElementById('weightSlider').value=110; updateWeight(110); break;
    }
}
function updatePosition(axis, val) {
    switch(axis) {
        case 'forwardBack': seatState.forwardBack=+val; document.getElementById('fbVal').textContent=val; break;
        case 'upDown': seatState.upDown=+val; document.getElementById('udVal').textContent=val; break;
        case 'recline': seatState.recline=+val; document.getElementById('recVal').textContent=val+'°'; break;
        case 'headrest': seatState.headrest=+val; document.getElementById('hrVal').textContent=val; break;
    }
}
const presets = {
    normal:{forwardBack:0,upDown:0,recline:18,headrest:0},
    sport:{forwardBack:30,upDown:-20,recline:12,headrest:30},
    relax:{forwardBack:-50,upDown:30,recline:38,headrest:50},
    entry:{forwardBack:-100,upDown:0,recline:18,headrest:0}
};
let animTarget = null;
function applyPreset(name, btn) {
    btn.parentElement.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    animTarget = {...presets[name]};
}
function setSeatOpacity(v) {
    document.getElementById('opVal').textContent=v+'%';
    const op=v/100;
    [cushionMesh,backrestMesh,headrestMesh,leftBolsterMesh,rightBolsterMesh].forEach(m => {
        if(!m) return; m.material.transparent=op<1; m.material.opacity=op;
    });
}
function resetCamera() { camera.position.set(0.8,0.8,1.2); controls.target.set(0,0.30,0); }
function toggleAutoRotate() { controls.autoRotate=!controls.autoRotate; controls.autoRotateSpeed=1.5; }

// ==================== Temperature UI ====================
function renderTempZones() {
    const el=document.getElementById('tempZoneList');
    el.innerHTML = temperatureZones.map((z,i) => {
        const hex = '#'+temperatureColor(z.temp).getHexString();
        return `<div class="temp-item">
            <div class="temp-item-left"><div class="temp-item-dot" style="background:${hex};"></div><span class="temp-item-name">${z.name}</span></div>
            <div class="temp-item-right">
                <span class="temp-item-val" style="color:${hex};">${z.temp.toFixed(1)}°</span>
                <button class="temp-btn ${z.heating?'on':''}" onclick="toggleHeating(${i})"><i class="fas fa-fire"></i></button>
                <button class="temp-btn ${z.cooling?'cool':''}" onclick="toggleCooling(${i})"><i class="fas fa-snowflake"></i></button>
            </div></div>`;
    }).join('');
}
function toggleHeating(i) { temperatureZones[i].heating=!temperatureZones[i].heating; if(temperatureZones[i].heating) temperatureZones[i].cooling=false; }
function toggleCooling(i) { temperatureZones[i].cooling=!temperatureZones[i].cooling; if(temperatureZones[i].cooling) temperatureZones[i].heating=false; }

// ==================== Export ====================
function exportJSON() {
    const data = {
        timestamp: new Date().toISOString(), system: 'KETI Smart Seat Monitor',
        seatState: {...seatState},
        pressure: { grid:Array.from(pressureGrid), avg:Array.from(pressureGrid).filter(v=>v>0.01).reduce((a,b)=>a+b,0)/Math.max(1,Array.from(pressureGrid).filter(v=>v>0.01).length)*100, peak:Math.max(...pressureGrid)*100 },
        temperature: temperatureZones.map(z=>({name:z.name,current:z.temp,target:z.target,heating:z.heating,cooling:z.cooling})),
        motion: {...motionState}
    };
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`seat-sensor-${Date.now()}.json`; a.click(); URL.revokeObjectURL(a.href);
    showToast('JSON exported');
}
function exportCSV() {
    const now=new Date().toISOString();
    let csv='timestamp,sensor_type,zone,value,unit\n';
    for (let y=0;y<16;y++) for (let x=0;x<16;x++) csv+=`${now},pressure,cushion_${x}_${y},${(pressureGrid[y*16+x]*100).toFixed(2)},kPa\n`;
    temperatureZones.forEach(z => csv+=`${now},temperature,${z.name},${z.temp.toFixed(2)},C\n`);
    csv+=`${now},motion,accel_x,${motionState.accelX.toFixed(4)},G\n`;
    csv+=`${now},motion,accel_y,${motionState.accelY.toFixed(4)},G\n`;
    csv+=`${now},motion,accel_z,${motionState.accelZ.toFixed(4)},G\n`;
    const blob=new Blob([csv],{type:'text/csv'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`seat-sensor-${Date.now()}.csv`; a.click(); URL.revokeObjectURL(a.href);
    showToast('CSV exported');
}

// ==================== Utils ====================
let toastTimer;
function showToast(msg) { const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'),2500); }
function drawLegend() { const ctx=document.getElementById('legendBar').getContext('2d'); for(let x=0;x<120;x++){ctx.fillStyle=pressureColor(x/120);ctx.fillRect(x,0,1,8);} }

// ==================== Animation Loop ====================
function animate() {
    requestAnimationFrame(animate);
    const dt=Math.min(clock.getDelta(),0.1), elapsed=clock.getElapsedTime();

    if (simulationRunning) { simulatePressure(elapsed); simulateTemperature(dt); simulateMotion(elapsed); }

    if (animTarget) {
        let done=true;
        ['forwardBack','upDown','recline','headrest'].forEach(k => {
            const diff=animTarget[k]-seatState[k];
            if (Math.abs(diff)>0.5) { seatState[k]+=diff*dt*3; done=false; } else seatState[k]=animTarget[k];
        });
        document.getElementById('fbSlider').value=seatState.forwardBack;
        document.getElementById('udSlider').value=seatState.upDown;
        document.getElementById('recSlider').value=seatState.recline;
        document.getElementById('hrSlider').value=seatState.headrest;
        document.getElementById('fbVal').textContent=Math.round(seatState.forwardBack);
        document.getElementById('udVal').textContent=Math.round(seatState.upDown);
        document.getElementById('recVal').textContent=Math.round(seatState.recline)+'°';
        document.getElementById('hrVal').textContent=Math.round(seatState.headrest);
        if (done) animTarget=null;
    }

    if (activeSensors.has('pressure')) { updatePressureHeatmapCushion(); updatePressureHeatmapBack(); }
    if (activeSensors.has('temperature')) updateTemperatureVisuals();
    if (activeSensors.has('position')) updateSeatPositionVisuals();
    if (activeSensors.has('motion')) updateMotionVisuals(elapsed);

    if (elapsed-lastUIUpdate>0.2) { updateFloatingStats(); if(activeSensors.has('temperature')) renderTempZones(); lastUIUpdate=elapsed; }

    controls.update();
    renderer.render(scene, camera);
}

// ==================== Init ====================
initScene();
drawLegend();
document.getElementById('pressureLegend').classList.add('show');
animate();
</script>
</body>
</html>
