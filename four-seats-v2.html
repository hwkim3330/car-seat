<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KETI — 4-Seat Smart Monitoring v2</title>
    <script src="libs/three.min.js"></script>
    <script src="libs/OrbitControls.js"></script>
    <script src="libs/GLTFLoader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --bg:#f5f5f7;--surface:rgba(255,255,255,0.8);--card:white;
            --border:rgba(0,0,0,0.06);--text:#1d1d1f;--text2:#6e6e73;--text3:#aeaeb2;
            --accent:#007aff;--accent-dim:rgba(0,122,255,0.1);
            --green:#34c759;--red:#ff3b30;--orange:#ff9f0a;--purple:#af52de;
            --scene-bg:#f0f0f2;
        }
        body.dark{
            --bg:#0c0c10;--surface:rgba(255,255,255,0.04);--card:rgba(255,255,255,0.06);
            --border:rgba(255,255,255,0.06);--text:#e8e8ed;--text2:#6e6e73;--text3:#48484a;
            --accent:#0a84ff;--accent-dim:rgba(10,132,255,0.15);
            --green:#30d158;--red:#ff453a;--orange:#ff9f0a;--purple:#bf5af2;
            --scene-bg:#0c0c10;
        }
        body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;-webkit-font-smoothing:antialiased}
        .app{display:flex;flex-direction:column;height:100vh}

        /* Header */
        .hdr{height:48px;flex-shrink:0;z-index:20;background:var(--card);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px}
        .hdr-l{display:flex;align-items:center;gap:12px}
        .hdr-l img{height:24px;opacity:0.9}
        .hdr-div{width:1px;height:18px;background:var(--border)}
        .hdr-l h1{font-size:14px;font-weight:600;letter-spacing:-0.3px}
        .tag{font-size:9px;font-weight:700;color:var(--accent);background:var(--accent-dim);padding:2px 7px;border-radius:4px;letter-spacing:0.5px}
        .hdr-c{display:flex;align-items:center;gap:10px}
        .pill{display:flex;align-items:center;gap:5px;padding:3px 10px;border-radius:100px;font-size:10px;font-weight:500;background:rgba(52,199,89,0.1);color:#248a3d}
        .pill-dot{width:5px;height:5px;border-radius:50%;background:currentColor;animation:blink 2s ease-in-out infinite}
        @keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}
        .hdr-r{display:flex;align-items:center;gap:6px}
        .clock{font-size:11px;color:var(--text2);font-weight:500;font-variant-numeric:tabular-nums;margin-right:6px}
        .btn{padding:5px 12px;border-radius:8px;border:none;background:rgba(0,0,0,0.04);color:var(--text);font-size:11px;font-weight:500;font-family:inherit;cursor:pointer;display:inline-flex;align-items:center;gap:5px;transition:all .15s}
        body.dark .btn{background:rgba(255,255,255,0.06)}
        .btn:hover{opacity:.8}.btn:active{transform:scale(.97)}
        .btn-accent{background:var(--accent);color:white}

        /* Content */
        .content{flex:1;display:flex;overflow:hidden}
        .panel{flex-shrink:0;overflow-y:auto;background:var(--surface);backdrop-filter:blur(20px)}
        .panel::-webkit-scrollbar{width:4px}.panel::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.08);border-radius:2px}
        body.dark .panel::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08)}
        .lp{width:260px;border-right:1px solid var(--border)}
        .rp{width:300px;border-left:1px solid var(--border);display:flex;flex-direction:column}

        .sec{padding:12px 14px}.sec+.sec{border-top:1px solid var(--border)}
        .sec-t{font-size:10px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px;display:flex;align-items:center;gap:5px}
        .sec-t i{font-size:9px}

        /* Car top view */
        .car-tv{position:relative;width:200px;height:150px;margin:0 auto 6px;background:rgba(0,0,0,0.02);border-radius:14px;border:1px solid var(--border)}
        body.dark .car-tv{background:rgba(255,255,255,0.02)}
        .car-tv svg{position:absolute;inset:0}
        .car-fl{position:absolute;top:6px;left:50%;transform:translateX(-50%);font-size:8px;font-weight:600;color:var(--text3);letter-spacing:1px}
        .cdot{position:absolute;width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;cursor:pointer;transition:all .2s;border:2px solid transparent}
        .cdot:hover{transform:scale(1.08)}
        .cdot.occ{background:rgba(52,199,89,.15);color:#248a3d}
        .cdot.empty{background:rgba(0,0,0,.03);color:var(--text3)}
        body.dark .cdot.occ{background:rgba(48,209,88,.2);color:#30d158}
        body.dark .cdot.empty{background:rgba(255,255,255,.04);color:var(--text3)}
        .cdot.sel{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}

        /* Seat cards */
        .sc{padding:8px 10px;border-radius:10px;cursor:pointer;background:var(--card);border:1.5px solid transparent;margin-bottom:4px;display:flex;align-items:center;gap:8px;transition:all .15s;box-shadow:0 1px 3px rgba(0,0,0,.03)}
        .sc:hover{box-shadow:0 2px 8px rgba(0,0,0,.06)}.sc.sel{border-color:var(--accent)}
        .sc-icon{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:13px}
        .sc-det{flex:1}.sc-name{font-size:11px;font-weight:600}.sc-sub{font-size:9px;color:var(--text2);margin-top:1px}

        /* Controls */
        .ctrl{margin-bottom:8px}
        .ctrl-h{display:flex;justify-content:space-between;font-size:11px;margin-bottom:2px}
        .ctrl-h span:first-child{color:var(--text2);font-weight:500}
        .ctrl-v{color:var(--text);font-weight:600;font-variant-numeric:tabular-nums}
        input[type=range]{width:100%;height:4px;appearance:none;-webkit-appearance:none;background:#e5e5ea;border-radius:2px;outline:none;cursor:pointer}
        body.dark input[type=range]{background:rgba(255,255,255,.08)}
        input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:white;cursor:pointer;box-shadow:0 1px 4px rgba(0,0,0,.15),0 0 0 1px rgba(0,0,0,.04)}
        .g2{display:grid;grid-template-columns:1fr 1fr;gap:4px}
        .g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:4px}
        .g4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:4px}
        .pb{padding:6px 4px;border-radius:8px;border:none;background:rgba(0,0,0,.03);color:#3a3a3c;font-size:10px;font-weight:600;cursor:pointer;text-align:center;transition:all .15s;font-family:inherit}
        body.dark .pb{background:rgba(255,255,255,.06);color:var(--text2)}
        .pb:hover{opacity:.8}.pb.on{background:var(--accent);color:white}

        /* Tabs */
        .tab-bar{display:flex;border-bottom:1px solid var(--border);flex-shrink:0}
        .tab{flex:1;padding:10px;text-align:center;font-size:11px;font-weight:600;color:var(--text2);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;font-family:inherit;transition:all .15s}
        .tab:hover{color:var(--text)}.tab.on{color:var(--accent);border-bottom-color:var(--accent)}
        .tab-body{flex:1;overflow-y:auto}
        .tc{display:none}.tc.show{display:block}

        /* Canvas */
        .cv-wrap{flex:1;position:relative;background:var(--scene-bg)}
        #c3d{width:100%;height:100%;display:block}
        .legend-bar{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);background:var(--card);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:10px;padding:7px 14px;display:flex;align-items:center;gap:10px;z-index:10;box-shadow:0 2px 12px rgba(0,0,0,.06)}
        .legend-bar .lt{font-size:10px;color:var(--text2);font-weight:600;white-space:nowrap}
        .legend-bar .ll{display:flex;justify-content:space-between;width:160px;font-size:8px;color:var(--text3);font-weight:500}

        /* Stats */
        .sg{display:grid;grid-template-columns:1fr 1fr;gap:5px}
        .st{background:var(--card);border-radius:10px;padding:10px;border:1px solid var(--border)}
        .st .v{font-size:18px;font-weight:700;font-variant-numeric:tabular-nums;letter-spacing:-.5px}
        .st .l{font-size:8px;color:var(--text3);margin-top:1px;text-transform:uppercase;letter-spacing:.3px;font-weight:600}

        /* Badge */
        .badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600}
        .badge.green{background:rgba(52,199,89,.12);color:#248a3d}
        .badge.red{background:rgba(255,59,48,.12);color:#ff3b30}
        .badge.orange{background:rgba(255,159,10,.12);color:#c93400}
        .badge.blue{background:var(--accent-dim);color:var(--accent)}
        .badge.purple{background:rgba(175,82,222,.12);color:#8944ab}
        .badge.gray{background:rgba(0,0,0,.04);color:var(--text2)}
        body.dark .badge.green{background:rgba(48,209,88,.15);color:#30d158}
        body.dark .badge.gray{background:rgba(255,255,255,.06)}

        /* Asymmetry bar */
        .asym-bar{display:flex;height:20px;border-radius:6px;overflow:hidden;background:rgba(0,0,0,.03)}
        body.dark .asym-bar{background:rgba(255,255,255,.04)}
        .asym-l{background:var(--accent);transition:width .3s}
        .asym-r{background:var(--orange);transition:width .3s}

        /* Waveform */
        .wave-row{display:flex;align-items:center;gap:10px;padding:8px;background:var(--card);border-radius:10px;border:1px solid var(--border);margin-bottom:4px}
        .wave-info{min-width:56px;text-align:center}.wave-val{font-size:18px;font-weight:700;font-variant-numeric:tabular-nums}.wave-unit{font-size:8px;color:var(--text3);font-weight:600;text-transform:uppercase}
        .wave-cv{flex:1;height:36px;border-radius:6px}

        /* Confidence bar */
        .conf-row{display:flex;align-items:center;gap:8px;margin-bottom:5px}
        .conf-label{width:50px;font-size:10px;font-weight:600;color:var(--text2)}
        .conf-track{flex:1;height:6px;background:rgba(0,0,0,.04);border-radius:3px;overflow:hidden}
        body.dark .conf-track{background:rgba(255,255,255,.06)}
        .conf-fill{height:100%;border-radius:3px;transition:width .5s}

        /* ACT level buttons */
        .lv-row{display:flex;align-items:center;gap:6px;margin-bottom:5px}
        .lv-name{width:70px;font-size:10px;font-weight:500;color:var(--text2)}
        .lv-btn{width:30px;height:24px;border:none;border-radius:6px;font-size:9px;font-weight:700;cursor:pointer;background:rgba(0,0,0,.03);color:var(--text2);font-family:inherit;transition:all .15s}
        body.dark .lv-btn{background:rgba(255,255,255,.06)}
        .lv-btn:hover{opacity:.8}
        .lv-btn.heat{background:rgba(255,59,48,.15);color:#ff3b30}
        .lv-btn.cool{background:rgba(0,122,255,.15);color:var(--accent)}

        /* Pneumatic */
        .pneu-row{display:flex;align-items:center;gap:6px;margin-bottom:5px}
        .pneu-name{width:65px;font-size:9px;font-weight:500;color:var(--text2)}
        .pneu-bar{flex:1;height:8px;background:rgba(0,0,0,.04);border-radius:4px;overflow:hidden;cursor:pointer;position:relative}
        body.dark .pneu-bar{background:rgba(255,255,255,.06)}
        .pneu-fill{height:100%;background:var(--purple);border-radius:4px;transition:width .2s}
        .pneu-val{width:28px;font-size:9px;font-weight:600;text-align:right;font-variant-numeric:tabular-nums;color:var(--text2)}

        /* Safety lock */
        .safety{display:flex;align-items:center;gap:6px;padding:8px 10px;border-radius:8px;font-size:11px;font-weight:500}
        .safety.locked{background:rgba(255,59,48,.08);color:#ff3b30}
        .safety.unlocked{background:rgba(52,199,89,.08);color:#248a3d}

        /* Massage */
        .massage-btn{position:relative;overflow:hidden}
        .massage-btn.on::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.3),transparent);animation:shimmer 1.5s infinite}
        @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}

        /* Heatmap */
        #miniHeatmap{width:100%;border-radius:10px;background:var(--bg);border:1px solid var(--border)}

        /* Profile */
        .profile-item{display:flex;align-items:center;justify-content:space-between;padding:7px 10px;border-radius:8px;background:var(--card);border:1px solid var(--border);margin-bottom:3px}
        .profile-item .pname{font-size:11px;font-weight:600}
        .profile-item .ptime{font-size:9px;color:var(--text3)}

        /* Alert */
        .al{display:flex;align-items:flex-start;gap:6px;padding:7px 10px;border-radius:8px;margin-bottom:3px;background:var(--card);font-size:10px;border:1px solid var(--border)}
        .al.warn{border-left:3px solid #ff9f0a}.al.error{border-left:3px solid #ff3b30}.al.info{border-left:3px solid var(--accent)}
        .al-time{color:var(--text3);font-size:9px;white-space:nowrap;font-weight:500}
        .al-msg{color:var(--text2);line-height:1.4}

        .footer{padding:10px 14px;text-align:center;font-size:9px;color:var(--text3);border-top:1px solid var(--border)}
        .loading{position:fixed;inset:0;background:rgba(255,255,255,.9);backdrop-filter:blur(20px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:300;transition:opacity .5s}
        body.dark .loading{background:rgba(12,12,16,.95)}
        .loading.done{opacity:0;pointer-events:none}
        .spinner{width:36px;height:36px;border:2.5px solid rgba(0,0,0,.08);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        .loading-msg{margin-top:14px;font-size:13px;color:var(--text2);font-weight:500}
        .toast{position:fixed;bottom:20px;right:20px;background:var(--card);backdrop-filter:blur(16px);border:1px solid var(--border);border-radius:10px;padding:10px 18px;font-size:12px;color:var(--text);font-weight:500;z-index:100;opacity:0;transform:translateY(8px);transition:all .25s;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,.08)}
        .toast.show{opacity:1;transform:translateY(0)}
    </style>
</head>
<body>
<div class="app">
    <div class="hdr">
        <div class="hdr-l">
            <img src="keti.png" alt="KETI"><div class="hdr-div"></div>
            <h1>4-Seat Smart Monitor</h1><span class="tag">V2</span>
        </div>
        <div class="hdr-c">
            <div class="pill"><div class="pill-dot"></div>Systems OK</div>
            <div class="pill"><div class="pill-dot"></div><span id="seatCount">4</span> Active</div>
        </div>
        <div class="hdr-r">
            <span class="clock" id="clock">00:00:00</span>
            <button class="btn" onclick="toggleDark()" title="Dark Mode"><i class="fas fa-moon"></i></button>
            <button class="btn" onclick="exportJSON()"><i class="fas fa-download"></i> JSON</button>
            <button class="btn" onclick="exportCSV()"><i class="fas fa-file-csv"></i> CSV</button>
            <button class="btn" onclick="captureScreenshot()"><i class="fas fa-camera"></i></button>
        </div>
    </div>

    <div class="content">
        <!-- LEFT PANEL -->
        <div class="panel lp">
            <div class="sec">
                <div class="sec-t"><i class="fas fa-car"></i> Vehicle Layout</div>
                <div class="car-tv">
                    <svg viewBox="0 0 200 150" fill="none"><rect x="28" y="16" width="144" height="118" rx="26" stroke="var(--border)" stroke-width="1.5"/><path d="M90 10 L100 3 L110 10" stroke="var(--text3)" stroke-width="1.2" fill="none" stroke-linecap="round"/><circle cx="68" cy="44" r="8" stroke="var(--text3)" stroke-width="1" fill="none" opacity=".4"/></svg>
                    <div class="car-fl">FRONT ▲</div>
                    <div class="cdot occ sel" id="dot-0" style="top:26px;left:44px" onclick="selectSeat(0)">FL</div>
                    <div class="cdot occ" id="dot-1" style="top:26px;right:32px" onclick="selectSeat(1)">FR</div>
                    <div class="cdot occ" id="dot-2" style="bottom:16px;left:44px" onclick="selectSeat(2)">RL</div>
                    <div class="cdot occ" id="dot-3" style="bottom:16px;right:32px" onclick="selectSeat(3)">RR</div>
                </div>
            </div>
            <div class="sec">
                <div class="sec-t"><i class="fas fa-chair"></i> Seats</div>
                <div id="seatCards"></div>
            </div>
            <div class="sec">
                <div class="sec-t"><i class="fas fa-road"></i> Drive Mode — <span style="color:var(--accent)" id="dmLabel">Comfort</span></div>
                <div class="g4">
                    <button class="pb on" onclick="setDriveMode('comfort',this)">Comfort</button>
                    <button class="pb" onclick="setDriveMode('sport',this)">Sport</button>
                    <button class="pb" onclick="setDriveMode('eco',this)">Eco</button>
                    <button class="pb" onclick="setDriveMode('sport+',this)">Sport+</button>
                </div>
            </div>
            <div class="sec">
                <div class="sec-t"><i class="fas fa-play"></i> Simulation</div>
                <div class="ctrl"><div class="ctrl-h"><span>Speed</span><span class="ctrl-v" id="speedVal">60 km/h</span></div><input type="range" min="0" max="200" value="60" oninput="vehicleSpeed=+this.value;document.getElementById('speedVal').textContent=this.value+' km/h'"></div>
                <div class="ctrl"><div class="sec-t" style="margin-bottom:4px">Road</div><div class="g4"><button class="pb" onclick="setRoad('smooth',this)">Smooth</button><button class="pb on" onclick="setRoad('normal',this)">Normal</button><button class="pb" onclick="setRoad('rough',this)">Rough</button><button class="pb" onclick="setRoad('cobble',this)">Cobble</button></div></div>
                <div class="ctrl"><div class="sec-t" style="margin-bottom:4px">Occupancy</div><div class="g4"><button class="pb on" onclick="setOcc('all',this)">All</button><button class="pb" onclick="setOcc('front',this)">Front</button><button class="pb" onclick="setOcc('driver',this)">Driver</button><button class="pb" onclick="setOcc('empty',this)">Empty</button></div></div>
            </div>
            <div class="sec">
                <div class="sec-t"><i class="fas fa-video"></i> Camera</div>
                <div class="g4">
                    <button class="pb" onclick="camView('top')">Top</button>
                    <button class="pb" onclick="camView('front')">Front</button>
                    <button class="pb" onclick="camView('side')">Side</button>
                    <button class="pb on" onclick="camView('default')">3/4</button>
                </div>
            </div>
            <div class="footer">KETI — Korea Electronics Technology Institute</div>
        </div>

        <!-- 3D CANVAS -->
        <div class="cv-wrap">
            <div id="c3d"></div>
            <div class="legend-bar">
                <span class="lt">Pressure (kPa)</span>
                <div><canvas id="legendCv" width="160" height="10" style="border-radius:5px;display:block"></canvas>
                <div class="ll"><span>0</span><span>25</span><span>50</span><span>75</span><span>100</span></div></div>
            </div>
        </div>

        <!-- RIGHT PANEL (Tabbed) -->
        <div class="panel rp">
            <div class="tab-bar">
                <button class="tab on" onclick="switchTab('mon',this)"><i class="fas fa-chart-line"></i> MON</button>
                <button class="tab" onclick="switchTab('act',this)"><i class="fas fa-sliders-h"></i> ACT</button>
                <button class="tab" onclick="switchTab('app',this)"><i class="fas fa-mobile-alt"></i> APP</button>
            </div>
            <div class="tab-body">

                <!-- ═══ MON TAB ═══ -->
                <div class="tc show" id="tab-mon">
                    <div class="sec">
                        <div class="sec-t"><i class="fas fa-user-check"></i> <span id="monSeatName">Driver (FL)</span></div>
                        <div style="display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap">
                            <span class="badge green" id="bOcc"><i class="fas fa-check-circle"></i> Occupied</span>
                            <span class="badge blue" id="bClass"><i class="fas fa-user"></i> Adult</span>
                        </div>
                        <div class="sg">
                            <div class="st"><div class="v" id="rWeight">75</div><div class="l">Load (kg)</div></div>
                            <div class="st"><div class="v" style="color:var(--accent)" id="rPosture">85</div><div class="l">Posture Score</div></div>
                            <div class="st"><div class="v" id="rAvg">0</div><div class="l">Avg Press</div></div>
                            <div class="st"><div class="v" style="color:var(--orange)" id="rPeak">0</div><div class="l">Peak kPa</div></div>
                        </div>
                    </div>
                    <div class="sec">
                        <div class="sec-t"><i class="fas fa-balance-scale"></i> Asymmetry (L/R)</div>
                        <div style="display:flex;justify-content:space-between;font-size:10px;font-weight:600;margin-bottom:3px"><span id="asymL">L 50%</span><span id="asymR">R 50%</span></div>
                        <div class="asym-bar"><div class="asym-l" id="asymBarL" style="width:50%"></div><div class="asym-r" id="asymBarR" style="width:50%"></div></div>
                        <div style="text-align:center;margin-top:4px"><span class="badge green" id="asymBadge">Balanced</span></div>
                    </div>
                    <div class="sec">
                        <div class="sec-t"><i class="fas fa-heartbeat"></i> Biosignals</div>
                        <div class="wave-row">
                            <div class="wave-info"><div class="wave-val" id="hrVal" style="color:#ff3b30">72</div><div class="wave-unit">BPM</div></div>
                            <canvas class="wave-cv" id="hrCv" width="200" height="36"></canvas>
                        </div>
                        <div class="wave-row">
                            <div class="wave-info"><div class="wave-val" id="rrVal" style="color:var(--accent)">16</div><div class="wave-unit">RPM</div></div>
                            <canvas class="wave-cv" id="rrCv" width="200" height="36"></canvas>
                        </div>
                    </div>
                    <div class="sec">
                        <div class="sec-t"><i class="fas fa-brain"></i> State Inference</div>
                        <div class="conf-row"><span class="conf-label">Drowsy</span><div class="conf-track"><div class="conf-fill" id="cfDrowsy" style="width:8%;background:#ff9f0a"></div></div><span style="font-size:10px;font-weight:600;width:30px;text-align:right;color:var(--text2)" id="cfDrowsyV">8%</span></div>
                        <div class="conf-row"><span class="conf-label">Fatigue</span><div class="conf-track"><div class="conf-fill" id="cfFatigue" style="width:15%;background:var(--orange)"></div></div><span style="font-size:10px;font-weight:600;width:30px;text-align:right;color:var(--text2)" id="cfFatigueV">15%</span></div>
                        <div class="conf-row"><span class="conf-label">Stress</span><div class="conf-track"><div class="conf-fill" id="cfStress" style="width:22%;background:var(--red)"></div></div><span style="font-size:10px;font-weight:600;width:30px;text-align:right;color:var(--text2)" id="cfStressV">22%</span></div>
                    </div>
                    <div class="sec">
                        <div class="sec-t"><i class="fas fa-th"></i> Pressure Map</div>
                        <canvas id="miniHeatmap" width="160" height="160"></canvas>
                    </div>
                </div>

                <!-- ═══ ACT TAB ═══ -->
                <div class="tc" id="tab-act">
                    <div class="sec">
                        <div class="sec-t"><i class="fas fa-fire"></i> Heating — <span id="actSeatLabel">FL</span></div>
                        <div id="heatRows"></div>
                    </div>
                    <div class="sec">
                        <div class="sec-t"><i class="fas fa-wind"></i> Ventilation</div>
                        <div id="ventRows"></div>
                    </div>
                    <div class="sec">
                        <div class="sec-t"><i class="fas fa-compress-arrows-alt"></i> Pneumatic Channels</div>
                        <div id="pneuRows"></div>
                    </div>
                    <div class="sec">
                        <div class="sec-t"><i class="fas fa-hand-sparkles"></i> Massage</div>
                        <div class="g4">
                            <button class="pb on" onclick="setMassage('off',this)">Off</button>
                            <button class="pb massage-btn" onclick="setMassage('wave',this)">Wave</button>
                            <button class="pb massage-btn" onclick="setMassage('pulse',this)">Pulse</button>
                            <button class="pb massage-btn" onclick="setMassage('stretch',this)">Stretch</button>
                        </div>
                    </div>
                    <div class="sec">
                        <div class="sec-t"><i class="fas fa-arrows-alt"></i> Position</div>
                        <div class="ctrl"><div class="ctrl-h"><span>Recline</span><span class="ctrl-v" id="recVal">0°</span></div><input type="range" min="0" max="40" value="0" id="recSl" oninput="setPose('recline',this.value)"></div>
                        <div class="ctrl"><div class="ctrl-h"><span>Headrest</span><span class="ctrl-v" id="hrSlVal">0</span></div><input type="range" min="0" max="100" value="0" id="hrSl" oninput="setPose('headrest',this.value)"></div>
                        <div class="ctrl"><div class="ctrl-h"><span>Fore / Aft</span><span class="ctrl-v" id="slideVal">0</span></div><input type="range" min="-100" max="100" value="0" id="slideSl" oninput="setPose('slide',this.value)"></div>
                        <div class="ctrl"><div class="ctrl-h"><span>Height</span><span class="ctrl-v" id="heightVal">0</span></div><input type="range" min="0" max="100" value="0" id="heightSl" oninput="setPose('height',this.value)"></div>
                        <div class="sec-t" style="margin-bottom:4px">Presets</div>
                        <div class="g4">
                            <button class="pb on" onclick="applyPreset('drive',this)">Drive</button>
                            <button class="pb" onclick="applyPreset('sport',this)">Sport</button>
                            <button class="pb" onclick="applyPreset('relax',this)">Relax</button>
                            <button class="pb" onclick="applyPreset('entry',this)">Entry</button>
                        </div>
                    </div>
                    <div class="sec">
                        <div id="safetyBar" class="safety unlocked"><i class="fas fa-lock-open"></i> Position changes allowed</div>
                    </div>
                </div>

                <!-- ═══ APP TAB ═══ -->
                <div class="tc" id="tab-app">
                    <div class="sec">
                        <div class="sec-t"><i class="fas fa-chart-area"></i> History (60s)</div>
                        <canvas id="histChart" height="140"></canvas>
                    </div>
                    <div class="sec">
                        <div class="sec-t"><i class="fas fa-list"></i> All Seats</div>
                        <div id="summaryList"></div>
                    </div>
                    <div class="sec">
                        <div class="sec-t"><i class="fas fa-save"></i> Profiles</div>
                        <div style="display:flex;gap:4px;margin-bottom:8px"><input id="profName" placeholder="Profile name..." style="flex:1;padding:6px 10px;border:1px solid var(--border);border-radius:8px;font-size:11px;background:var(--card);color:var(--text);font-family:inherit"><button class="btn btn-accent" onclick="saveProfile()" style="font-size:10px"><i class="fas fa-plus"></i></button></div>
                        <div id="profList"></div>
                    </div>
                    <div class="sec">
                        <div class="sec-t"><i class="fas fa-bell"></i> Alerts <span style="color:var(--text3);font-weight:400" id="alertCnt">(0)</span></div>
                        <div id="alertList"><div style="font-size:11px;color:var(--text3);text-align:center;padding:16px">No alerts</div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="loading" id="loader"><div class="spinner"></div><div class="loading-msg" id="loaderMsg">Loading 3D Models...</div></div>
<div class="toast" id="toast"></div>

<script>
// ════════════════════════════════════════════════
//  CONFIG
// ════════════════════════════════════════════════
const SEAT_CFG=[
    {id:0,name:'Driver',label:'FL',pos:[-0.45,0,-0.55],weight:75,occupied:true},
    {id:1,name:'Passenger',label:'FR',pos:[0.45,0,-0.55],weight:65,occupied:true},
    {id:2,name:'Rear Left',label:'RL',pos:[-0.45,0,0.55],weight:55,occupied:true},
    {id:3,name:'Rear Right',label:'RR',pos:[0.45,0,0.55],weight:80,occupied:true},
];
const COLORS=['#007aff','#34c759','#ff9f0a','#af52de'];
const PRESETS={drive:{recline:8,headrest:30,slide:0,height:20},sport:{recline:3,headrest:50,slide:30,height:0},relax:{recline:35,headrest:60,slide:-40,height:40},entry:{recline:0,headrest:0,slide:-80,height:0}};
const ROADS={smooth:{r:.15},normal:{r:1},rough:{r:2.8},cobble:{r:5}};
const PNEU_NAMES=['Front-L','Front-R','Rear-L','Rear-R','Lumbar','Bolster-L','Bolster-R'];

const seats=SEAT_CFG.map(cfg=>({
    ...cfg,
    classification:'adult', // adult|child|crs|object
    temperature:[{name:'Cushion L',temp:22,target:28},{name:'Cushion R',temp:22,target:28},{name:'Back L',temp:22,target:30},{name:'Back R',temp:22,target:30}],
    heating:[0,0,0,0], ventilation:[0,0,0,0], // 0-3 levels per zone
    pneumatic:[50,50,50,50,60,40,40], // 7 channels 0-100
    massage:'off', // off|wave|pulse|stretch
    pressureGrid:new Float32Array(256),avgPressure:0,peakPressure:0,
    postureScore:85,asymmetry:0, // -1 to 1 (neg=left heavy)
    hr:72,rr:16, // heart rate, respiration rate
    drowsy:8,fatigue:15,stress:22, // confidence %
    model:null,highlight:null,bones:{},boneRest:{},
    pose:{recline:0,headrest:0,slide:0,height:0},poseTarget:null,
    heatmapCushion:null,heatmapBack:null,
}));

let selected=0,vehicleSpeed=60,roadType='normal',driveMode='comfort';
let simRunning=true;
const alerts=[];
const historyData={labels:[],pressure:[],temp:[],hr:[],posture:[]};
let histChart=null;

// ════════════════════════════════════════════════
//  THREE.JS SCENE
// ════════════════════════════════════════════════
let scene,camera,renderer,controls;
const clock=new THREE.Clock();

function initScene(){
    const el=document.getElementById('c3d');
    scene=new THREE.Scene();
    scene.background=new THREE.Color(0xf0f0f2);

    camera=new THREE.PerspectiveCamera(42,el.clientWidth/el.clientHeight,.01,100);
    camera.position.set(1.8,2.8,3.0);

    renderer=new THREE.WebGLRenderer({antialias:true,preserveDrawingBuffer:true});
    renderer.setPixelRatio(Math.min(devicePixelRatio,2));
    renderer.setSize(el.clientWidth,el.clientHeight);
    renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFSoftShadowMap;
    renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.8;
    el.appendChild(renderer.domElement);

    controls=new THREE.OrbitControls(camera,renderer.domElement);
    controls.enableDamping=true;controls.dampingFactor=.08;
    controls.target.set(0,.25,0);controls.minDistance=.5;controls.maxDistance=10;controls.maxPolarAngle=Math.PI*.85;

    scene.add(new THREE.AmbientLight(0xffffff,1.2));
    const key=new THREE.DirectionalLight(0xffffff,2.2);
    key.position.set(2,8,3);key.castShadow=true;
    key.shadow.mapSize.set(2048,2048);key.shadow.camera.near=.1;key.shadow.camera.far=20;
    key.shadow.camera.left=-3;key.shadow.camera.right=3;key.shadow.camera.top=3;key.shadow.camera.bottom=-3;key.shadow.bias=-.001;
    scene.add(key);
    scene.add(new THREE.DirectionalLight(0xc8d0ff,.8).translateX(-4).translateY(5).translateZ(-2));
    scene.add(new THREE.DirectionalLight(0xffffff,.5).translateZ(-6).translateY(2));
    scene.add(new THREE.DirectionalLight(0xffffff,.6).translateY(10));
    scene.add(new THREE.HemisphereLight(0xffffff,0xe8e8ea,.6));

    const grid=new THREE.GridHelper(5,24,0xccccce,0xdddddf);grid.material.opacity=.4;grid.material.transparent=true;scene.add(grid);
    const floor=new THREE.Mesh(new THREE.PlaneGeometry(10,10),new THREE.MeshStandardMaterial({color:0xe8e8ea,roughness:.85,metalness:.05}));
    floor.rotation.x=-Math.PI/2;floor.position.y=-.005;floor.receiveShadow=true;scene.add(floor);
    buildCarBody();loadSeats();

    window.addEventListener('resize',()=>{camera.aspect=el.clientWidth/el.clientHeight;camera.updateProjectionMatrix();renderer.setSize(el.clientWidth,el.clientHeight)});
    const rc=new THREE.Raycaster(),m2=new THREE.Vector2();
    renderer.domElement.addEventListener('click',e=>{const r=renderer.domElement.getBoundingClientRect();m2.x=((e.clientX-r.left)/r.width)*2-1;m2.y=-((e.clientY-r.top)/r.height)*2+1;rc.setFromCamera(m2,camera);for(let i=0;i<seats.length;i++){if(seats[i].model&&rc.intersectObject(seats[i].model,true).length>0){selectSeat(i);break;}}});
}

function buildCarBody(){
    const s=new THREE.Shape(),W=.8,FL=-.95,RL=.9,R=.2;
    s.moveTo(-W+R,FL);s.lineTo(W-R,FL);s.quadraticCurveTo(W,FL,W,FL+R);s.lineTo(W,RL-R);s.quadraticCurveTo(W,RL,W-R,RL);s.lineTo(-W+R,RL);s.quadraticCurveTo(-W,RL,-W,RL-R);s.lineTo(-W,FL+R);s.quadraticCurveTo(-W,FL,-W+R,FL);
    const m=new THREE.Mesh(new THREE.ShapeGeometry(s),new THREE.MeshStandardMaterial({color:0xc0c0c2,transparent:true,opacity:.2,roughness:.8,side:THREE.DoubleSide}));
    m.rotation.x=-Math.PI/2;m.position.y=.002;m.receiveShadow=true;scene.add(m);
    const as=new THREE.Shape();as.moveTo(-.12,-1.02);as.lineTo(0,-1.15);as.lineTo(.12,-1.02);
    const am=new THREE.Mesh(new THREE.ShapeGeometry(as),new THREE.MeshBasicMaterial({color:0x007aff,transparent:true,opacity:.4,side:THREE.DoubleSide}));
    am.rotation.x=-Math.PI/2;am.position.y=.005;scene.add(am);
    const cv=document.createElement('canvas');cv.width=128;cv.height=32;const cx=cv.getContext('2d');cx.fillStyle='rgba(0,122,255,0.6)';cx.font='bold 16px Inter';cx.textAlign='center';cx.fillText('FRONT',64,20);
    const lm=new THREE.Mesh(new THREE.PlaneGeometry(.4,.1),new THREE.MeshBasicMaterial({map:new THREE.CanvasTexture(cv),transparent:true,side:THREE.DoubleSide}));
    lm.rotation.x=-Math.PI/2;lm.position.set(0,.008,-1.08);scene.add(lm);
}

function loadSeats(){
    const loader=new THREE.GLTFLoader();let cnt=0;
    seats.forEach((seat,i)=>{
        loader.load('models/car-seat-rigged.glb',gltf=>{
            const model=gltf.scene,box=new THREE.Box3().setFromObject(model),size=box.getSize(new THREE.Vector3()),center=box.getCenter(new THREE.Vector3());
            const scale=.8/Math.max(size.x,size.y,size.z);
            model.scale.setScalar(scale);
            model.position.set(seat.pos[0]-center.x*scale,seat.pos[1]-box.min.y*scale,seat.pos[2]-center.z*scale);
            const fp=new Set(['01 Base','02 Base rim','03 Base controls']),ap=new Set(['05 Bottom sides','07 Seat back sides']);
            model.traverse(c=>{
                if(c.isMesh){c.castShadow=true;c.receiveShadow=true;const n=c.name||(c.parent&&c.parent.name)||'';let col=0x2a2a2e,ro=.55,me=.04;if(fp.has(n)){col=0x18181c;ro=.25;me=.65}else if(ap.has(n)){col=0x353538;ro=.48;me=.05}if(c.material){c.material.color.setHex(col);c.material.roughness=ro;c.material.metalness=me;c.material.needsUpdate=true}if(c.isSkinnedMesh&&c.skeleton)c.skeleton.bones.forEach(b=>{if(!seat.bones[b.name])seat.bones[b.name]=b})}
                if(c.isBone&&!seat.bones[c.name])seat.bones[c.name]=c;
            });
            seat.boneRest={};Object.entries(seat.bones).forEach(([n,b])=>{seat.boneRest[n]={px:b.position.x,py:b.position.y,pz:b.position.z,rx:b.rotation.x,ry:b.rotation.y,rz:b.rotation.z}});
            scene.add(model);seat.model=model;
            const ring=new THREE.Mesh(new THREE.RingGeometry(.28,.31,32),new THREE.MeshBasicMaterial({color:new THREE.Color(COLORS[i]),transparent:true,opacity:0,side:THREE.DoubleSide}));
            ring.rotation.x=-Math.PI/2;ring.position.set(seat.pos[0],.008,seat.pos[2]);scene.add(ring);seat.highlight=ring;
            // Heatmap overlays on model
            seat.heatmapCushion=makeOverlay(model,.22,.18,{rx:-Math.PI/2,y:1.15,z:-.45});
            seat.heatmapBack=makeOverlay(model,.18,.26,{rx:-1.1,y:2.3,z:-1.35});
            cnt++;document.getElementById('loaderMsg').textContent=`Loading seats... ${cnt}/4`;
            if(cnt===4){updateHighlights();document.getElementById('loader').classList.add('done')}
        },undefined,err=>{console.error(err);document.getElementById('loaderMsg').textContent='Load failed'});
    });
}

function makeOverlay(parent,w,h,p){
    const cv=document.createElement('canvas');cv.width=64;cv.height=64;
    const tex=new THREE.CanvasTexture(cv);tex.minFilter=THREE.LinearFilter;
    const mesh=new THREE.Mesh(new THREE.PlaneGeometry(w,h),new THREE.MeshBasicMaterial({map:tex,transparent:true,opacity:.65,side:THREE.DoubleSide,depthWrite:false}));
    mesh.rotation.x=p.rx||0;mesh.position.set(p.x||0,p.y||0,p.z||0);parent.add(mesh);
    return{canvas:cv,tex,mesh};
}

function updateOverlay(seat,type){
    const ov=type==='cushion'?seat.heatmapCushion:seat.heatmapBack;if(!ov)return;
    const ctx=ov.canvas.getContext('2d');ctx.clearRect(0,0,64,64);
    if(!seat.occupied){ov.tex.needsUpdate=true;return}
    for(let y=0;y<16;y++)for(let x=0;x<16;x++){const v=seat.pressureGrid[y*16+x];if(v>.02){ctx.fillStyle=pColorRGBA(v);ctx.fillRect(x*4,y*4,4,4)}}
    ov.tex.needsUpdate=true;
}

function updateHighlights(){
    seats.forEach((s,i)=>{const sel=i===selected;if(s.highlight)s.highlight.material.opacity=sel?.7:.12;if(s.model)s.model.traverse(c=>{if(c.isMesh&&c.material&&c.material.isMeshStandardMaterial){c.material.emissive.setHex(sel?parseInt(COLORS[i].slice(1),16):0);c.material.emissiveIntensity=sel?.18:0}})});
}

// ════════════════════════════════════════════════
//  SIMULATION
// ════════════════════════════════════════════════
function g2d(x,y,sx,sy){return Math.exp(-(x*x)/(2*sx*sx)-(y*y)/(2*sy*sy))}

function simPressure(s,t){
    if(!s.occupied){s.pressureGrid.fill(0);s.avgPressure=0;s.peakPressure=0;return}
    const wF=s.weight/80,off=s.id*1.7;let sum=0,mx=0,cnt=0,sumL=0,sumR=0;
    // Massage overlay
    const mPhase=t*2+s.id;
    for(let y=0;y<16;y++)for(let x=0;x<16;x++){
        const nx=(x/15)*2-1,ny=(y/15)*2-1;
        let v=(g2d(nx+.35,ny-.1,.28,.32)+g2d(nx-.35,ny-.1,.28,.32)+g2d(nx+.3,ny+.25,.22,.4)*.35+g2d(nx-.3,ny+.25,.22,.4)*.35)*wF;
        v+=Math.sin((t+off)*.35)*.015+(Math.random()-.5)*.008;
        if(s.massage==='wave')v+=Math.sin(ny*3-mPhase*2)*.12*wF;
        else if(s.massage==='pulse')v+=Math.sin(mPhase*5)*Math.max(0,g2d(nx,ny,.4,.4))*.15*wF;
        else if(s.massage==='stretch')v+=(nx>0?1:-1)*Math.sin(mPhase*3)*.08*wF;
        v=Math.max(0,Math.min(1,v));
        s.pressureGrid[y*16+x]=v;
        if(v>.01){sum+=v;cnt++;mx=Math.max(mx,v);if(x<8)sumL+=v;else sumR+=v}
    }
    s.avgPressure=cnt>0?(sum/cnt*100):0;s.peakPressure=mx*100;
    const total=sumL+sumR||1;s.asymmetry=(sumL-sumR)/total;
    // Posture score: 100 = perfectly symmetric, low peak
    s.postureScore=Math.round(Math.max(0,Math.min(100,100-Math.abs(s.asymmetry)*80-Math.max(0,s.peakPressure-70)*.3)));
}

function simTemp(s,dt){
    s.temperature.forEach((z,i)=>{
        const hLv=s.heating[i],vLv=s.ventilation[i];
        if(hLv>0)z.temp+=(22+hLv*4-z.temp)*dt*.06;
        else if(vLv>0)z.temp+=(22-vLv*2-z.temp)*dt*.05;
        else z.temp+=(22-z.temp)*dt*.005;
        z.temp=Math.max(5,Math.min(50,z.temp+(Math.random()-.5)*.05));
    });
}

function simBio(s,t,dt){
    if(!s.occupied){s.hr=0;s.rr=0;s.drowsy=0;s.fatigue=0;s.stress=0;return}
    const off=s.id*3.7;
    s.hr=Math.round(68+Math.sin((t+off)*.08)*6+vehicleSpeed*.03+(Math.random()-.5)*2);
    s.rr=Math.round(14+Math.sin((t+off)*.05)*2+(Math.random()-.5)*.5);
    // State inference
    const elapsed=t/60; // minutes
    s.drowsy=Math.min(95,Math.round(5+elapsed*3+Math.sin(t*.02)*5));
    s.fatigue=Math.min(90,Math.round(10+elapsed*2+vehicleSpeed*.02));
    s.stress=Math.min(85,Math.round(8+vehicleSpeed*.12+ROADS[roadType].r*3));
    // Classification
    if(s.weight>40)s.classification='adult';
    else if(s.weight>15)s.classification='child';
    else if(s.weight>5)s.classification='crs';
    else s.classification='object';
}

// ════════════════════════════════════════════════
//  COLORS
// ════════════════════════════════════════════════
function pColorRGBA(t){t=Math.max(0,Math.min(1,t));let r,g,b;if(t<.25){const f=t/.25;r=0;g=Math.round(f*255);b=255}else if(t<.5){const f=(t-.25)/.25;r=0;g=255;b=Math.round(255*(1-f))}else if(t<.75){const f=(t-.5)/.25;r=Math.round(255*f);g=255;b=0}else{const f=(t-.75)/.25;r=255;g=Math.round(255*(1-f));b=0}return`rgba(${r},${g},${b},${.3+t*.7})`}
function tColor(t){const v=Math.max(0,Math.min(1,(t-15)/25));return v<.3?'#007aff':v<.6?'#86868b':v<.8?'#ff9f0a':'#ff3b30'}

// ════════════════════════════════════════════════
//  UI
// ════════════════════════════════════════════════
function selectSeat(i){selected=i;updateHighlights();document.querySelectorAll('.cdot').forEach((d,j)=>d.classList.toggle('sel',j===i));document.querySelectorAll('.sc').forEach((c,j)=>c.classList.toggle('sel',j===i));syncSliders();updateMON();document.getElementById('actSeatLabel').textContent=seats[i].label;document.getElementById('monSeatName').textContent=seats[i].name+' ('+seats[i].label+')';renderACT()}
function switchTab(id,btn){document.querySelectorAll('.tc').forEach(t=>t.classList.remove('show'));document.getElementById('tab-'+id).classList.add('show');document.querySelectorAll('.tab').forEach(t=>t.classList.remove('on'));btn.classList.add('on')}

function renderCards(){
    document.getElementById('seatCards').innerHTML=seats.map((s,i)=>{
        const cls=s.classification;const clsIcon=cls==='adult'?'user':cls==='child'?'child':cls==='crs'?'baby-carriage':'box';
        return`<div class="sc ${i===selected?'sel':''}" onclick="selectSeat(${i})"><div class="sc-icon" style="background:${COLORS[i]}15;color:${COLORS[i]}"><i class="fas fa-${s.occupied?clsIcon:'user-slash'}"></i></div><div class="sc-det"><div class="sc-name">${s.label} ${s.name}</div><div class="sc-sub">${s.occupied?s.weight+'kg · '+cls.charAt(0).toUpperCase()+cls.slice(1):'Empty'}</div></div></div>`
    }).join('');
}

function updateMON(){
    const s=seats[selected];
    document.getElementById('rWeight').textContent=s.occupied?s.weight:'0';
    document.getElementById('rPosture').textContent=s.postureScore;
    document.getElementById('rAvg').textContent=s.avgPressure.toFixed(1);
    document.getElementById('rPeak').textContent=s.peakPressure.toFixed(1);
    // Occupancy badge
    const bOcc=document.getElementById('bOcc');bOcc.className='badge '+(s.occupied?'green':'gray');bOcc.innerHTML='<i class="fas fa-'+(s.occupied?'check-circle':'times-circle')+'"></i> '+(s.occupied?'Occupied':'Empty');
    // Classification badge
    const cls=s.classification;const clsColors={adult:'blue',child:'orange',crs:'purple',object:'gray'};
    const bCls=document.getElementById('bClass');bCls.className='badge '+(clsColors[cls]||'gray');bCls.innerHTML='<i class="fas fa-'+(cls==='adult'?'user':cls==='child'?'child':cls==='crs'?'baby-carriage':'box')+'"></i> '+cls.charAt(0).toUpperCase()+cls.slice(1);
    // Asymmetry
    const lPct=Math.round((1+s.asymmetry)/2*100),rPct=100-lPct;
    document.getElementById('asymL').textContent='L '+lPct+'%';document.getElementById('asymR').textContent='R '+rPct+'%';
    document.getElementById('asymBarL').style.width=lPct+'%';document.getElementById('asymBarR').style.width=rPct+'%';
    const asymBadge=document.getElementById('asymBadge');const aAbs=Math.abs(s.asymmetry);
    if(aAbs<.1){asymBadge.className='badge green';asymBadge.textContent='Balanced'}
    else if(aAbs<.25){asymBadge.className='badge orange';asymBadge.textContent='Slight Offset'}
    else{asymBadge.className='badge red';asymBadge.textContent='Imbalanced'}
    // Biosignals
    document.getElementById('hrVal').textContent=s.hr||'—';
    document.getElementById('rrVal').textContent=s.rr||'—';
    // State
    ['drowsy','fatigue','stress'].forEach(k=>{const v=s[k];document.getElementById('cf'+k.charAt(0).toUpperCase()+k.slice(1)).style.width=v+'%';document.getElementById('cf'+k.charAt(0).toUpperCase()+k.slice(1)+'V').textContent=v+'%'});
    // Mini heatmap
    const mc=document.getElementById('miniHeatmap'),ctx=mc.getContext('2d');ctx.clearRect(0,0,160,160);
    for(let y=0;y<16;y++)for(let x=0;x<16;x++){const v=s.pressureGrid[y*16+x];if(v>.01){ctx.fillStyle=pColorRGBA(v);ctx.fillRect(x*10,y*10,10,10)}}
}

function renderACT(){
    const s=seats[selected];
    const zoneNames=['Cushion L','Cushion R','Back L','Back R'];
    document.getElementById('heatRows').innerHTML=zoneNames.map((n,i)=>`<div class="lv-row"><span class="lv-name">${n}</span>${[0,1,2,3].map(lv=>`<button class="lv-btn ${s.heating[i]===lv?(lv>0?'heat':''):''}" onclick="setHeat(${i},${lv})">${lv===0?'Off':lv}</button>`).join('')}</div>`).join('');
    document.getElementById('ventRows').innerHTML=zoneNames.map((n,i)=>`<div class="lv-row"><span class="lv-name">${n}</span>${[0,1,2,3].map(lv=>`<button class="lv-btn ${s.ventilation[i]===lv?(lv>0?'cool':''):''}" onclick="setVent(${i},${lv})">${lv===0?'Off':lv}</button>`).join('')}</div>`).join('');
    document.getElementById('pneuRows').innerHTML=PNEU_NAMES.map((n,i)=>`<div class="pneu-row"><span class="pneu-name">${n}</span><div class="pneu-bar" onclick="setPneu(${i},event)"><div class="pneu-fill" style="width:${s.pneumatic[i]}%"></div></div><span class="pneu-val">${s.pneumatic[i]}%</span></div>`).join('');
    // Safety
    const locked=vehicleSpeed>5;
    document.getElementById('safetyBar').className='safety '+(locked?'locked':'unlocked');
    document.getElementById('safetyBar').innerHTML='<i class="fas fa-'+(locked?'lock':'lock-open')+'"></i> '+(locked?'Position locked (speed > 5 km/h)':'Position changes allowed');
}

function updateSummary(){
    document.getElementById('summaryList').innerHTML=seats.map((s,i)=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-radius:8px;margin-bottom:3px;background:var(--card);border:1px solid ${i===selected?'rgba(0,122,255,.2)':'var(--border)'};cursor:pointer" onclick="selectSeat(${i})"><div style="display:flex;align-items:center;gap:6px"><div style="width:6px;height:6px;border-radius:50%;background:${s.occupied?'#34c759':'var(--text3)'}"></div><span style="font-size:10px;font-weight:600">${s.label}</span></div><div style="display:flex;gap:8px;font-size:9px;font-variant-numeric:tabular-nums"><span style="color:var(--text2)">${s.occupied?s.weight+'kg':'—'}</span><span style="color:${tColor(s.temperature[0].temp)}">${s.temperature[0].temp.toFixed(1)}°</span><span style="color:#ff9f0a">${s.peakPressure.toFixed(0)} kPa</span><span style="color:var(--accent)">P${s.postureScore}</span></div></div>`).join('');
}

// ════════════════════════════════════════════════
//  WAVEFORMS
// ════════════════════════════════════════════════
function drawHR(t){
    const cv=document.getElementById('hrCv'),ctx=cv.getContext('2d'),w=cv.width,h=cv.height;
    ctx.clearRect(0,0,w,h);ctx.strokeStyle='#ff3b30';ctx.lineWidth=1.5;ctx.beginPath();
    const s=seats[selected],bpm=s.hr||72,period=60/bpm;
    for(let x=0;x<w;x++){
        const phase=((t-x*.008)%period)/period;
        let y=h/2;
        if(phase>.38&&phase<.42)y=h*.15;
        else if(phase>.42&&phase<.46)y=h*.85;
        else if(phase>.46&&phase<.50)y=h*.3;
        else y+=Math.sin(phase*Math.PI*2)*.8;
        x===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    }
    ctx.stroke();
}

function drawRR(t){
    const cv=document.getElementById('rrCv'),ctx=cv.getContext('2d'),w=cv.width,h=cv.height;
    ctx.clearRect(0,0,w,h);ctx.strokeStyle='#007aff';ctx.lineWidth=1.5;ctx.beginPath();
    const s=seats[selected],rpm=s.rr||16,period=60/rpm;
    for(let x=0;x<w;x++){
        const phase=((t-x*.015)%period)/period;
        const y=h/2+Math.sin(phase*Math.PI*2)*(h*.35);
        x===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    }
    ctx.stroke();
}

// ════════════════════════════════════════════════
//  CONTROLS
// ════════════════════════════════════════════════
function setRoad(type,btn){roadType=type;btn.parentElement.querySelectorAll('.pb').forEach(b=>b.classList.remove('on'));btn.classList.add('on')}
function setOcc(mode,btn){btn.parentElement.querySelectorAll('.pb').forEach(b=>b.classList.remove('on'));btn.classList.add('on');seats[0].occupied=mode!=='empty';seats[1].occupied=mode==='all'||mode==='front';seats[2].occupied=mode==='all';seats[3].occupied=mode==='all';document.querySelectorAll('.cdot').forEach((d,i)=>{d.className='cdot '+(seats[i].occupied?'occ':'empty')+(i===selected?' sel':'')});renderCards();document.getElementById('seatCount').textContent=seats.filter(s=>s.occupied).length}
function setDriveMode(m,btn){driveMode=m;btn.parentElement.querySelectorAll('.pb').forEach(b=>b.classList.remove('on'));btn.classList.add('on');document.getElementById('dmLabel').textContent=m.charAt(0).toUpperCase()+m.slice(1);if(m==='sport'||m==='sport+'){seats.forEach(s=>{s.pneumatic[5]=80;s.pneumatic[6]=80})}else{seats.forEach(s=>{s.pneumatic[5]=40;s.pneumatic[6]=40})}renderACT()}
function setHeat(zi,lv){seats[selected].heating[zi]=lv;renderACT()}
function setVent(zi,lv){seats[selected].ventilation[zi]=lv;renderACT()}
function setPneu(ci,e){const bar=e.currentTarget,rect=bar.getBoundingClientRect();const pct=Math.round(Math.max(0,Math.min(100,(e.clientX-rect.left)/rect.width*100)));seats[selected].pneumatic[ci]=pct;renderACT()}
function setMassage(m,btn){seats[selected].massage=m;btn.parentElement.querySelectorAll('.pb').forEach(b=>{b.classList.remove('on');if(m!=='off')b.classList.remove('massage-btn')});btn.classList.add('on');if(m!=='off')btn.classList.add('massage-btn')}

// Bone pose
function setPose(axis,val){
    if(vehicleSpeed>5&&(axis==='slide'||axis==='height')){toast('Position locked while driving');return}
    const s=seats[selected];val=+val;s.pose[axis]=val;applyBone(s,axis,val);
}
function applyBone(s,axis,val){
    const rest=s.boneRest||{};
    if(axis==='recline'){document.getElementById('recVal').textContent=Math.round(val)+'°';if(s.bones.Backrest&&rest.Backrest)s.bones.Backrest.rotation.x=rest.Backrest.rx+THREE.MathUtils.degToRad(val)}
    else if(axis==='headrest'){document.getElementById('hrSlVal').textContent=Math.round(val);if(s.bones.Headrest&&rest.Headrest)s.bones.Headrest.position.y=rest.Headrest.py+(val/100)*.5}
    else if(axis==='slide'){document.getElementById('slideVal').textContent=Math.round(val);if(s.bones.Slide&&rest.Slide)s.bones.Slide.position.z=rest.Slide.pz-(val/100)*.5}
    else if(axis==='height'){document.getElementById('heightVal').textContent=Math.round(val);if(s.bones.Cushion&&rest.Cushion)s.bones.Cushion.position.y=rest.Cushion.py+(val/100)*.3}
}
function applyPreset(name,btn){btn.parentElement.querySelectorAll('.pb').forEach(b=>b.classList.remove('on'));btn.classList.add('on');seats[selected].poseTarget={...PRESETS[name]}}
function syncSliders(){const s=seats[selected];document.getElementById('recSl').value=s.pose.recline;document.getElementById('recVal').textContent=Math.round(s.pose.recline)+'°';document.getElementById('hrSl').value=s.pose.headrest;document.getElementById('hrSlVal').textContent=Math.round(s.pose.headrest);document.getElementById('slideSl').value=s.pose.slide;document.getElementById('slideVal').textContent=Math.round(s.pose.slide);document.getElementById('heightSl').value=s.pose.height;document.getElementById('heightVal').textContent=Math.round(s.pose.height)}
function animPoses(dt){seats.forEach(s=>{if(!s.poseTarget)return;let done=true;['recline','headrest','slide','height'].forEach(k=>{const d=s.poseTarget[k]-s.pose[k];if(Math.abs(d)>.5){s.pose[k]+=d*dt*4;done=false}else s.pose[k]=s.poseTarget[k];applyBone(s,k,s.pose[k])});if(done)s.poseTarget=null})}
function camView(view){let p,t;switch(view){case'top':p={x:0,y:4.5,z:.01};t={x:0,y:0,z:0};break;case'front':p={x:0,y:1.2,z:-3.5};t={x:0,y:.3,z:0};break;case'side':p={x:3.5,y:1.5,z:0};t={x:0,y:.3,z:0};break;default:p={x:1.8,y:2.8,z:3};t={x:0,y:.25,z:0}}gsap.to(camera.position,{...p,duration:.8,ease:'power2.inOut'});gsap.to(controls.target,{...t,duration:.8,ease:'power2.inOut'})}

// ════════════════════════════════════════════════
//  CHART.JS HISTORY
// ════════════════════════════════════════════════
function initChart(){
    const ctx=document.getElementById('histChart').getContext('2d');
    histChart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[
        {label:'Pressure',data:[],borderColor:'#ff9f0a',borderWidth:1.5,pointRadius:0,tension:.3},
        {label:'Posture',data:[],borderColor:'#007aff',borderWidth:1.5,pointRadius:0,tension:.3},
        {label:'HR',data:[],borderColor:'#ff3b30',borderWidth:1.5,pointRadius:0,tension:.3},
    ]},options:{responsive:true,maintainAspectRatio:false,animation:{duration:0},scales:{x:{display:false},y:{display:true,min:0,max:120,ticks:{font:{size:8},color:'#aeaeb2'},grid:{color:'rgba(0,0,0,0.04)'}}},plugins:{legend:{labels:{font:{size:9},boxWidth:12,padding:8}}}}});
}
function pushHistory(t){
    const s=seats[selected];
    const label=Math.round(t)+'s';
    historyData.labels.push(label);
    histChart.data.labels=historyData.labels.slice(-60);
    histChart.data.datasets[0].data=historyData.pressure;
    histChart.data.datasets[1].data=historyData.posture;
    histChart.data.datasets[2].data=historyData.hr;
    historyData.pressure.push(s.avgPressure);historyData.posture.push(s.postureScore);historyData.hr.push(s.hr);
    if(historyData.pressure.length>60){historyData.labels.shift();historyData.pressure.shift();historyData.posture.shift();historyData.hr.shift()}
    histChart.update();
}

// ════════════════════════════════════════════════
//  PROFILES (localStorage)
// ════════════════════════════════════════════════
function saveProfile(){
    const name=document.getElementById('profName').value.trim();if(!name){toast('Enter profile name');return}
    const s=seats[selected];
    const profiles=JSON.parse(localStorage.getItem('seatProfiles')||'[]');
    profiles.push({name,time:new Date().toLocaleString(),pose:{...s.pose},heating:[...s.heating],ventilation:[...s.ventilation],pneumatic:[...s.pneumatic]});
    localStorage.setItem('seatProfiles',JSON.stringify(profiles));
    document.getElementById('profName').value='';renderProfiles();toast('Profile "'+name+'" saved');
}
function loadProfile(idx){
    const profiles=JSON.parse(localStorage.getItem('seatProfiles')||'[]');const p=profiles[idx];if(!p)return;
    const s=seats[selected];s.heating=[...p.heating];s.ventilation=[...p.ventilation];s.pneumatic=[...p.pneumatic];s.poseTarget={...p.pose};
    renderACT();toast('Profile "'+p.name+'" loaded');
}
function deleteProfile(idx){
    const profiles=JSON.parse(localStorage.getItem('seatProfiles')||'[]');profiles.splice(idx,1);localStorage.setItem('seatProfiles',JSON.stringify(profiles));renderProfiles();toast('Profile deleted');
}
function renderProfiles(){
    const profiles=JSON.parse(localStorage.getItem('seatProfiles')||'[]');
    document.getElementById('profList').innerHTML=profiles.length===0?'<div style="font-size:10px;color:var(--text3);text-align:center;padding:12px">No saved profiles</div>':profiles.map((p,i)=>`<div class="profile-item"><div><div class="pname">${p.name}</div><div class="ptime">${p.time}</div></div><div style="display:flex;gap:4px"><button class="btn" onclick="loadProfile(${i})" style="font-size:9px;padding:3px 8px"><i class="fas fa-upload"></i></button><button class="btn" onclick="deleteProfile(${i})" style="font-size:9px;padding:3px 8px;color:#ff3b30"><i class="fas fa-trash"></i></button></div></div>`).join('');
}

// ════════════════════════════════════════════════
//  ALERTS
// ════════════════════════════════════════════════
let lastAlert=0;
function addAlert(type,msg){const now=Date.now();if(now-lastAlert<5000)return;if(alerts.length>0&&alerts[0].msg===msg)return;lastAlert=now;alerts.unshift({type,msg,time:new Date()});if(alerts.length>20)alerts.pop();document.getElementById('alertCnt').textContent='('+alerts.length+')';document.getElementById('alertList').innerHTML=alerts.slice(0,6).map(a=>`<div class="al ${a.type}"><span class="al-time">${a.time.toLocaleTimeString()}</span><span class="al-msg">${a.msg}</span></div>`).join('')}

// ════════════════════════════════════════════════
//  EXPORT
// ════════════════════════════════════════════════
function exportJSON(){
    const data={timestamp:new Date().toISOString(),system:'KETI 4-Seat v2',vehicleSpeed,roadType,driveMode,seats:seats.map(s=>({id:s.id,name:s.name,occupied:s.occupied,weight:s.weight,classification:s.classification,avgPressure:s.avgPressure,peakPressure:s.peakPressure,postureScore:s.postureScore,asymmetry:s.asymmetry,hr:s.hr,rr:s.rr,drowsy:s.drowsy,fatigue:s.fatigue,stress:s.stress,temperature:s.temperature.map(z=>({name:z.name,temp:z.temp})),heating:s.heating,ventilation:s.ventilation,pneumatic:s.pneumatic,massage:s.massage,pose:s.pose}))};
    const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='seats-v2-'+Date.now()+'.json';a.click();toast('JSON exported');
}
function exportCSV(){
    let csv='Seat,Name,Occupied,Weight,Classification,AvgPressure,PeakPressure,PostureScore,Asymmetry,HR,RR,Drowsy,Fatigue,Stress,Massage\n';
    seats.forEach(s=>{csv+=`${s.label},${s.name},${s.occupied},${s.weight},${s.classification},${s.avgPressure.toFixed(1)},${s.peakPressure.toFixed(1)},${s.postureScore},${s.asymmetry.toFixed(3)},${s.hr},${s.rr},${s.drowsy},${s.fatigue},${s.stress},${s.massage}\n`});
    const b=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='seats-v2-'+Date.now()+'.csv';a.click();toast('CSV exported');
}
function captureScreenshot(){renderer.render(scene,camera);const a=document.createElement('a');a.download='seats-v2-'+Date.now()+'.png';a.href=renderer.domElement.toDataURL('image/png');a.click();toast('Screenshot saved')}

// ════════════════════════════════════════════════
//  DARK MODE
// ════════════════════════════════════════════════
function toggleDark(){
    document.body.classList.toggle('dark');
    const isDark=document.body.classList.contains('dark');
    scene.background=new THREE.Color(isDark?0x0c0c10:0xf0f0f2);
    toast(isDark?'Dark mode':'Light mode');
}

// ════════════════════════════════════════════════
//  UTILS
// ════════════════════════════════════════════════
let toastTmr;function toast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(toastTmr);toastTmr=setTimeout(()=>t.classList.remove('show'),2500)}
function drawLegend(){const ctx=document.getElementById('legendCv').getContext('2d');for(let x=0;x<160;x++){ctx.fillStyle=pColorRGBA(x/160);ctx.fillRect(x,0,1,10)}}

// ════════════════════════════════════════════════
//  ANIMATION LOOP
// ════════════════════════════════════════════════
let lastUI=0,lastHist=0;

function animate(){
    requestAnimationFrame(animate);
    const dt=Math.min(clock.getDelta(),.1),t=clock.getElapsedTime();
    if(simRunning){seats.forEach(s=>{simPressure(s,t);simTemp(s,dt);simBio(s,t,dt)})}
    animPoses(dt);if(seats[selected].poseTarget)syncSliders();
    seats.forEach(s=>{updateOverlay(s,'cushion');updateOverlay(s,'back')});

    if(t-lastUI>.15){
        updateMON();renderCards();updateSummary();renderACT();drawHR(t);drawRR(t);
        seats.forEach(s=>{
            if(s.peakPressure>85)addAlert('warn',s.label+' peak '+s.peakPressure.toFixed(0)+' kPa');
            if(Math.abs(s.asymmetry)>.25)addAlert('warn',s.label+' posture imbalanced');
            if(s.drowsy>60)addAlert('error',s.label+' drowsiness detected ('+s.drowsy+'%)');
            s.temperature.forEach(z=>{if(z.temp>40)addAlert('error',s.label+' '+z.name+' overheat')});
        });
        lastUI=t;
    }
    if(t-lastHist>1){pushHistory(t);lastHist=t}
    controls.update();renderer.render(scene,camera);
}

// ════════════════════════════════════════════════
//  INIT
// ════════════════════════════════════════════════
initScene();drawLegend();renderCards();updateSummary();renderACT();renderProfiles();initChart();
setInterval(()=>{document.getElementById('clock').textContent=new Date().toLocaleTimeString()},1000);
animate();
</script>
</body>
</html>
