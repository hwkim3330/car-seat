<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KETI - Smart Seat Sensor Monitor | Tesla Edition</title>
    <script src="libs/three.min.js"></script>
    <script src="libs/OrbitControls.js"></script>
    <script src="libs/GLTFLoader.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600;700;800&display=swap');

        :root {
            --bg: #ffffff;
            --bg-card: #f8f8f8;
            --bg-elevated: #f2f2f2;
            --bg-hover: #eaeaea;
            --border: rgba(0,0,0,0.06);
            --text-primary: #171717;
            --text-secondary: #6e6e6e;
            --text-tertiary: #b0b0b0;
            --red: #e31937;
            --red-glow: rgba(227,25,55,0.1);
            --red-subtle: rgba(227,25,55,0.06);
            --blue: #3e6ae1;
            --green: #17b169;
            --orange: #f5a623;
            --cyan: #00b8d9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: -0.01em;
        }
        .app { display: flex; flex-direction: column; height: 100vh; }

        /* Header - Tesla minimal */
        .header {
            height: 48px;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; flex-shrink: 0; z-index: 20;
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-left img { height: 22px; opacity: 0.85; }
        .header-pipe { color: var(--text-tertiary); font-weight: 200; font-size: 20px; }
        .header-left h1 { font-size: 13px; font-weight: 500; color: var(--text-secondary); letter-spacing: 0.5px; text-transform: uppercase; }
        .header-center { display: flex; align-items: center; gap: 16px; }
        .live-badge {
            display: flex; align-items: center; gap: 6px;
            font-size: 10px; font-weight: 600; letter-spacing: 1.2px;
            text-transform: uppercase; color: var(--red);
        }
        .live-dot {
            width: 5px; height: 5px; border-radius: 50%;
            background: var(--red);
            box-shadow: 0 0 6px rgba(227,25,55,0.4);
            animation: livePulse 1.5s ease-in-out infinite;
        }
        @keyframes livePulse { 0%,100%{opacity:1;} 50%{opacity:0.3;} }
        .sensor-count { font-size: 10px; color: var(--text-tertiary); font-weight: 400; letter-spacing: 0.5px; }
        .header-right { display: flex; align-items: center; gap: 6px; }
        .clock { font-size: 11px; color: var(--text-tertiary); font-weight: 400; font-variant-numeric: tabular-nums; margin-right: 8px; }

        /* Buttons - Tesla style */
        .btn {
            padding: 6px 14px; border-radius: 4px; border: 1px solid var(--border);
            background: transparent; color: var(--text-secondary);
            font-size: 10px; font-weight: 500; font-family: inherit;
            cursor: pointer; display: inline-flex; align-items: center; gap: 5px;
            transition: all 0.2s ease; letter-spacing: 0.3px; text-transform: uppercase;
        }
        .btn:hover { background: var(--bg-hover); color: var(--text-primary); border-color: rgba(0,0,0,0.12); }
        .btn:active { transform: scale(0.97); }
        .btn-red { border-color: rgba(227,25,55,0.3); color: var(--red); }
        .btn-red:hover { background: var(--red-subtle); border-color: rgba(227,25,55,0.5); }
        .btn i { font-size: 10px; }

        /* Content */
        .content { flex: 1; display: flex; overflow: hidden; }

        /* Left Panel - Tesla light glass */
        .left-panel {
            width: 260px; flex-shrink: 0;
            background: rgba(250,250,250,0.92);
            backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border-right: 1px solid var(--border);
            overflow-y: auto; display: flex; flex-direction: column;
        }
        .panel-section { padding: 16px; }
        .panel-section + .panel-section { border-top: 1px solid var(--border); }
        .section-title {
            font-size: 9px; font-weight: 600; color: var(--text-tertiary);
            text-transform: uppercase; letter-spacing: 1.5px;
            margin-bottom: 12px; display: flex; align-items: center; gap: 6px;
        }

        /* Sensor toggle - Tesla list */
        .sensor-toggle {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 12px; border-radius: 6px; cursor: pointer;
            transition: all 0.15s ease; margin-bottom: 2px;
            border: 1px solid transparent;
        }
        .sensor-toggle:hover { background: var(--bg-hover); }
        .sensor-toggle.active {
            background: var(--bg-elevated);
            border-color: var(--border);
        }
        .sensor-info { display: flex; align-items: center; gap: 10px; }
        .sensor-dot { width: 3px; height: 20px; border-radius: 2px; flex-shrink: 0; }
        .sensor-name { font-size: 12px; font-weight: 500; color: var(--text-primary); }
        .sensor-desc { font-size: 9px; color: var(--text-tertiary); margin-top: 2px; font-weight: 400; letter-spacing: 0.3px; }
        .toggle-icon { font-size: 11px; color: var(--text-tertiary); transition: color 0.2s; }
        .sensor-toggle.active .toggle-icon { color: var(--red); }

        /* Slider - Tesla */
        .ctrl-group { margin-bottom: 16px; }
        .ctrl-label {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;
        }
        .ctrl-value { color: var(--text-primary); font-weight: 600; font-variant-numeric: tabular-nums; }
        input[type="range"] {
            width: 100%; height: 2px; appearance: none; -webkit-appearance: none;
            background: var(--text-tertiary); border-radius: 1px; outline: none; cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%;
            background: var(--text-primary); cursor: pointer;
            box-shadow: 0 1px 4px rgba(0,0,0,0.15);
        }
        input[type="range"]::-webkit-slider-thumb:hover { box-shadow: 0 0 10px rgba(227,25,55,0.25); }

        /* Preset buttons - Tesla */
        .preset-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .preset-btn {
            padding: 8px; border-radius: 4px;
            border: 1px solid var(--border); background: transparent;
            color: var(--text-secondary); font-size: 10px; font-weight: 500;
            cursor: pointer; text-align: center; transition: all 0.15s ease;
            font-family: inherit; letter-spacing: 0.3px;
        }
        .preset-btn:hover { background: var(--bg-hover); border-color: rgba(0,0,0,0.1); }
        .preset-btn:active { transform: scale(0.97); }
        .preset-btn.active { background: var(--red); border-color: var(--red); color: white; }

        /* Canvas - clean white */
        .canvas-area { flex: 1; position: relative; background: #f0f0f0; }
        #canvas3d { width: 100%; height: 100%; display: block; }

        /* Heatmap legend - Tesla */
        .legend {
            position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 6px; padding: 8px 14px; display: none;
            align-items: center; gap: 10px; z-index: 10;
        }
        .legend.show { display: flex; }
        .legend-labels { display: flex; justify-content: space-between; width: 180px; font-size: 8px; color: var(--text-tertiary); font-weight: 500; letter-spacing: 0.5px; }
        .legend-title { font-size: 9px; color: var(--text-secondary); font-weight: 600; white-space: nowrap; text-transform: uppercase; letter-spacing: 0.8px; }

        /* Right Panel */
        .right-panel {
            width: 280px; flex-shrink: 0;
            background: rgba(250,250,250,0.92);
            backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border-left: 1px solid var(--border);
            overflow-y: auto; display: flex; flex-direction: column;
        }

        /* Stats cards - Tesla */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .stat-card {
            background: var(--bg-elevated); border-radius: 6px; padding: 14px;
            border: 1px solid var(--border);
        }
        .stat-card .value {
            font-size: 28px; font-weight: 200; color: var(--text-primary);
            font-variant-numeric: tabular-nums; letter-spacing: -1px;
        }
        .stat-card .label {
            font-size: 8px; color: var(--text-tertiary); margin-top: 4px;
            text-transform: uppercase; letter-spacing: 1.2px; font-weight: 500;
        }
        .stat-card.highlight .value { color: var(--red); }
        .stat-card.warning .value { color: var(--orange); }
        .stat-card.danger .value { color: #ff2d2d; }
        .stat-card.success .value { color: var(--green); }

        /* Temp zones - Tesla */
        .temp-zone {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 12px; border-radius: 6px; margin-bottom: 3px;
            background: var(--bg-elevated); border: 1px solid var(--border);
        }
        .temp-zone-info { display: flex; align-items: center; gap: 8px; }
        .temp-zone-dot { width: 3px; height: 16px; border-radius: 2px; }
        .temp-zone-name { font-size: 11px; color: var(--text-secondary); font-weight: 400; }
        .temp-zone-value { font-size: 13px; font-weight: 300; font-variant-numeric: tabular-nums; letter-spacing: -0.3px; }
        .temp-zone-btn {
            width: 26px; height: 26px; border-radius: 4px;
            border: 1px solid var(--border); background: transparent;
            color: var(--text-tertiary); font-size: 10px; cursor: pointer;
            transition: all 0.15s ease; display: flex; align-items: center; justify-content: center;
        }
        .temp-zone-btn:hover { background: var(--bg-hover); }
        .temp-zone-btn.on { background: var(--red); border-color: var(--red); color: white; box-shadow: 0 2px 8px rgba(227,25,55,0.2); }
        .temp-zone-btn.cool { background: var(--blue); border-color: var(--blue); color: white; box-shadow: 0 2px 8px rgba(62,106,225,0.2); }

        /* Motion bars - Tesla */
        .motion-axis { margin-bottom: 10px; }
        .motion-axis-label {
            display: flex; justify-content: space-between;
            font-size: 10px; color: var(--text-tertiary); margin-bottom: 5px; font-weight: 400;
        }
        .motion-axis-label span:last-child { font-variant-numeric: tabular-nums; color: var(--text-secondary); font-weight: 500; }
        .motion-bar-bg {
            height: 3px; background: var(--text-tertiary); border-radius: 2px;
            overflow: hidden; position: relative;
        }
        .motion-bar {
            position: absolute; top: 0; height: 100%; border-radius: 2px;
            transition: width 0.15s ease, left 0.15s ease;
        }

        /* Alerts - Tesla */
        .alert-item {
            display: flex; align-items: flex-start; gap: 8px;
            padding: 10px 12px; border-radius: 6px; margin-bottom: 3px;
            background: var(--bg-elevated); font-size: 10px;
            border: 1px solid var(--border);
            border-left: 2px solid transparent;
        }
        .alert-item.info { border-left-color: var(--blue); }
        .alert-item.warn { border-left-color: var(--orange); }
        .alert-item.error { border-left-color: var(--red); }
        .alert-time { color: var(--text-tertiary); font-size: 9px; white-space: nowrap; font-weight: 400; font-variant-numeric: tabular-nums; }
        .alert-msg { color: var(--text-secondary); font-weight: 400; line-height: 1.4; }

        /* Sim control */
        .sim-control {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 12px; background: var(--bg-elevated); border-radius: 6px;
            border: 1px solid var(--border); margin-bottom: 14px;
        }
        .sim-dot { width: 6px; height: 6px; border-radius: 50%; }
        .sim-dot.running { background: var(--red); box-shadow: 0 0 6px rgba(227,25,55,0.3); animation: livePulse 1.5s ease-in-out infinite; }
        .sim-dot.paused { background: var(--orange); }
        .sim-label { font-size: 11px; flex: 1; font-weight: 400; color: var(--text-secondary); }

        /* Mini heatmap */
        #miniHeatmap { width: 100%; border-radius: 6px; background: #f0f0f0; border: 1px solid var(--border); }

        /* Toast */
        .toast {
            position: fixed; bottom: 20px; right: 20px;
            background: rgba(255,255,255,0.92);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-radius: 6px; padding: 10px 18px; font-size: 12px;
            color: var(--text-primary); font-weight: 400;
            z-index: 100; opacity: 0; transform: translateY(10px);
            transition: all 0.3s ease; pointer-events: none;
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        /* Scrollbar - subtle */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.08); border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.15); }

        /* Footer */
        .footer-credit {
            padding: 14px 16px; text-align: center;
            font-size: 9px; color: var(--text-tertiary); font-weight: 400;
            border-top: 1px solid var(--border); letter-spacing: 0.5px;
        }

        /* Tesla accent line */
        .accent-line {
            height: 1px; background: linear-gradient(90deg, transparent, var(--red), transparent);
            opacity: 0.3;
        }
    </style>
</head>
<body>
<div class="app">
    <div class="accent-line"></div>
    <!-- Header -->
    <div class="header">
        <div class="header-left">
            <img src="keti.png" alt="KETI">
            <span class="header-pipe">|</span>
            <h1>Smart Seat Monitor</h1>
        </div>
        <div class="header-center">
            <div class="live-badge"><div class="live-dot"></div>LIVE</div>
            <span class="sensor-count">4 Sensors Active</span>
        </div>
        <div class="header-right">
            <span class="clock" id="clock">00:00:00</span>
            <button class="btn" onclick="exportJSON()"><i class="fas fa-download"></i> JSON</button>
            <button class="btn" onclick="exportCSV()"><i class="fas fa-table"></i> CSV</button>
        </div>
    </div>

    <div class="content">
        <!-- Left Panel -->
        <div class="left-panel">
            <div class="panel-section">
                <div class="section-title">Sensor Layers</div>
                <div class="sensor-toggle active" data-sensor="pressure" onclick="toggleSensor('pressure')">
                    <div class="sensor-info">
                        <div class="sensor-dot" style="background:var(--red);"></div>
                        <div>
                            <div class="sensor-name">Pressure</div>
                            <div class="sensor-desc">OCCUPANCY / LOAD DISTRIBUTION</div>
                        </div>
                    </div>
                    <i class="fas fa-eye toggle-icon"></i>
                </div>
                <div class="sensor-toggle" data-sensor="temperature" onclick="toggleSensor('temperature')">
                    <div class="sensor-info">
                        <div class="sensor-dot" style="background:var(--orange);"></div>
                        <div>
                            <div class="sensor-name">Temperature</div>
                            <div class="sensor-desc">HEATING / COOLING ZONES</div>
                        </div>
                    </div>
                    <i class="fas fa-eye-slash toggle-icon"></i>
                </div>
                <div class="sensor-toggle" data-sensor="position" onclick="toggleSensor('position')">
                    <div class="sensor-info">
                        <div class="sensor-dot" style="background:var(--blue);"></div>
                        <div>
                            <div class="sensor-name">Position</div>
                            <div class="sensor-desc">SEAT ADJUSTMENT TRACKING</div>
                        </div>
                    </div>
                    <i class="fas fa-eye-slash toggle-icon"></i>
                </div>
                <div class="sensor-toggle" data-sensor="motion" onclick="toggleSensor('motion')">
                    <div class="sensor-info">
                        <div class="sensor-dot" style="background:var(--green);"></div>
                        <div>
                            <div class="sensor-name">Motion</div>
                            <div class="sensor-desc">ACCELERATION / VIBRATION</div>
                        </div>
                    </div>
                    <i class="fas fa-eye-slash toggle-icon"></i>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-title">Simulation</div>
                <div class="sim-control">
                    <div class="sim-dot running" id="simDot"></div>
                    <span class="sim-label" id="simLabel">Running</span>
                    <button class="btn" id="simBtn" onclick="toggleSimulation()" style="padding:4px 10px;font-size:9px;">
                        <i class="fas fa-pause"></i>
                    </button>
                </div>
                <div class="ctrl-group">
                    <div class="ctrl-label"><span>Occupant Weight</span><span class="ctrl-value" id="weightVal">70 kg</span></div>
                    <input type="range" min="30" max="130" value="70" id="weightSlider" oninput="updateWeight(this.value)">
                </div>
                <div class="ctrl-group">
                    <div class="ctrl-label"><span>Vehicle Speed</span><span class="ctrl-value" id="speedVal">0 km/h</span></div>
                    <input type="range" min="0" max="200" value="0" id="speedSlider" oninput="updateSpeed(this.value)">
                </div>
                <div class="ctrl-group">
                    <div class="ctrl-label"><span>Occupancy State</span></div>
                    <div class="preset-grid">
                        <button class="preset-btn active" onclick="setOccupancy('seated',this)">Seated</button>
                        <button class="preset-btn" onclick="setOccupancy('empty',this)">Empty</button>
                        <button class="preset-btn" onclick="setOccupancy('child',this)">Child</button>
                        <button class="preset-btn" onclick="setOccupancy('heavy',this)">Heavy</button>
                    </div>
                </div>
            </div>

            <div class="panel-section" id="positionPanel" style="display:none;">
                <div class="section-title">Seat Position</div>
                <div class="preset-grid" style="margin-bottom:14px;">
                    <button class="preset-btn active" onclick="applyPreset('normal',this)">Drive</button>
                    <button class="preset-btn" onclick="applyPreset('sport',this)">Sport</button>
                    <button class="preset-btn" onclick="applyPreset('relax',this)">Relax</button>
                    <button class="preset-btn" onclick="applyPreset('entry',this)">Entry</button>
                </div>
                <div class="ctrl-group">
                    <div class="ctrl-label"><span>Fore / Aft</span><span class="ctrl-value" id="fbVal">0</span></div>
                    <input type="range" min="-100" max="100" value="0" id="fbSlider" oninput="updatePosition('forwardBack',this.value)">
                </div>
                <div class="ctrl-group">
                    <div class="ctrl-label"><span>Height</span><span class="ctrl-value" id="udVal">0</span></div>
                    <input type="range" min="-100" max="100" value="0" id="udSlider" oninput="updatePosition('upDown',this.value)">
                </div>
                <div class="ctrl-group">
                    <div class="ctrl-label"><span>Recline</span><span class="ctrl-value" id="recVal">18°</span></div>
                    <input type="range" min="5" max="50" value="18" id="recSlider" oninput="updatePosition('recline',this.value)">
                </div>
                <div class="ctrl-group">
                    <div class="ctrl-label"><span>Headrest</span><span class="ctrl-value" id="hrVal">0</span></div>
                    <input type="range" min="0" max="100" value="0" id="hrSlider" oninput="updatePosition('headrest',this.value)">
                </div>
            </div>

            <div class="panel-section">
                <div class="section-title">Thresholds</div>
                <div class="ctrl-group">
                    <div class="ctrl-label"><span>Pressure Alert</span><span class="ctrl-value" id="pressThVal">80 kPa</span></div>
                    <input type="range" min="30" max="120" value="80" id="pressThSlider" oninput="thresholds.pressure=+this.value;document.getElementById('pressThVal').textContent=this.value+' kPa'">
                </div>
                <div class="ctrl-group">
                    <div class="ctrl-label"><span>Overheat Alert</span><span class="ctrl-value" id="tempThVal">40°C</span></div>
                    <input type="range" min="30" max="50" value="40" id="tempThSlider" oninput="thresholds.temperature=+this.value;document.getElementById('tempThVal').textContent=this.value+'°C'">
                </div>
                <div class="ctrl-group">
                    <div class="ctrl-label"><span>Vibration Alert</span><span class="ctrl-value" id="vibThVal">0.7 G</span></div>
                    <input type="range" min="1" max="20" value="7" id="vibThSlider" oninput="thresholds.vibration=this.value/10;document.getElementById('vibThVal').textContent=(this.value/10).toFixed(1)+' G'">
                </div>
            </div>

            <div class="panel-section">
                <div class="section-title">View</div>
                <div class="ctrl-group">
                    <div class="ctrl-label"><span>Seat Opacity</span><span class="ctrl-value" id="opVal">100%</span></div>
                    <input type="range" min="10" max="100" value="100" id="opSlider" oninput="setSeatOpacity(this.value)">
                </div>
                <div class="preset-grid">
                    <button class="preset-btn" onclick="resetCamera()">Reset View</button>
                    <button class="preset-btn" onclick="toggleAutoRotate()">Auto Rotate</button>
                </div>
            </div>

            <div class="footer-credit">KETI | Korea Electronics Technology Institute</div>
        </div>

        <!-- 3D Canvas -->
        <div class="canvas-area">
            <div id="canvas3d"></div>
            <div class="legend" id="pressureLegend">
                <span class="legend-title">Pressure (kPa)</span>
                <div>
                    <canvas id="legendBar" width="180" height="10" style="border-radius:3px;"></canvas>
                    <div class="legend-labels"><span>0</span><span>25</span><span>50</span><span>75</span><span>100</span></div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div class="panel-section" id="pressurePanel">
                <div class="section-title">Pressure Data</div>
                <div class="stats-grid">
                    <div class="stat-card highlight">
                        <div class="value" id="rTotalWeight">0</div>
                        <div class="label">Total Load (kg)</div>
                    </div>
                    <div class="stat-card success">
                        <div class="value" id="rOccupancy">Empty</div>
                        <div class="label">Seat Status</div>
                    </div>
                    <div class="stat-card">
                        <div class="value" id="rAvgPress">0</div>
                        <div class="label">Avg Pressure</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="value" id="rPeakPress">0</div>
                        <div class="label">Peak Pressure</div>
                    </div>
                </div>
                <div style="margin-top:12px;">
                    <div class="ctrl-label"><span>Pressure Distribution</span></div>
                    <canvas id="miniHeatmap" width="160" height="160"></canvas>
                </div>
            </div>

            <div class="panel-section" id="tempPanel" style="display:none;">
                <div class="section-title">Temperature Status</div>
                <div id="tempZoneList"></div>
            </div>

            <div class="panel-section" id="posPanel" style="display:none;">
                <div class="section-title">Seat Position</div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="value" id="rFB">0</div><div class="label">Fore/Aft (mm)</div></div>
                    <div class="stat-card"><div class="value" id="rUD">0</div><div class="label">Height (mm)</div></div>
                    <div class="stat-card"><div class="value" id="rRec">18°</div><div class="label">Recline</div></div>
                    <div class="stat-card"><div class="value" id="rHR">0</div><div class="label">Headrest</div></div>
                </div>
            </div>

            <div class="panel-section" id="motionPanel" style="display:none;">
                <div class="section-title">Motion Data</div>
                <div class="stats-grid" style="margin-bottom:12px;">
                    <div class="stat-card"><div class="value" id="rVib">0.0</div><div class="label">Vibration (G)</div></div>
                    <div class="stat-card"><div class="value" id="rFreq">0</div><div class="label">Frequency (Hz)</div></div>
                </div>
                <div class="motion-axis">
                    <div class="motion-axis-label"><span>X-Axis (Lateral)</span><span id="rAX">0.00</span></div>
                    <div class="motion-bar-bg"><div class="motion-bar" id="barAX" style="background:var(--red);width:50%;left:25%;"></div></div>
                </div>
                <div class="motion-axis">
                    <div class="motion-axis-label"><span>Y-Axis (Vertical)</span><span id="rAY">0.00</span></div>
                    <div class="motion-bar-bg"><div class="motion-bar" id="barAY" style="background:var(--green);width:50%;left:25%;"></div></div>
                </div>
                <div class="motion-axis">
                    <div class="motion-axis-label"><span>Z-Axis (Longitudinal)</span><span id="rAZ">0.00</span></div>
                    <div class="motion-bar-bg"><div class="motion-bar" id="barAZ" style="background:var(--blue);width:50%;left:25%;"></div></div>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-title">Alerts <span style="color:var(--text-tertiary);font-weight:400;" id="alertCount">(0)</span></div>
                <div id="alertList">
                    <div style="font-size:11px;color:var(--text-tertiary);text-align:center;padding:24px;">No alerts</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ==================== State ====================
const activeSensors = new Set(['pressure']);
let simulationRunning = true;
const thresholds = { pressure: 80, temperature: 40, vibration: 0.7 };

const seatState = {
    occupied: true, occupantWeight: 70, vehicleSpeed: 0,
    forwardBack: 0, upDown: 0, recline: 18, headrest: 0
};

const temperatureZones = [
    { name: 'Left Cushion', temp: 22, target: 28, heating: false, cooling: false },
    { name: 'Right Cushion', temp: 22, target: 28, heating: false, cooling: false },
    { name: 'Left Backrest', temp: 22, target: 30, heating: false, cooling: false },
    { name: 'Right Backrest', temp: 22, target: 30, heating: false, cooling: false },
    { name: 'Left Bolster', temp: 22, target: 26, heating: false, cooling: false },
    { name: 'Right Bolster', temp: 22, target: 26, heating: false, cooling: false }
];

const motionState = { accelX: 0, accelY: 0, accelZ: 0, vibAmp: 0, vibFreq: 30 };
const pressureGrid = new Float32Array(16 * 16);
const alerts = [];

// ==================== Three.js Setup ====================
let scene, camera, renderer, controls;
let seatGroup, seatBaseY = 0;
let cushionMesh, backrestMesh, headrestMesh, leftBolsterMesh, rightBolsterMesh;
let railMeshes = [];
let pressureOverlayCushion, pressureOverlayBack;
let pressureCanvasCushion, pressureCtxCushion, pressureTextureCushion;
let pressureCanvasBack, pressureCtxBack, pressureTextureBack;
let arrowX, arrowY, arrowZ, arrowGroup;
const clock = new THREE.Clock();

function initScene() {
    const container = document.getElementById('canvas3d');
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f0f0);
    scene.fog = new THREE.Fog(0xf0f0f0, 4, 10);

    camera = new THREE.PerspectiveCamera(40, container.clientWidth / container.clientHeight, 0.01, 100);
    camera.position.set(1.3, 0.9, 1.6);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.0;
    container.appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.06;
    controls.target.set(0, 0.35, 0);
    controls.minDistance = 0.5;
    controls.maxDistance = 4;
    controls.maxPolarAngle = Math.PI * 0.85;

    // Tesla-style lighting - bright, clean studio
    scene.add(new THREE.AmbientLight(0xffffff, 0.75));
    const main = new THREE.DirectionalLight(0xffffff, 1.1);
    main.position.set(2, 4, 3);
    main.castShadow = true;
    main.shadow.mapSize.set(1024, 1024);
    main.shadow.bias = -0.001;
    scene.add(main);
    const fill = new THREE.DirectionalLight(0xf0f0ff, 0.5);
    fill.position.set(-3, 2, -1);
    scene.add(fill);
    // Subtle red accent from below
    const redLight = new THREE.PointLight(0xe31937, 0.08, 3);
    redLight.position.set(0, -0.3, 0.5);
    scene.add(redLight);
    // Rim light
    const rim = new THREE.DirectionalLight(0xeeeeff, 0.3);
    rim.position.set(0, 1, -3);
    scene.add(rim);
    // Top fill
    const top = new THREE.DirectionalLight(0xffffff, 0.3);
    top.position.set(0, 6, 0);
    scene.add(top);

    // Subtle grid - light
    const grid = new THREE.GridHelper(3, 20, 0xd8d8d8, 0xe5e5e5);
    grid.material.opacity = 0.5;
    grid.material.transparent = true;
    scene.add(grid);

    // Floor - soft white
    const floor = new THREE.Mesh(
        new THREE.PlaneGeometry(6, 6),
        new THREE.MeshStandardMaterial({ color: 0xebebeb, roughness: 0.95, metalness: 0.0 })
    );
    floor.rotation.x = -Math.PI / 2;
    floor.position.y = -0.01;
    floor.receiveShadow = true;
    scene.add(floor);

    seatGroup = new THREE.Group();
    scene.add(seatGroup);

    const loader = new THREE.GLTFLoader();
    loader.load('./models/car-seat.glb',
        (gltf) => {
            const model = gltf.scene;
            const box = new THREE.Box3().setFromObject(model);
            const size = box.getSize(new THREE.Vector3());
            const center = box.getCenter(new THREE.Vector3());
            const scale = 0.9 / Math.max(size.x, size.y, size.z);
            model.scale.set(scale, scale, scale);
            model.position.set(-center.x * scale, -box.min.y * scale, -center.z * scale);
            model.traverse(c => { if (c.isMesh) { c.castShadow = true; c.receiveShadow = true; } });
            seatGroup.add(model);
            buildProceduralSeat();
            showToast('GLB model loaded');
        },
        undefined,
        () => { buildProceduralSeat(); showToast('3D seat model ready'); }
    );

    setupPressureOverlays();
    setupMotionArrows();

    window.addEventListener('resize', () => {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    });
}

// ==================== Procedural Seat ====================
function buildProceduralSeat() {
    // Tesla-style materials - dark seat for contrast on white
    const seatMat = new THREE.MeshStandardMaterial({ color: 0x2c2c2c, roughness: 0.5, metalness: 0.05 });
    const frameMat = new THREE.MeshStandardMaterial({ color: 0x555555, roughness: 0.25, metalness: 0.7 });
    const bolsterMat = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.45, metalness: 0.05 });

    const railGeo = new THREE.BoxGeometry(0.04, 0.02, 0.45);
    const rail1 = new THREE.Mesh(railGeo, frameMat);
    rail1.position.set(-0.15, 0.01, 0); rail1.castShadow = true;
    seatGroup.add(rail1); railMeshes.push(rail1);
    const rail2 = new THREE.Mesh(railGeo, frameMat);
    rail2.position.set(0.15, 0.01, 0); rail2.castShadow = true;
    seatGroup.add(rail2); railMeshes.push(rail2);

    const cushionGeo = new THREE.BoxGeometry(0.44, 0.07, 0.44);
    cushionMesh = new THREE.Mesh(cushionGeo, seatMat.clone());
    cushionMesh.position.set(0, 0.09, 0);
    cushionMesh.castShadow = true; cushionMesh.receiveShadow = true;
    seatGroup.add(cushionMesh);

    const backGeo = new THREE.BoxGeometry(0.42, 0.55, 0.07);
    backrestMesh = new THREE.Mesh(backGeo, seatMat.clone());
    backrestMesh.position.set(0, 0.42, -0.2);
    backrestMesh.rotation.x = -THREE.MathUtils.degToRad(seatState.recline);
    backrestMesh.castShadow = true; backrestMesh.receiveShadow = true;
    seatGroup.add(backrestMesh);

    const hrGeo = new THREE.BoxGeometry(0.22, 0.16, 0.06);
    headrestMesh = new THREE.Mesh(hrGeo, seatMat.clone());
    headrestMesh.position.set(0, 0.78, -0.25);
    headrestMesh.castShadow = true;
    seatGroup.add(headrestMesh);

    const bolGeo = new THREE.BoxGeometry(0.06, 0.12, 0.42);
    leftBolsterMesh = new THREE.Mesh(bolGeo, bolsterMat.clone());
    leftBolsterMesh.position.set(-0.24, 0.14, 0); leftBolsterMesh.castShadow = true;
    seatGroup.add(leftBolsterMesh);
    rightBolsterMesh = new THREE.Mesh(bolGeo, bolsterMat.clone());
    rightBolsterMesh.position.set(0.24, 0.14, 0); rightBolsterMesh.castShadow = true;
    seatGroup.add(rightBolsterMesh);

    const bbolGeo = new THREE.BoxGeometry(0.06, 0.5, 0.06);
    const lbb = new THREE.Mesh(bbolGeo, bolsterMat.clone());
    lbb.position.set(-0.23, 0.42, -0.16);
    lbb.rotation.x = -THREE.MathUtils.degToRad(seatState.recline);
    seatGroup.add(lbb);
    const rbb = new THREE.Mesh(bbolGeo, bolsterMat.clone());
    rbb.position.set(0.23, 0.42, -0.16);
    rbb.rotation.x = -THREE.MathUtils.degToRad(seatState.recline);
    seatGroup.add(rbb);
}

// ==================== Pressure Overlay ====================
function setupPressureOverlays() {
    pressureCanvasCushion = document.createElement('canvas');
    pressureCanvasCushion.width = 128; pressureCanvasCushion.height = 128;
    pressureCtxCushion = pressureCanvasCushion.getContext('2d');
    pressureTextureCushion = new THREE.CanvasTexture(pressureCanvasCushion);
    pressureTextureCushion.minFilter = THREE.LinearFilter;

    pressureOverlayCushion = new THREE.Mesh(
        new THREE.PlaneGeometry(0.42, 0.42),
        new THREE.MeshBasicMaterial({ map: pressureTextureCushion, transparent: true, opacity: 0.85, depthWrite: false, side: THREE.DoubleSide })
    );
    pressureOverlayCushion.rotation.x = -Math.PI / 2;
    pressureOverlayCushion.position.set(0, 0.131, 0);
    seatGroup.add(pressureOverlayCushion);

    pressureCanvasBack = document.createElement('canvas');
    pressureCanvasBack.width = 128; pressureCanvasBack.height = 128;
    pressureCtxBack = pressureCanvasBack.getContext('2d');
    pressureTextureBack = new THREE.CanvasTexture(pressureCanvasBack);
    pressureTextureBack.minFilter = THREE.LinearFilter;

    pressureOverlayBack = new THREE.Mesh(
        new THREE.PlaneGeometry(0.40, 0.50),
        new THREE.MeshBasicMaterial({ map: pressureTextureBack, transparent: true, opacity: 0.75, depthWrite: false, side: THREE.DoubleSide })
    );
    pressureOverlayBack.position.set(0, 0.42, -0.165);
    pressureOverlayBack.rotation.x = -THREE.MathUtils.degToRad(seatState.recline);
    seatGroup.add(pressureOverlayBack);
}

// ==================== Motion Arrows ====================
function setupMotionArrows() {
    arrowGroup = new THREE.Group();
    arrowGroup.visible = false;
    arrowX = new THREE.ArrowHelper(new THREE.Vector3(1,0,0), new THREE.Vector3(0,0.5,0.3), 0.2, 0xe31937, 0.04, 0.025);
    arrowY = new THREE.ArrowHelper(new THREE.Vector3(0,1,0), new THREE.Vector3(0,0.5,0.3), 0.2, 0x17b169, 0.04, 0.025);
    arrowZ = new THREE.ArrowHelper(new THREE.Vector3(0,0,1), new THREE.Vector3(0,0.5,0.3), 0.2, 0x3e6ae1, 0.04, 0.025);
    arrowGroup.add(arrowX, arrowY, arrowZ);
    seatGroup.add(arrowGroup);
}

// ==================== Colors - Tesla palette ====================
function pressureColor(t) {
    t = Math.max(0, Math.min(1, t));
    let r, g, b;
    // Dark blue → cyan → red (Tesla style)
    if (t < 0.33) { const f=t/0.33; r=Math.round(15+f*0); g=Math.round(30+f*180); b=Math.round(80+f*175); }
    else if (t < 0.66) { const f=(t-0.33)/0.33; r=Math.round(15+f*227); g=Math.round(210-f*100); b=Math.round(255-f*200); }
    else { const f=(t-0.66)/0.34; r=Math.round(242-f*15); g=Math.round(110-f*85); b=Math.round(55-f*30); }
    return `rgba(${r},${g},${b},${0.35+t*0.65})`;
}

function temperatureColor(temp) {
    const t = Math.max(0, Math.min(1, (temp-15)/25));
    const c = new THREE.Color();
    if (t < 0.3) c.lerpColors(new THREE.Color(0x3e6ae1), new THREE.Color(0xeeeeee), t/0.3);
    else if (t < 0.6) c.set(0xeeeeee);
    else c.lerpColors(new THREE.Color(0xf5a623), new THREE.Color(0xe31937), (t-0.6)/0.4);
    return c;
}

function gaussian2D(x, y, sx, sy) {
    return Math.exp(-(x*x)/(2*sx*sx) - (y*y)/(2*sy*sy));
}

// ==================== Simulation ====================
function simulatePressure(time) {
    if (!seatState.occupied) { pressureGrid.fill(0); return; }
    const wFactor = seatState.occupantWeight / 80;
    for (let y=0; y<16; y++) for (let x=0; x<16; x++) {
        const nx=(x/15)*2-1, ny=(y/15)*2-1;
        const lp=gaussian2D(nx+0.35,ny-0.1,0.28,0.32);
        const rp=gaussian2D(nx-0.35,ny-0.1,0.28,0.32);
        const lt=gaussian2D(nx+0.3,ny+0.25,0.22,0.4)*0.35;
        const rt=gaussian2D(nx-0.3,ny+0.25,0.22,0.4)*0.35;
        pressureGrid[y*16+x] = Math.max(0, Math.min(1,
            (lp+rp+lt+rt)*wFactor + Math.sin(time*0.35)*0.015 + Math.sin(time*0.07)*0.025*nx + (Math.random()-0.5)*0.008));
    }
}

function simulateTemperature(dt) {
    temperatureZones.forEach(z => {
        if (z.heating) z.temp += (z.target-z.temp)*dt*0.04;
        else if (z.cooling) z.temp += (18-z.temp)*dt*0.03;
        else z.temp += (22-z.temp)*dt*0.005;
        z.temp = Math.max(5, Math.min(50, z.temp + (Math.random()-0.5)*0.05));
    });
}

function simulateMotion(time) {
    const s = seatState.vehicleSpeed;
    const eFreq = 25+s*0.3, eAmp = 0.05+s*0.004;
    const road = Math.sin(time*2.3)*0.2 + Math.sin(time*5.7)*0.08;
    motionState.accelX = Math.sin(time*0.8)*s*0.008 + (Math.random()-0.5)*0.3;
    motionState.accelY = road*s*0.008 + Math.sin(time*eFreq*0.1)*eAmp;
    motionState.accelZ = Math.cos(time*0.3)*s*0.004 + (Math.random()-0.5)*0.15;
    motionState.vibAmp = (eAmp+Math.abs(road)*0.5)*Math.min(1,s/80);
    motionState.vibFreq = eFreq;
}

// ==================== Render Updates ====================
function updatePressureHeatmapCushion() {
    const ctx=pressureCtxCushion, w=128, h=128;
    ctx.clearRect(0,0,w,h);
    const cw=w/16, ch=h/16;
    for (let y=0;y<16;y++) for (let x=0;x<16;x++) {
        const v=pressureGrid[y*16+x];
        if (v>0.01) { ctx.fillStyle=pressureColor(v); ctx.beginPath(); ctx.arc(x*cw+cw/2,y*ch+ch/2,cw*0.6,0,Math.PI*2); ctx.fill(); }
    }
    pressureTextureCushion.needsUpdate = true;
}

function updatePressureHeatmapBack() {
    const ctx=pressureCtxBack, w=128, h=128;
    ctx.clearRect(0,0,w,h);
    if (!seatState.occupied) { pressureTextureBack.needsUpdate=true; return; }
    const wF=seatState.occupantWeight/80*0.4, cw=w/12, ch=h/16;
    for (let y=0;y<16;y++) for (let x=0;x<12;x++) {
        const nx=(x/11)*2-1, ny=(y/15)*2-1;
        const v=(gaussian2D(nx+0.3,ny+0.1,0.4,0.35)+gaussian2D(nx-0.3,ny+0.1,0.4,0.35))*wF;
        if (v>0.01) { ctx.fillStyle=pressureColor(v); ctx.beginPath(); ctx.arc(x*cw+cw/2,y*ch+ch/2,cw*0.6,0,Math.PI*2); ctx.fill(); }
    }
    pressureTextureBack.needsUpdate = true;
}

function updateTemperatureVisuals() {
    const meshes = [cushionMesh,cushionMesh,backrestMesh,backrestMesh,leftBolsterMesh,rightBolsterMesh];
    temperatureZones.forEach((z,i) => {
        const m=meshes[i]; if (!m) return;
        m.material.emissive = temperatureColor(z.temp);
        m.material.emissiveIntensity = (z.heating||z.cooling) ? 0.5 : 0.15;
    });
}

function updateSeatPositionVisuals() {
    seatGroup.position.z = seatState.forwardBack/100*0.12;
    seatGroup.position.y = seatState.upDown/100*0.04;
    const rec = THREE.MathUtils.degToRad(seatState.recline);
    if (backrestMesh) backrestMesh.rotation.x = -rec;
    if (pressureOverlayBack) pressureOverlayBack.rotation.x = -rec;
    if (headrestMesh) headrestMesh.position.y = 0.78 + seatState.headrest/100*0.06;
}

function updateMotionVisuals(time) {
    if (!arrowGroup.visible) return;
    const s=0.3;
    arrowX.setLength(Math.max(0.05,Math.abs(motionState.accelX)*s),0.04,0.025);
    arrowX.setDirection(new THREE.Vector3(Math.sign(motionState.accelX)||1,0,0).normalize());
    arrowY.setLength(Math.max(0.05,Math.abs(motionState.accelY)*s),0.04,0.025);
    arrowY.setDirection(new THREE.Vector3(0,Math.sign(motionState.accelY)||1,0).normalize());
    arrowZ.setLength(Math.max(0.05,Math.abs(motionState.accelZ)*s),0.04,0.025);
    arrowZ.setDirection(new THREE.Vector3(0,0,Math.sign(motionState.accelZ)||1).normalize());
    if (motionState.vibAmp > 0.01) {
        seatGroup.rotation.z = Math.sin(time*motionState.vibFreq*0.3)*motionState.vibAmp*0.002;
        seatGroup.position.y = (seatState.upDown/100*0.04) + Math.sin(time*motionState.vibFreq*0.5)*motionState.vibAmp*0.003;
    }
}

// ==================== UI Updates ====================
let lastUIUpdate = 0;

function updateDashboard() {
    if (activeSensors.has('pressure')) {
        let sum=0, max=0, count=0;
        for (let i=0;i<pressureGrid.length;i++) if (pressureGrid[i]>0.01) { sum+=pressureGrid[i]; count++; max=Math.max(max,pressureGrid[i]); }
        const avg = count>0 ? (sum/count*100).toFixed(1) : '0';
        const peak = (max*100).toFixed(1);
        document.getElementById('rTotalWeight').textContent = seatState.occupied ? seatState.occupantWeight : '0';
        document.getElementById('rOccupancy').textContent = seatState.occupied ? 'Occupied' : 'Empty';
        document.getElementById('rAvgPress').textContent = avg;
        document.getElementById('rPeakPress').textContent = peak;

        const mc=document.getElementById('miniHeatmap'), mctx=mc.getContext('2d');
        mctx.clearRect(0,0,160,160);
        for (let y=0;y<16;y++) for (let x=0;x<16;x++) {
            const v=pressureGrid[y*16+x];
            if (v>0.01) { mctx.fillStyle=pressureColor(v); mctx.fillRect(x*10,y*10,10,10); }
        }
        if (max*100>thresholds.pressure) addAlert('warn',`Peak pressure ${peak} kPa - threshold exceeded`);
    }
    if (activeSensors.has('temperature')) {
        temperatureZones.forEach(z => { if (z.temp>thresholds.temperature) addAlert('error',`${z.name} ${z.temp.toFixed(1)}°C - overheat`); });
    }
    if (activeSensors.has('motion')) {
        document.getElementById('rVib').textContent = motionState.vibAmp.toFixed(2);
        document.getElementById('rFreq').textContent = Math.round(motionState.vibFreq);
        document.getElementById('rAX').textContent = motionState.accelX.toFixed(2)+' G';
        document.getElementById('rAY').textContent = motionState.accelY.toFixed(2)+' G';
        document.getElementById('rAZ').textContent = motionState.accelZ.toFixed(2)+' G';
        setMotionBar('barAX',motionState.accelX,2,'var(--red)');
        setMotionBar('barAY',motionState.accelY,2,'var(--green)');
        setMotionBar('barAZ',motionState.accelZ,2,'var(--blue)');
        if (motionState.vibAmp>thresholds.vibration) addAlert('warn',`Vibration ${motionState.vibAmp.toFixed(2)} G - exceeded`);
    }
    if (activeSensors.has('position')) {
        document.getElementById('rFB').textContent = Math.round(seatState.forwardBack*1.5);
        document.getElementById('rUD').textContent = Math.round(seatState.upDown*0.5);
        document.getElementById('rRec').textContent = seatState.recline+'°';
        document.getElementById('rHR').textContent = Math.round(seatState.headrest*0.8);
    }
}

function setMotionBar(id, value, maxVal, color) {
    const bar=document.getElementById(id), pct=(value/maxVal)*50;
    if (pct>=0) { bar.style.left='50%'; bar.style.width=Math.min(50,pct)+'%'; }
    else { const w=Math.min(50,Math.abs(pct)); bar.style.left=(50-w)+'%'; bar.style.width=w+'%'; }
    bar.style.background = color;
}

// ==================== Alerts ====================
let lastAlertTime = 0;
function addAlert(type, msg) {
    const now=Date.now();
    if (now-lastAlertTime<3000) return;
    if (alerts.length>0 && alerts[alerts.length-1].msg===msg) return;
    lastAlertTime = now;
    alerts.unshift({type,msg,time:new Date()});
    if (alerts.length>20) alerts.pop();
    renderAlerts();
}
function renderAlerts() {
    const el=document.getElementById('alertList');
    document.getElementById('alertCount').textContent = `(${alerts.length})`;
    if (!alerts.length) { el.innerHTML='<div style="font-size:11px;color:var(--text-tertiary);text-align:center;padding:24px;">No alerts</div>'; return; }
    el.innerHTML = alerts.slice(0,8).map(a => `
        <div class="alert-item ${a.type}">
            <span class="alert-time">${a.time.toLocaleTimeString()}</span>
            <span class="alert-msg">${a.msg}</span>
        </div>`).join('');
}

// ==================== Sensor Toggle ====================
function toggleSensor(name) {
    const el = document.querySelector(`.sensor-toggle[data-sensor="${name}"]`);
    const isActive = el.classList.toggle('active');
    el.querySelector('.toggle-icon').className = 'fas ' + (isActive ? 'fa-eye' : 'fa-eye-slash') + ' toggle-icon';
    if (isActive) activeSensors.add(name); else activeSensors.delete(name);

    if (pressureOverlayCushion) pressureOverlayCushion.visible = activeSensors.has('pressure');
    if (pressureOverlayBack) pressureOverlayBack.visible = activeSensors.has('pressure');
    document.getElementById('pressureLegend').classList.toggle('show', activeSensors.has('pressure'));
    document.getElementById('pressurePanel').style.display = activeSensors.has('pressure') ? '' : 'none';
    document.getElementById('tempPanel').style.display = activeSensors.has('temperature') ? '' : 'none';
    document.getElementById('positionPanel').style.display = activeSensors.has('position') ? '' : 'none';
    document.getElementById('posPanel').style.display = activeSensors.has('position') ? '' : 'none';
    document.getElementById('motionPanel').style.display = activeSensors.has('motion') ? '' : 'none';
    if (arrowGroup) arrowGroup.visible = activeSensors.has('motion');
    if (!activeSensors.has('temperature'))
        [cushionMesh,backrestMesh,leftBolsterMesh,rightBolsterMesh].forEach(m => { if(m){m.material.emissive=new THREE.Color(0);m.material.emissiveIntensity=0;} });
    // Update sensor count
    document.querySelector('.sensor-count').textContent = activeSensors.size + ' Sensor' + (activeSensors.size!==1?'s':'') + ' Active';
}

// ==================== Controls ====================
function toggleSimulation() {
    simulationRunning = !simulationRunning;
    document.getElementById('simDot').className = 'sim-dot '+(simulationRunning?'running':'paused');
    document.getElementById('simLabel').textContent = simulationRunning ? 'Running' : 'Paused';
    document.getElementById('simBtn').innerHTML = simulationRunning ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
}
function updateWeight(v) { seatState.occupantWeight=+v; document.getElementById('weightVal').textContent=v+' kg'; }
function updateSpeed(v) { seatState.vehicleSpeed=+v; document.getElementById('speedVal').textContent=v+' km/h'; }
function setOccupancy(type, btn) {
    btn.parentElement.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    switch(type) {
        case 'seated': seatState.occupied=true; seatState.occupantWeight=70; document.getElementById('weightSlider').value=70; updateWeight(70); break;
        case 'empty': seatState.occupied=false; break;
        case 'child': seatState.occupied=true; seatState.occupantWeight=25; document.getElementById('weightSlider').value=25; updateWeight(25); break;
        case 'heavy': seatState.occupied=true; seatState.occupantWeight=110; document.getElementById('weightSlider').value=110; updateWeight(110); break;
    }
}
function updatePosition(axis, val) {
    switch(axis) {
        case 'forwardBack': seatState.forwardBack=+val; document.getElementById('fbVal').textContent=val; break;
        case 'upDown': seatState.upDown=+val; document.getElementById('udVal').textContent=val; break;
        case 'recline': seatState.recline=+val; document.getElementById('recVal').textContent=val+'°'; break;
        case 'headrest': seatState.headrest=+val; document.getElementById('hrVal').textContent=val; break;
    }
}
const presets = {
    normal:{forwardBack:0,upDown:0,recline:18,headrest:0},
    sport:{forwardBack:30,upDown:-20,recline:12,headrest:30},
    relax:{forwardBack:-50,upDown:30,recline:38,headrest:50},
    entry:{forwardBack:-100,upDown:0,recline:18,headrest:0}
};
let animTarget = null;
function applyPreset(name, btn) {
    btn.parentElement.querySelectorAll('.preset-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    animTarget = {...presets[name]};
}
function setSeatOpacity(v) {
    document.getElementById('opVal').textContent=v+'%';
    const op=v/100;
    [cushionMesh,backrestMesh,headrestMesh,leftBolsterMesh,rightBolsterMesh].forEach(m => {
        if(!m) return; m.material.transparent=op<1; m.material.opacity=op;
    });
}
function resetCamera() { camera.position.set(1.3,0.9,1.6); controls.target.set(0,0.35,0); }
function toggleAutoRotate() { controls.autoRotate=!controls.autoRotate; controls.autoRotateSpeed=1.5; }

// ==================== Temperature UI ====================
function renderTempZones() {
    const el=document.getElementById('tempZoneList');
    el.innerHTML = temperatureZones.map((z,i) => {
        const hex = '#'+temperatureColor(z.temp).getHexString();
        return `<div class="temp-zone">
            <div class="temp-zone-info"><div class="temp-zone-dot" style="background:${hex};"></div><div><div class="temp-zone-name">${z.name}</div></div></div>
            <div style="display:flex;align-items:center;gap:6px;">
                <span class="temp-zone-value" style="color:${hex};">${z.temp.toFixed(1)}°</span>
                <button class="temp-zone-btn ${z.heating?'on':''}" onclick="toggleHeating(${i})"><i class="fas fa-fire"></i></button>
                <button class="temp-zone-btn ${z.cooling?'cool':''}" onclick="toggleCooling(${i})"><i class="fas fa-snowflake"></i></button>
            </div></div>`;
    }).join('');
}
function toggleHeating(i) { temperatureZones[i].heating=!temperatureZones[i].heating; if(temperatureZones[i].heating) temperatureZones[i].cooling=false; }
function toggleCooling(i) { temperatureZones[i].cooling=!temperatureZones[i].cooling; if(temperatureZones[i].cooling) temperatureZones[i].heating=false; }

// ==================== Export ====================
function exportJSON() {
    const data = {
        timestamp: new Date().toISOString(), system: 'KETI Smart Seat Sensor Monitor',
        seatState: {...seatState},
        pressure: { grid:Array.from(pressureGrid), avg:Array.from(pressureGrid).filter(v=>v>0.01).reduce((a,b)=>a+b,0)/Math.max(1,Array.from(pressureGrid).filter(v=>v>0.01).length)*100, peak:Math.max(...pressureGrid)*100 },
        temperature: temperatureZones.map(z=>({name:z.name,current:z.temp,target:z.target,heating:z.heating,cooling:z.cooling})),
        motion: {...motionState}
    };
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`seat-sensor-${Date.now()}.json`; a.click(); URL.revokeObjectURL(a.href);
    showToast('JSON exported');
}
function exportCSV() {
    const now=new Date().toISOString();
    let csv='timestamp,sensor_type,zone,value,unit\n';
    for (let y=0;y<16;y++) for (let x=0;x<16;x++) csv+=`${now},pressure,cushion_${x}_${y},${(pressureGrid[y*16+x]*100).toFixed(2)},kPa\n`;
    temperatureZones.forEach(z => csv+=`${now},temperature,${z.name},${z.temp.toFixed(2)},C\n`);
    csv+=`${now},motion,accel_x,${motionState.accelX.toFixed(4)},G\n`;
    csv+=`${now},motion,accel_y,${motionState.accelY.toFixed(4)},G\n`;
    csv+=`${now},motion,accel_z,${motionState.accelZ.toFixed(4)},G\n`;
    csv+=`${now},motion,vibration,${motionState.vibAmp.toFixed(4)},G\n`;
    const blob=new Blob([csv],{type:'text/csv'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`seat-sensor-${Date.now()}.csv`; a.click(); URL.revokeObjectURL(a.href);
    showToast('CSV exported');
}

// ==================== Utils ====================
let toastTimer;
function showToast(msg) { const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(toastTimer); toastTimer=setTimeout(()=>t.classList.remove('show'),2500); }
function drawLegend() { const ctx=document.getElementById('legendBar').getContext('2d'); for(let x=0;x<180;x++){ctx.fillStyle=pressureColor(x/180);ctx.fillRect(x,0,1,10);} }
function updateClock() { document.getElementById('clock').textContent=new Date().toLocaleTimeString(); }

// ==================== Animation Loop ====================
function animate() {
    requestAnimationFrame(animate);
    const dt=Math.min(clock.getDelta(),0.1), elapsed=clock.getElapsedTime();

    if (simulationRunning) { simulatePressure(elapsed); simulateTemperature(dt); simulateMotion(elapsed); }

    if (animTarget) {
        let done=true;
        ['forwardBack','upDown','recline','headrest'].forEach(k => {
            const diff=animTarget[k]-seatState[k];
            if (Math.abs(diff)>0.5) { seatState[k]+=diff*dt*3; done=false; } else seatState[k]=animTarget[k];
        });
        document.getElementById('fbSlider').value=seatState.forwardBack;
        document.getElementById('udSlider').value=seatState.upDown;
        document.getElementById('recSlider').value=seatState.recline;
        document.getElementById('hrSlider').value=seatState.headrest;
        document.getElementById('fbVal').textContent=Math.round(seatState.forwardBack);
        document.getElementById('udVal').textContent=Math.round(seatState.upDown);
        document.getElementById('recVal').textContent=Math.round(seatState.recline)+'°';
        document.getElementById('hrVal').textContent=Math.round(seatState.headrest);
        if (done) animTarget=null;
    }

    if (activeSensors.has('pressure')) { updatePressureHeatmapCushion(); updatePressureHeatmapBack(); }
    if (activeSensors.has('temperature')) updateTemperatureVisuals();
    if (activeSensors.has('position')) updateSeatPositionVisuals();
    if (activeSensors.has('motion')) updateMotionVisuals(elapsed);

    if (elapsed-lastUIUpdate>0.15) { updateDashboard(); if(activeSensors.has('temperature')) renderTempZones(); lastUIUpdate=elapsed; }

    controls.update();
    renderer.render(scene, camera);
}

// ==================== Init ====================
initScene();
drawLegend();
document.getElementById('pressureLegend').classList.add('show');
setInterval(updateClock, 1000);
updateClock();
animate();
</script>
</body>
</html>
