<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KETI — Smart Seat Sensor Monitor</title>
    <script src="libs/three.min.js"></script>
    <script src="libs/OrbitControls.js"></script>
    <script src="libs/GLTFLoader.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        :root {
            --bg: #fafafa;
            --panel: #f5f5f5;
            --card: #ffffff;
            --border: rgba(0,0,0,0.06);
            --border-strong: rgba(0,0,0,0.1);
            --text: #1a1a1a;
            --text2: #666;
            --text3: #aaa;
            --red: #d1293d;
            --blue: #3566cc;
            --green: #1a9956;
            --orange: #d48806;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter',system-ui,sans-serif; background:var(--bg); color:var(--text); overflow:hidden; -webkit-font-smoothing:antialiased; }
        .app { display:flex; flex-direction:column; height:100vh; }

        .header {
            height:44px; background:rgba(255,255,255,0.8); backdrop-filter:blur(24px); -webkit-backdrop-filter:blur(24px);
            border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between;
            padding:0 20px; flex-shrink:0; z-index:20;
        }
        .header-left { display:flex; align-items:center; gap:12px; }
        .header-left img { height:20px; opacity:0.8; }
        .h-sep { width:1px; height:16px; background:var(--border-strong); }
        .header-left h1 { font-size:13px; font-weight:500; color:var(--text2); }
        .header-center { display:flex; align-items:center; gap:14px; }
        .live { display:flex; align-items:center; gap:5px; font-size:10px; font-weight:600; color:var(--red); letter-spacing:0.5px; }
        .live-d { width:5px; height:5px; border-radius:50%; background:var(--red); animation:lp 2s ease-in-out infinite; }
        @keyframes lp { 0%,100%{opacity:1;} 50%{opacity:0.25;} }
        .s-count { font-size:10px; color:var(--text3); }
        .header-right { display:flex; align-items:center; gap:6px; }
        .clk { font-size:11px; color:var(--text3); font-variant-numeric:tabular-nums; margin-right:6px; }

        .btn {
            padding:5px 12px; border-radius:6px; border:1px solid var(--border);
            background:transparent; color:var(--text2); font-size:11px; font-weight:500; font-family:inherit;
            cursor:pointer; display:inline-flex; align-items:center; gap:4px; transition:all 0.15s;
        }
        .btn:hover { background:rgba(0,0,0,0.03); border-color:var(--border-strong); }
        .btn:active { transform:scale(0.97); }
        .btn i { font-size:10px; }

        .content { flex:1; display:flex; overflow:hidden; }

        .left-panel {
            width:256px; flex-shrink:0; background:var(--panel);
            border-right:1px solid var(--border); overflow-y:auto; display:flex; flex-direction:column;
        }
        .p-sec { padding:14px 14px 10px; }
        .p-sec + .p-sec { border-top:1px solid var(--border); }
        .sec-t { font-size:10px; font-weight:600; color:var(--text3); letter-spacing:0.3px; margin-bottom:10px; }

        .s-tog {
            display:flex; align-items:center; justify-content:space-between;
            padding:8px 10px; border-radius:8px; cursor:pointer; transition:all 0.15s; margin-bottom:2px;
        }
        .s-tog:hover { background:rgba(0,0,0,0.025); }
        .s-tog.on { background:var(--card); box-shadow:0 1px 3px rgba(0,0,0,0.05); }
        .s-info { display:flex; align-items:center; gap:8px; }
        .s-bar { width:3px; height:18px; border-radius:1.5px; }
        .s-name { font-size:12px; font-weight:500; color:var(--text); }
        .s-desc { font-size:9px; color:var(--text3); margin-top:1px; }
        .s-eye { font-size:10px; color:var(--text3); }
        .s-tog.on .s-eye { color:var(--red); }

        .cg { margin-bottom:14px; }
        .cg:last-child { margin-bottom:0; }
        .cl { display:flex; justify-content:space-between; font-size:11px; color:var(--text2); margin-bottom:6px; }
        .cv { color:var(--text); font-weight:600; font-variant-numeric:tabular-nums; }
        input[type="range"] {
            width:100%; height:3px; appearance:none; -webkit-appearance:none;
            background:#ddd; border-radius:1.5px; outline:none; cursor:pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance:none; width:16px; height:16px; border-radius:50%;
            background:#fff; cursor:pointer; box-shadow:0 1px 4px rgba(0,0,0,0.18), 0 0 0 1px rgba(0,0,0,0.04);
        }

        .pg { display:grid; grid-template-columns:1fr 1fr; gap:4px; }
        .pb {
            padding:7px; border-radius:6px; border:1px solid var(--border); background:transparent;
            color:var(--text2); font-size:11px; font-weight:500; cursor:pointer; text-align:center;
            font-family:inherit; transition:all 0.15s;
        }
        .pb:hover { background:rgba(0,0,0,0.025); }
        .pb:active { transform:scale(0.97); }
        .pb.on { background:var(--red); border-color:var(--red); color:#fff; }

        .canvas-area { flex:1; position:relative; background:#eee; }
        #canvas3d { width:100%; height:100%; display:block; }

        .legend {
            position:absolute; bottom:14px; left:50%; transform:translateX(-50%);
            background:rgba(255,255,255,0.88); backdrop-filter:blur(12px); -webkit-backdrop-filter:blur(12px);
            border:1px solid var(--border); border-radius:8px; padding:6px 12px; display:none;
            align-items:center; gap:8px; z-index:10;
        }
        .legend.show { display:flex; }
        .leg-t { font-size:9px; color:var(--text2); font-weight:600; white-space:nowrap; }
        .leg-l { display:flex; justify-content:space-between; width:160px; font-size:8px; color:var(--text3); }

        .right-panel {
            width:272px; flex-shrink:0; background:var(--panel);
            border-left:1px solid var(--border); overflow-y:auto; display:flex; flex-direction:column;
        }

        .sg { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
        .sc {
            background:var(--card); border-radius:8px; padding:12px;
            box-shadow:0 1px 2px rgba(0,0,0,0.03); border:1px solid var(--border);
        }
        .sc .v { font-size:24px; font-weight:300; font-variant-numeric:tabular-nums; letter-spacing:-0.5px; }
        .sc .l { font-size:8px; color:var(--text3); margin-top:3px; letter-spacing:0.2px; font-weight:500; }
        .sc.hi .v { color:var(--red); }
        .sc.ok .v { color:var(--green); }
        .sc.wa .v { color:var(--orange); }

        .tz {
            display:flex; align-items:center; justify-content:space-between;
            padding:8px 10px; border-radius:8px; margin-bottom:3px;
            background:var(--card); border:1px solid var(--border);
        }
        .tz-i { display:flex; align-items:center; gap:7px; }
        .tz-d { width:3px; height:14px; border-radius:1.5px; }
        .tz-n { font-size:11px; color:var(--text2); }
        .tz-v { font-size:12px; font-weight:600; font-variant-numeric:tabular-nums; }
        .tz-b {
            width:26px; height:26px; border-radius:6px; border:1px solid var(--border); background:transparent;
            color:var(--text3); font-size:10px; cursor:pointer; display:flex; align-items:center; justify-content:center;
        }
        .tz-b:hover { background:rgba(0,0,0,0.03); }
        .tz-b.hot { background:var(--red); border-color:var(--red); color:#fff; }
        .tz-b.cool { background:var(--blue); border-color:var(--blue); color:#fff; }

        .ma { margin-bottom:10px; }
        .ma-l { display:flex; justify-content:space-between; font-size:10px; color:var(--text3); margin-bottom:4px; }
        .ma-l span:last-child { font-variant-numeric:tabular-nums; color:var(--text2); font-weight:500; }
        .mb-bg { height:3px; background:#e0e0e0; border-radius:1.5px; overflow:hidden; position:relative; }
        .mb { position:absolute; top:0; height:100%; border-radius:1.5px; transition:width 0.12s, left 0.12s; }

        .al {
            display:flex; align-items:flex-start; gap:7px;
            padding:8px 10px; border-radius:8px; margin-bottom:3px;
            background:var(--card); font-size:10px; border:1px solid var(--border);
            border-left:2px solid transparent;
        }
        .al.info { border-left-color:var(--blue); }
        .al.warn { border-left-color:var(--orange); }
        .al.error { border-left-color:var(--red); }
        .al-t { color:var(--text3); font-size:9px; white-space:nowrap; font-variant-numeric:tabular-nums; }
        .al-m { color:var(--text2); line-height:1.4; }

        .sim-c {
            display:flex; align-items:center; gap:7px;
            padding:8px 10px; background:var(--card); border-radius:8px;
            border:1px solid var(--border); margin-bottom:12px;
        }
        .sim-d { width:5px; height:5px; border-radius:50%; }
        .sim-d.go { background:var(--green); animation:lp 2s ease-in-out infinite; }
        .sim-d.no { background:var(--orange); }
        .sim-l { font-size:11px; flex:1; color:var(--text2); }

        #miniHeatmap { width:100%; border-radius:8px; background:#f0f0f0; border:1px solid var(--border); }

        .toast {
            position:fixed; bottom:20px; right:20px;
            background:rgba(255,255,255,0.92); backdrop-filter:blur(16px); -webkit-backdrop-filter:blur(16px);
            border:1px solid var(--border); box-shadow:0 4px 16px rgba(0,0,0,0.06);
            border-radius:8px; padding:8px 16px; font-size:12px; color:var(--text); font-weight:500;
            z-index:100; opacity:0; transform:translateY(8px); transition:all 0.25s; pointer-events:none;
        }
        .toast.show { opacity:1; transform:translateY(0); }

        ::-webkit-scrollbar { width:4px; }
        ::-webkit-scrollbar-track { background:transparent; }
        ::-webkit-scrollbar-thumb { background:rgba(0,0,0,0.06); border-radius:2px; }

        .foot { padding:12px 14px; text-align:center; font-size:9px; color:var(--text3); border-top:1px solid var(--border); }
        .red-line { height:1px; background:linear-gradient(90deg, transparent 10%, var(--red) 50%, transparent 90%); opacity:0.18; }
    </style>
</head>
<body>
<div class="app">
    <div class="red-line"></div>
    <div class="header">
        <div class="header-left">
            <img src="keti.png" alt="KETI">
            <div class="h-sep"></div>
            <h1>Smart Seat Monitor</h1>
        </div>
        <div class="header-center">
            <div class="live"><div class="live-d"></div>LIVE</div>
            <span class="s-count" id="sCount">4 sensors</span>
        </div>
        <div class="header-right">
            <span class="clk" id="clock">00:00:00</span>
            <button class="btn" onclick="exportJSON()"><i class="fas fa-download"></i> JSON</button>
            <button class="btn" onclick="exportCSV()"><i class="fas fa-table"></i> CSV</button>
        </div>
    </div>
    <div class="content">
        <div class="left-panel">
            <div class="p-sec">
                <div class="sec-t">Sensor Layers</div>
                <div class="s-tog on" data-s="pressure" onclick="toggleSensor('pressure')">
                    <div class="s-info"><div class="s-bar" style="background:var(--red);"></div><div><div class="s-name">Pressure</div><div class="s-desc">Occupancy &amp; load</div></div></div>
                    <i class="fas fa-eye s-eye"></i>
                </div>
                <div class="s-tog" data-s="temperature" onclick="toggleSensor('temperature')">
                    <div class="s-info"><div class="s-bar" style="background:var(--orange);"></div><div><div class="s-name">Temperature</div><div class="s-desc">Heating / cooling</div></div></div>
                    <i class="fas fa-eye-slash s-eye"></i>
                </div>
                <div class="s-tog" data-s="position" onclick="toggleSensor('position')">
                    <div class="s-info"><div class="s-bar" style="background:var(--blue);"></div><div><div class="s-name">Position</div><div class="s-desc">Seat adjustment</div></div></div>
                    <i class="fas fa-eye-slash s-eye"></i>
                </div>
                <div class="s-tog" data-s="motion" onclick="toggleSensor('motion')">
                    <div class="s-info"><div class="s-bar" style="background:var(--green);"></div><div><div class="s-name">Motion</div><div class="s-desc">Accel / vibration</div></div></div>
                    <i class="fas fa-eye-slash s-eye"></i>
                </div>
            </div>
            <div class="p-sec">
                <div class="sec-t">Simulation</div>
                <div class="sim-c">
                    <div class="sim-d go" id="simDot"></div>
                    <span class="sim-l" id="simLabel">Running</span>
                    <button class="btn" id="simBtn" onclick="toggleSim()" style="padding:3px 8px;font-size:10px;"><i class="fas fa-pause"></i></button>
                </div>
                <div class="cg">
                    <div class="cl"><span>Occupant weight</span><span class="cv" id="wVal">70 kg</span></div>
                    <input type="range" min="30" max="130" value="70" id="wSlider" oninput="setWeight(this.value)">
                </div>
                <div class="cg">
                    <div class="cl"><span>Vehicle speed</span><span class="cv" id="spdVal">0 km/h</span></div>
                    <input type="range" min="0" max="200" value="0" id="spdSlider" oninput="setSpeed(this.value)">
                </div>
                <div class="cg">
                    <div class="cl"><span>Occupancy</span></div>
                    <div class="pg">
                        <button class="pb on" onclick="setOcc('seated',this)">Seated</button>
                        <button class="pb" onclick="setOcc('empty',this)">Empty</button>
                        <button class="pb" onclick="setOcc('child',this)">Child</button>
                        <button class="pb" onclick="setOcc('heavy',this)">Heavy</button>
                    </div>
                </div>
            </div>
            <div class="p-sec" id="posPanel" style="display:none;">
                <div class="sec-t">Seat position</div>
                <div class="pg" style="margin-bottom:12px;">
                    <button class="pb on" onclick="preset('normal',this)">Drive</button>
                    <button class="pb" onclick="preset('sport',this)">Sport</button>
                    <button class="pb" onclick="preset('relax',this)">Relax</button>
                    <button class="pb" onclick="preset('entry',this)">Entry</button>
                </div>
                <div class="cg"><div class="cl"><span>Fore / aft</span><span class="cv" id="fbVal">0</span></div><input type="range" min="-100" max="100" value="0" id="fbS" oninput="setPos('fb',this.value)"></div>
                <div class="cg"><div class="cl"><span>Height</span><span class="cv" id="udVal">0</span></div><input type="range" min="-50" max="50" value="0" id="udS" oninput="setPos('ud',this.value)"></div>
                <div class="cg"><div class="cl"><span>Recline</span><span class="cv" id="recVal">18°</span></div><input type="range" min="8" max="52" value="18" id="recS" oninput="setPos('rec',this.value)"></div>
                <div class="cg"><div class="cl"><span>Headrest</span><span class="cv" id="hrVal">0</span></div><input type="range" min="0" max="100" value="0" id="hrS" oninput="setPos('hr',this.value)"></div>
            </div>
            <div class="p-sec">
                <div class="sec-t">Thresholds</div>
                <div class="cg"><div class="cl"><span>Pressure alert</span><span class="cv" id="pThV">80 kPa</span></div><input type="range" min="30" max="120" value="80" oninput="TH.pressure=+this.value;$('pThV').textContent=this.value+' kPa'"></div>
                <div class="cg"><div class="cl"><span>Overheat alert</span><span class="cv" id="tThV">40°C</span></div><input type="range" min="30" max="50" value="40" oninput="TH.temperature=+this.value;$('tThV').textContent=this.value+'°C'"></div>
                <div class="cg"><div class="cl"><span>Vibration alert</span><span class="cv" id="vThV">0.7 G</span></div><input type="range" min="1" max="20" value="7" oninput="TH.vibration=this.value/10;$('vThV').textContent=(this.value/10).toFixed(1)+' G'"></div>
            </div>
            <div class="p-sec">
                <div class="sec-t">View</div>
                <div class="cg"><div class="cl"><span>Opacity</span><span class="cv" id="opVal">100%</span></div><input type="range" min="10" max="100" value="100" oninput="setOpacity(this.value)"></div>
                <div class="pg">
                    <button class="pb" onclick="resetCam()">Reset view</button>
                    <button class="pb" onclick="autoRot()">Auto rotate</button>
                </div>
            </div>
            <div class="foot">KETI — Korea Electronics Technology Institute</div>
        </div>
        <div class="canvas-area">
            <div id="canvas3d"></div>
            <div class="legend" id="pLeg">
                <span class="leg-t">Pressure (kPa)</span>
                <div><canvas id="legBar" width="160" height="8" style="border-radius:4px;"></canvas>
                <div class="leg-l"><span>0</span><span>25</span><span>50</span><span>75</span><span>100</span></div></div>
            </div>
        </div>
        <div class="right-panel">
            <div class="p-sec" id="rPress">
                <div class="sec-t">Pressure data</div>
                <div class="sg">
                    <div class="sc hi"><div class="v" id="rW">0</div><div class="l">Total load (kg)</div></div>
                    <div class="sc ok"><div class="v" id="rOcc">Empty</div><div class="l">Status</div></div>
                    <div class="sc"><div class="v" id="rAvg">0</div><div class="l">Avg pressure</div></div>
                    <div class="sc wa"><div class="v" id="rPk">0</div><div class="l">Peak pressure</div></div>
                </div>
                <div style="margin-top:10px;"><div class="cl"><span>Pressure map</span></div><canvas id="miniHeatmap" width="160" height="160"></canvas></div>
            </div>
            <div class="p-sec" id="rTemp" style="display:none;">
                <div class="sec-t">Temperature</div>
                <div id="tzList"></div>
            </div>
            <div class="p-sec" id="rPos" style="display:none;">
                <div class="sec-t">Position</div>
                <div class="sg">
                    <div class="sc"><div class="v" id="rFB">0</div><div class="l">Fore/aft (mm)</div></div>
                    <div class="sc"><div class="v" id="rUD">0</div><div class="l">Height (mm)</div></div>
                    <div class="sc"><div class="v" id="rRec">18°</div><div class="l">Recline</div></div>
                    <div class="sc"><div class="v" id="rHR">0</div><div class="l">Headrest (mm)</div></div>
                </div>
            </div>
            <div class="p-sec" id="rMot" style="display:none;">
                <div class="sec-t">Motion</div>
                <div class="sg" style="margin-bottom:10px;">
                    <div class="sc"><div class="v" id="rVib">0.0</div><div class="l">Vibration (G)</div></div>
                    <div class="sc"><div class="v" id="rFrq">0</div><div class="l">Freq (Hz)</div></div>
                </div>
                <div class="ma"><div class="ma-l"><span>X lateral</span><span id="rAX">0.00 G</span></div><div class="mb-bg"><div class="mb" id="bAX" style="background:var(--red);width:50%;left:25%;"></div></div></div>
                <div class="ma"><div class="ma-l"><span>Y vertical</span><span id="rAY">0.00 G</span></div><div class="mb-bg"><div class="mb" id="bAY" style="background:var(--green);width:50%;left:25%;"></div></div></div>
                <div class="ma"><div class="ma-l"><span>Z longitudinal</span><span id="rAZ">0.00 G</span></div><div class="mb-bg"><div class="mb" id="bAZ" style="background:var(--blue);width:50%;left:25%;"></div></div></div>
            </div>
            <div class="p-sec">
                <div class="sec-t">Alerts <span style="color:var(--text3);font-weight:400;" id="aCnt">(0)</span></div>
                <div id="aList"><div style="font-size:11px;color:var(--text3);text-align:center;padding:20px;">No alerts</div></div>
            </div>
        </div>
    </div>
</div>
<div class="toast" id="toast"></div>
<script>
const $ = id => document.getElementById(id);

// === State ===
const AS = new Set(['pressure']);
let simOn = true;
const TH = { pressure:80, temperature:40, vibration:0.7 };
const S = { occ:true, w:70, spd:0, fb:0, ud:0, rec:18, hr:0 };
const TZ = [
    {n:'L-Cushion',t:22,tgt:28,h:false,c:false}, {n:'R-Cushion',t:22,tgt:28,h:false,c:false},
    {n:'L-Back',t:22,tgt:30,h:false,c:false}, {n:'R-Back',t:22,tgt:30,h:false,c:false},
    {n:'L-Bolster',t:22,tgt:26,h:false,c:false}, {n:'R-Bolster',t:22,tgt:26,h:false,c:false}
];
const MO = { ax:0, ay:0, az:0, vib:0, freq:30 };
const PG = new Float32Array(256);
const alerts = [];

// === Three.js ===
let scene, cam, rend, ctrl;
let seatRoot; // root group for fore/aft
let baseGroup; // child of seatRoot: height adjust
let cushionMesh, lBolster, rBolster;
let backrestPivot; // group at backrest pivot point for recline
let backMesh, headMesh, lbBack, rbBack;
let pressOvCush, pressOvBack;
let pCanC, pCtxC, pTexC, pCanB, pCtxB, pTexB;
let arX, arY, arZ, arGrp;
const clk = new THREE.Clock();

// Backrest pivot Y = top of cushion, Z = back of cushion
const PIVOT_Y = 0.125, PIVOT_Z = -0.18;

function init() {
    const c = $('canvas3d');
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xeeeeee);
    scene.fog = new THREE.Fog(0xeeeeee, 5, 12);

    cam = new THREE.PerspectiveCamera(40, c.clientWidth/c.clientHeight, 0.01, 100);
    cam.position.set(1.2, 0.85, 1.5);

    rend = new THREE.WebGLRenderer({ antialias:true });
    rend.setPixelRatio(Math.min(devicePixelRatio, 2));
    rend.setSize(c.clientWidth, c.clientHeight);
    rend.shadowMap.enabled = true;
    rend.shadowMap.type = THREE.PCFSoftShadowMap;
    rend.toneMapping = THREE.ACESFilmicToneMapping;
    rend.toneMappingExposure = 1.15;
    c.appendChild(rend.domElement);

    ctrl = new THREE.OrbitControls(cam, rend.domElement);
    ctrl.enableDamping = true; ctrl.dampingFactor = 0.07;
    ctrl.target.set(0, 0.32, 0);
    ctrl.minDistance = 0.4; ctrl.maxDistance = 4;
    ctrl.maxPolarAngle = Math.PI * 0.85;

    // Lighting — clean studio
    scene.add(new THREE.AmbientLight(0xffffff, 0.7));
    const d1 = new THREE.DirectionalLight(0xffffff, 1.0);
    d1.position.set(2.5, 4, 3); d1.castShadow = true;
    d1.shadow.mapSize.set(1024, 1024); d1.shadow.bias = -0.001;
    scene.add(d1);
    scene.add(Object.assign(new THREE.DirectionalLight(0xf4f4ff, 0.45), {position: new THREE.Vector3(-3, 2, -1)}));
    scene.add(Object.assign(new THREE.DirectionalLight(0xffffff, 0.25), {position: new THREE.Vector3(0, 5, 0)}));
    // Subtle warm fill from front-below
    const warm = new THREE.PointLight(0xffe8d6, 0.12, 4);
    warm.position.set(0, -0.2, 1); scene.add(warm);

    // Grid & floor
    const gr = new THREE.GridHelper(3, 18, 0xd4d4d4, 0xe2e2e2);
    gr.material.opacity = 0.45; gr.material.transparent = true; scene.add(gr);
    const fl = new THREE.Mesh(new THREE.PlaneGeometry(6,6), new THREE.MeshStandardMaterial({color:0xe8e8e8, roughness:0.95}));
    fl.rotation.x = -Math.PI/2; fl.position.y = -0.005; fl.receiveShadow = true; scene.add(fl);

    // === Seat hierarchy ===
    // seatRoot: moves Z for fore/aft
    seatRoot = new THREE.Group(); scene.add(seatRoot);
    // baseGroup: child of seatRoot, moves Y for height
    baseGroup = new THREE.Group(); seatRoot.add(baseGroup);

    const loader = new THREE.GLTFLoader();
    loader.load('./models/car-seat.glb',
        gltf => {
            const m = gltf.scene;
            const box = new THREE.Box3().setFromObject(m);
            const sz = box.getSize(new THREE.Vector3());
            const ct = box.getCenter(new THREE.Vector3());
            const sc = 0.9/Math.max(sz.x, sz.y, sz.z);
            m.scale.set(sc,sc,sc);
            m.position.set(-ct.x*sc, -box.min.y*sc, -ct.z*sc);
            m.traverse(c => { if(c.isMesh){c.castShadow=true;c.receiveShadow=true;} });
            baseGroup.add(m);
            buildSeat();
        },
        undefined,
        () => buildSeat()
    );

    setupPressure();
    setupArrows();

    window.addEventListener('resize', () => {
        cam.aspect = c.clientWidth/c.clientHeight;
        cam.updateProjectionMatrix();
        rend.setSize(c.clientWidth, c.clientHeight);
    });
}

// === Build seat with proper hierarchy ===
function buildSeat() {
    const mat = k => new THREE.MeshStandardMaterial(k);
    const seatM = () => mat({color:0x2c2c2e, roughness:0.52, metalness:0.04});
    const frameM = mat({color:0x58585a, roughness:0.22, metalness:0.65});
    const boltM = () => mat({color:0x333335, roughness:0.48, metalness:0.04});

    // Rails (on baseGroup, don't move with fore/aft of seat itself)
    const rGeo = new THREE.BoxGeometry(0.035, 0.018, 0.48);
    [-0.15, 0.15].forEach(x => {
        const r = new THREE.Mesh(rGeo, frameM);
        r.position.set(x, 0.009, 0); r.castShadow = true;
        baseGroup.add(r);
    });

    // Cushion
    const cGeo = new THREE.BoxGeometry(0.44, 0.065, 0.44);
    cushionMesh = new THREE.Mesh(cGeo, seatM());
    cushionMesh.position.set(0, 0.085, 0);
    cushionMesh.castShadow = true; cushionMesh.receiveShadow = true;
    baseGroup.add(cushionMesh);

    // Cushion bolsters
    const cbGeo = new THREE.BoxGeometry(0.055, 0.10, 0.42);
    lBolster = new THREE.Mesh(cbGeo, boltM());
    lBolster.position.set(-0.24, 0.12, 0); lBolster.castShadow = true;
    baseGroup.add(lBolster);
    rBolster = new THREE.Mesh(cbGeo, boltM());
    rBolster.position.set(0.24, 0.12, 0); rBolster.castShadow = true;
    baseGroup.add(rBolster);

    // === Backrest pivot group ===
    // Pivot at top-rear of cushion so recline rotates naturally
    backrestPivot = new THREE.Group();
    backrestPivot.position.set(0, PIVOT_Y, PIVOT_Z);
    baseGroup.add(backrestPivot);

    // Backrest (positioned relative to pivot)
    const bGeo = new THREE.BoxGeometry(0.42, 0.54, 0.065);
    backMesh = new THREE.Mesh(bGeo, seatM());
    backMesh.position.set(0, 0.27, -0.015);
    backMesh.castShadow = true; backMesh.receiveShadow = true;
    backrestPivot.add(backMesh);

    // Back bolsters (children of pivot — follow recline)
    const bbGeo = new THREE.BoxGeometry(0.055, 0.48, 0.055);
    lbBack = new THREE.Mesh(bbGeo, boltM());
    lbBack.position.set(-0.225, 0.27, 0.01);
    backrestPivot.add(lbBack);
    rbBack = new THREE.Mesh(bbGeo, boltM());
    rbBack.position.set(0.225, 0.27, 0.01);
    backrestPivot.add(rbBack);

    // Headrest (child of pivot — follows recline)
    const hGeo = new THREE.BoxGeometry(0.21, 0.14, 0.055);
    headMesh = new THREE.Mesh(hGeo, seatM());
    headMesh.position.set(0, 0.61, -0.01); // base position relative to pivot
    headMesh.castShadow = true;
    backrestPivot.add(headMesh);

    // Set initial recline
    backrestPivot.rotation.x = -THREE.MathUtils.degToRad(S.rec);
}

// === Pressure overlays ===
function setupPressure() {
    // Cushion overlay
    pCanC = document.createElement('canvas'); pCanC.width=128; pCanC.height=128;
    pCtxC = pCanC.getContext('2d');
    pTexC = new THREE.CanvasTexture(pCanC); pTexC.minFilter = THREE.LinearFilter;
    pressOvCush = new THREE.Mesh(
        new THREE.PlaneGeometry(0.42, 0.42),
        new THREE.MeshBasicMaterial({map:pTexC, transparent:true, opacity:0.82, depthWrite:false, side:THREE.DoubleSide})
    );
    pressOvCush.rotation.x = -Math.PI/2;
    pressOvCush.position.set(0, 0.125, 0);
    baseGroup.add(pressOvCush);

    // Back overlay — child of backrestPivot so it follows recline
    pCanB = document.createElement('canvas'); pCanB.width=128; pCanB.height=128;
    pCtxB = pCanB.getContext('2d');
    pTexB = new THREE.CanvasTexture(pCanB); pTexB.minFilter = THREE.LinearFilter;
    pressOvBack = new THREE.Mesh(
        new THREE.PlaneGeometry(0.38, 0.48),
        new THREE.MeshBasicMaterial({map:pTexB, transparent:true, opacity:0.7, depthWrite:false, side:THREE.DoubleSide})
    );
    pressOvBack.position.set(0, 0.27, 0.02);
    // Will be added to backrestPivot after it's created (deferred)
    setTimeout(() => { if(backrestPivot) backrestPivot.add(pressOvBack); }, 100);
}

function setupArrows() {
    arGrp = new THREE.Group(); arGrp.visible = false;
    arX = new THREE.ArrowHelper(new THREE.Vector3(1,0,0), new THREE.Vector3(0,0.4,0.25), 0.2, 0xd1293d, 0.035, 0.02);
    arY = new THREE.ArrowHelper(new THREE.Vector3(0,1,0), new THREE.Vector3(0,0.4,0.25), 0.2, 0x1a9956, 0.035, 0.02);
    arZ = new THREE.ArrowHelper(new THREE.Vector3(0,0,1), new THREE.Vector3(0,0.4,0.25), 0.2, 0x3566cc, 0.035, 0.02);
    arGrp.add(arX, arY, arZ);
    baseGroup.add(arGrp);
}

// === Colors ===
function pColor(t) {
    t = Math.max(0, Math.min(1, t));
    let r,g,b;
    if (t<0.25) { const f=t/0.25; r=30; g=Math.round(60+f*160); b=Math.round(100+f*140); }
    else if (t<0.5) { const f=(t-0.25)/0.25; r=Math.round(30+f*190); g=Math.round(220-f*40); b=Math.round(240-f*170); }
    else if (t<0.75) { const f=(t-0.5)/0.25; r=Math.round(220+f*20); g=Math.round(180-f*100); b=Math.round(70-f*35); }
    else { const f=(t-0.75)/0.25; r=Math.round(240-f*30); g=Math.round(80-f*50); b=Math.round(35-f*10); }
    return `rgba(${r},${g},${b},${0.3+t*0.7})`;
}

function tColor(temp) {
    const t = Math.max(0, Math.min(1, (temp-15)/25));
    const c = new THREE.Color();
    if (t<0.3) c.lerpColors(new THREE.Color(0x3566cc), new THREE.Color(0xe0e0e0), t/0.3);
    else if (t<0.6) c.set(0xe0e0e0);
    else c.lerpColors(new THREE.Color(0xd48806), new THREE.Color(0xd1293d), (t-0.6)/0.4);
    return c;
}

function g2d(x,y,sx,sy){ return Math.exp(-(x*x)/(2*sx*sx)-(y*y)/(2*sy*sy)); }

// === Simulation ===
function simPress(t) {
    if (!S.occ) { PG.fill(0); return; }
    const wf = S.w/80;
    // Stable base + subtle breathing
    const breath = Math.sin(t*0.4)*0.012;
    const shift = Math.sin(t*0.065)*0.02;
    for (let y=0;y<16;y++) for (let x=0;x<16;x++) {
        const nx=(x/15)*2-1, ny=(y/15)*2-1;
        const lp = g2d(nx+0.35, ny-0.1, 0.28, 0.32);
        const rp = g2d(nx-0.35, ny-0.1, 0.28, 0.32);
        const lt = g2d(nx+0.3, ny+0.25, 0.22, 0.4)*0.35;
        const rt = g2d(nx-0.3, ny+0.25, 0.22, 0.4)*0.35;
        PG[y*16+x] = Math.max(0, Math.min(1,
            (lp+rp+lt+rt)*wf + breath + shift*nx + (Math.random()-0.5)*0.005));
    }
}

function simTemp(dt) {
    TZ.forEach(z => {
        if (z.h) z.t += (z.tgt - z.t)*dt*0.04;
        else if (z.c) z.t += (18 - z.t)*dt*0.03;
        else z.t += (22 - z.t)*dt*0.005;
        z.t = Math.max(5, Math.min(50, z.t + (Math.random()-0.5)*0.03));
    });
}

function simMotion(t) {
    const s = S.spd;
    const idle = 0.02; // base engine idle vibration
    const eFreq = 28 + s*0.25;
    const eAmp = idle + s*0.003;
    // Road noise: low-freq sway + mid-freq bumps, scales with speed
    const roadFactor = Math.min(1, s/100);
    const road = (Math.sin(t*1.8)*0.15 + Math.sin(t*4.3)*0.06)*roadFactor;
    MO.ax = Math.sin(t*0.6)*s*0.006 + (Math.random()-0.5)*0.08*roadFactor;
    MO.ay = road*0.6 + Math.sin(t*eFreq*0.08)*eAmp*0.5;
    MO.az = Math.cos(t*0.25)*s*0.003 + (Math.random()-0.5)*0.05*roadFactor;
    MO.vib = eAmp + Math.abs(road)*0.3;
    MO.freq = eFreq;
}

// === Render ===
function updPressCush() {
    const ctx=pCtxC; ctx.clearRect(0,0,128,128);
    const cw=8;
    for (let y=0;y<16;y++) for (let x=0;x<16;x++) {
        const v=PG[y*16+x];
        if (v>0.01) { ctx.fillStyle=pColor(v); ctx.beginPath(); ctx.arc(x*cw+4,y*cw+4,3.5,0,Math.PI*2); ctx.fill(); }
    }
    pTexC.needsUpdate = true;
}

function updPressBack() {
    const ctx=pCtxB; ctx.clearRect(0,0,128,128);
    if (!S.occ) { pTexB.needsUpdate=true; return; }
    const wf=S.w/80*0.4, cw=128/12, ch=8;
    for (let y=0;y<16;y++) for (let x=0;x<12;x++) {
        const nx=(x/11)*2-1, ny=(y/15)*2-1;
        const v=(g2d(nx+0.3,ny+0.1,0.4,0.35)+g2d(nx-0.3,ny+0.1,0.4,0.35))*wf;
        if (v>0.01) { ctx.fillStyle=pColor(v); ctx.beginPath(); ctx.arc(x*cw+cw/2,y*ch+4,3.5,0,Math.PI*2); ctx.fill(); }
    }
    pTexB.needsUpdate = true;
}

function updTempVis() {
    const meshes = [cushionMesh,cushionMesh,backMesh,backMesh,lBolster,rBolster];
    TZ.forEach((z,i) => {
        const m=meshes[i]; if(!m) return;
        m.material.emissive = tColor(z.t);
        m.material.emissiveIntensity = (z.h||z.c) ? 0.35 : 0.08;
    });
}

function updPosVis() {
    // Fore/aft: move seatRoot Z (rails stay, seat slides)
    seatRoot.position.z = S.fb/100*0.12;
    // Height: move baseGroup Y
    baseGroup.position.y = S.ud/50*0.03;
    // Recline: rotate backrestPivot
    if (backrestPivot) backrestPivot.rotation.x = -THREE.MathUtils.degToRad(S.rec);
    // Headrest extend: move headMesh local Y
    if (headMesh) headMesh.position.y = 0.61 + S.hr/100*0.08;
}

function updMotVis(t) {
    if (!arGrp.visible) return;
    const s = 0.25;
    arX.setLength(Math.max(0.04, Math.abs(MO.ax)*s), 0.035, 0.02);
    arX.setDirection(new THREE.Vector3(Math.sign(MO.ax)||1,0,0).normalize());
    arY.setLength(Math.max(0.04, Math.abs(MO.ay)*s), 0.035, 0.02);
    arY.setDirection(new THREE.Vector3(0,Math.sign(MO.ay)||1,0).normalize());
    arZ.setLength(Math.max(0.04, Math.abs(MO.az)*s), 0.035, 0.02);
    arZ.setDirection(new THREE.Vector3(0,0,Math.sign(MO.az)||1).normalize());
    // Vibration — subtle shake
    if (MO.vib > 0.005) {
        const v = MO.vib * 0.0015;
        baseGroup.rotation.z = Math.sin(t*MO.freq*0.25)*v;
        baseGroup.position.y = (S.ud/50*0.03) + Math.sin(t*MO.freq*0.4)*v*1.5;
    }
}

// === UI ===
let lastUI = 0;
function updDash() {
    if (AS.has('pressure')) {
        let sum=0,mx=0,cnt=0;
        for (let i=0;i<256;i++) if(PG[i]>0.01){sum+=PG[i];cnt++;mx=Math.max(mx,PG[i]);}
        const avg=cnt>0?(sum/cnt*100).toFixed(1):'0', pk=(mx*100).toFixed(1);
        $('rW').textContent = S.occ ? S.w : '0';
        $('rOcc').textContent = S.occ ? 'Occupied' : 'Empty';
        $('rAvg').textContent = avg; $('rPk').textContent = pk;
        const mc=$('miniHeatmap'), mctx=mc.getContext('2d');
        mctx.clearRect(0,0,160,160);
        for (let y=0;y<16;y++) for (let x=0;x<16;x++) {
            const v=PG[y*16+x];
            if(v>0.01){mctx.fillStyle=pColor(v);mctx.fillRect(x*10,y*10,10,10);}
        }
        if (mx*100>TH.pressure) addAlert('warn','Peak pressure '+pk+' kPa — threshold');
    }
    if (AS.has('temperature')) TZ.forEach(z=>{ if(z.t>TH.temperature) addAlert('error',z.n+' '+z.t.toFixed(1)+'°C — overheat'); });
    if (AS.has('motion')) {
        $('rVib').textContent=MO.vib.toFixed(2); $('rFrq').textContent=Math.round(MO.freq);
        $('rAX').textContent=MO.ax.toFixed(2)+' G'; $('rAY').textContent=MO.ay.toFixed(2)+' G'; $('rAZ').textContent=MO.az.toFixed(2)+' G';
        mBar('bAX',MO.ax,2); mBar('bAY',MO.ay,2); mBar('bAZ',MO.az,2);
        if (MO.vib>TH.vibration) addAlert('warn','Vibration '+MO.vib.toFixed(2)+' G');
    }
    if (AS.has('position')) {
        $('rFB').textContent=Math.round(S.fb*1.5); $('rUD').textContent=Math.round(S.ud*0.6);
        $('rRec').textContent=S.rec+'°'; $('rHR').textContent=Math.round(S.hr*0.8);
    }
}

function mBar(id,v,mx) {
    const b=$(id), p=(v/mx)*50;
    if(p>=0){b.style.left='50%';b.style.width=Math.min(50,p)+'%';}
    else{const w=Math.min(50,Math.abs(p));b.style.left=(50-w)+'%';b.style.width=w+'%';}
}

// === Alerts ===
let lastAT=0;
function addAlert(tp,msg) {
    const n=Date.now(); if(n-lastAT<3500)return; if(alerts.length&&alerts[0].msg===msg)return;
    lastAT=n; alerts.unshift({tp,msg,time:new Date()}); if(alerts.length>15)alerts.pop(); rendAlerts();
}
function rendAlerts() {
    $('aCnt').textContent='('+alerts.length+')';
    if(!alerts.length){$('aList').innerHTML='<div style="font-size:11px;color:var(--text3);text-align:center;padding:20px;">No alerts</div>';return;}
    $('aList').innerHTML=alerts.slice(0,6).map(a=>'<div class="al '+a.tp+'"><span class="al-t">'+a.time.toLocaleTimeString()+'</span><span class="al-m">'+a.msg+'</span></div>').join('');
}

// === Sensor toggle ===
function toggleSensor(n) {
    const el=document.querySelector('.s-tog[data-s="'+n+'"]');
    const on=el.classList.toggle('on');
    el.querySelector('.s-eye').className='fas '+(on?'fa-eye':'fa-eye-slash')+' s-eye';
    if(on)AS.add(n);else AS.delete(n);

    if(pressOvCush)pressOvCush.visible=AS.has('pressure');
    if(pressOvBack)pressOvBack.visible=AS.has('pressure');
    $('pLeg').classList.toggle('show',AS.has('pressure'));
    $('rPress').style.display=AS.has('pressure')?'':'none';
    $('rTemp').style.display=AS.has('temperature')?'':'none';
    $('posPanel').style.display=AS.has('position')?'':'none';
    $('rPos').style.display=AS.has('position')?'':'none';
    $('rMot').style.display=AS.has('motion')?'':'none';
    if(arGrp)arGrp.visible=AS.has('motion');
    if(!AS.has('temperature'))[cushionMesh,backMesh,lBolster,rBolster].forEach(m=>{if(m){m.material.emissive=new THREE.Color(0);m.material.emissiveIntensity=0;}});
    $('sCount').textContent=AS.size+' sensor'+(AS.size!==1?'s':'');
}

// === Controls ===
function toggleSim() {
    simOn=!simOn;
    $('simDot').className='sim-d '+(simOn?'go':'no');
    $('simLabel').textContent=simOn?'Running':'Paused';
    $('simBtn').innerHTML=simOn?'<i class="fas fa-pause"></i>':'<i class="fas fa-play"></i>';
}
function setWeight(v){S.w=+v;$('wVal').textContent=v+' kg';}
function setSpeed(v){S.spd=+v;$('spdVal').textContent=v+' km/h';}
function setOcc(t,btn) {
    btn.parentElement.querySelectorAll('.pb').forEach(b=>b.classList.remove('on')); btn.classList.add('on');
    switch(t){
        case'seated':S.occ=true;S.w=70;$('wSlider').value=70;setWeight(70);break;
        case'empty':S.occ=false;break;
        case'child':S.occ=true;S.w=25;$('wSlider').value=25;setWeight(25);break;
        case'heavy':S.occ=true;S.w=110;$('wSlider').value=110;setWeight(110);break;
    }
}
function setPos(axis,v) {
    switch(axis){
        case'fb':S.fb=+v;$('fbVal').textContent=v;break;
        case'ud':S.ud=+v;$('udVal').textContent=v;break;
        case'rec':S.rec=+v;$('recVal').textContent=v+'°';break;
        case'hr':S.hr=+v;$('hrVal').textContent=v;break;
    }
}

// Presets — realistic values
const presets_data = {
    normal: {fb:0, ud:0, rec:18, hr:0},
    sport:  {fb:20, ud:-15, rec:12, hr:20},
    relax:  {fb:-40, ud:10, rec:42, hr:65},
    entry:  {fb:-80, ud:-10, rec:18, hr:0}
};
let animTgt = null;
function preset(n,btn) {
    btn.parentElement.querySelectorAll('.pb').forEach(b=>b.classList.remove('on')); btn.classList.add('on');
    animTgt = {...presets_data[n]};
}
function setOpacity(v) {
    $('opVal').textContent=v+'%'; const op=v/100;
    [cushionMesh,backMesh,headMesh,lBolster,rBolster,lbBack,rbBack].forEach(m=>{
        if(!m)return; m.material.transparent=op<1; m.material.opacity=op;
    });
}
function resetCam(){cam.position.set(1.2,0.85,1.5);ctrl.target.set(0,0.32,0);}
function autoRot(){ctrl.autoRotate=!ctrl.autoRotate;ctrl.autoRotateSpeed=1.5;}

// === Temperature UI ===
function rendTZ() {
    $('tzList').innerHTML=TZ.map((z,i)=>{
        const hex='#'+tColor(z.t).getHexString();
        return '<div class="tz"><div class="tz-i"><div class="tz-d" style="background:'+hex+';"></div><span class="tz-n">'+z.n+'</span></div>'+
        '<div style="display:flex;align-items:center;gap:5px;"><span class="tz-v" style="color:'+hex+';">'+z.t.toFixed(1)+'°</span>'+
        '<button class="tz-b '+(z.h?'hot':'')+'" onclick="togH('+i+')"><i class="fas fa-fire"></i></button>'+
        '<button class="tz-b '+(z.c?'cool':'')+'" onclick="togC('+i+')"><i class="fas fa-snowflake"></i></button></div></div>';
    }).join('');
}
function togH(i){TZ[i].h=!TZ[i].h;if(TZ[i].h)TZ[i].c=false;}
function togC(i){TZ[i].c=!TZ[i].c;if(TZ[i].c)TZ[i].h=false;}

// === Export ===
function exportJSON() {
    const d={timestamp:new Date().toISOString(),system:'KETI Smart Seat Monitor',
        seat:{occupied:S.occ,weight:S.w,speed:S.spd,fb:S.fb,ud:S.ud,recline:S.rec,headrest:S.hr},
        pressure:{grid:Array.from(PG),avg:Array.from(PG).filter(v=>v>0.01).reduce((a,b)=>a+b,0)/Math.max(1,Array.from(PG).filter(v=>v>0.01).length)*100,peak:Math.max(...PG)*100},
        temperature:TZ.map(z=>({name:z.n,current:z.t,target:z.tgt,heating:z.h,cooling:z.c})),
        motion:{...MO}};
    const bl=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(bl);a.download='seat-'+Date.now()+'.json';a.click();URL.revokeObjectURL(a.href);
    toast('JSON exported');
}
function exportCSV() {
    const now=new Date().toISOString(); let csv='timestamp,type,zone,value,unit\n';
    for(let y=0;y<16;y++)for(let x=0;x<16;x++)csv+=now+',pressure,cushion_'+x+'_'+y+','+(PG[y*16+x]*100).toFixed(2)+',kPa\n';
    TZ.forEach(z=>csv+=now+',temperature,'+z.n+','+z.t.toFixed(2)+',C\n');
    csv+=now+',motion,accel_x,'+MO.ax.toFixed(4)+',G\n';
    csv+=now+',motion,accel_y,'+MO.ay.toFixed(4)+',G\n';
    csv+=now+',motion,accel_z,'+MO.az.toFixed(4)+',G\n';
    const bl=new Blob([csv],{type:'text/csv'});
    const a=document.createElement('a');a.href=URL.createObjectURL(bl);a.download='seat-'+Date.now()+'.csv';a.click();URL.revokeObjectURL(a.href);
    toast('CSV exported');
}

// === Utils ===
let toastTm;
function toast(msg){const t=$('toast');t.textContent=msg;t.classList.add('show');clearTimeout(toastTm);toastTm=setTimeout(()=>t.classList.remove('show'),2200);}
function drawLeg(){const ctx=$('legBar').getContext('2d');for(let x=0;x<160;x++){ctx.fillStyle=pColor(x/160);ctx.fillRect(x,0,1,8);}}
function updClk(){$('clock').textContent=new Date().toLocaleTimeString();}

// === Animation loop ===
function animate() {
    requestAnimationFrame(animate);
    const dt=Math.min(clk.getDelta(),0.1), el=clk.getElapsedTime();

    if(simOn){simPress(el);simTemp(dt);simMotion(el);}

    // Smooth preset animation with per-axis speeds
    if(animTgt) {
        let done=true;
        const speeds = {fb:2.5, ud:3, rec:2.2, hr:3.5};
        ['fb','ud','rec','hr'].forEach(k=>{
            const diff=animTgt[k]-S[k];
            if(Math.abs(diff)>0.3){S[k]+=diff*dt*speeds[k];done=false;}else S[k]=animTgt[k];
        });
        $('fbS').value=S.fb; $('udS').value=S.ud; $('recS').value=S.rec; $('hrS').value=S.hr;
        $('fbVal').textContent=Math.round(S.fb); $('udVal').textContent=Math.round(S.ud);
        $('recVal').textContent=Math.round(S.rec)+'°'; $('hrVal').textContent=Math.round(S.hr);
        if(done)animTgt=null;
    }

    if(AS.has('pressure')){updPressCush();updPressBack();}
    if(AS.has('temperature'))updTempVis();
    if(AS.has('position'))updPosVis();
    if(AS.has('motion'))updMotVis(el);

    if(el-lastUI>0.16){updDash();if(AS.has('temperature'))rendTZ();lastUI=el;}

    ctrl.update();
    rend.render(scene,cam);
}

// === Init ===
init();
drawLeg();
$('pLeg').classList.add('show');
setInterval(updClk,1000); updClk();
animate();
</script>
</body>
</html>
