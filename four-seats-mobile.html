<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>KETI — Smart Seat Mobile</title>
<script src="libs/three.min.js"></script>
<script src="libs/OrbitControls.js"></script>
<script src="libs/GLTFLoader.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{
    --bg:#f5f5f7;--surface:rgba(255,255,255,.82);--card:#fff;
    --border:rgba(0,0,0,.06);--text:#1d1d1f;--text2:#6e6e73;--text3:#aeaeb2;
    --accent:#007aff;--dim:rgba(0,122,255,.1);
    --scene:#f0f0f2;
    --thumb-size:24px;
    --green:#34c759;--red:#ff3b30;--orange:#ff9f0a;--purple:#af52de;--cyan:#64d2ff;--pink:#ff6482;--teal:#30b0c7;
    --sai-top:env(safe-area-inset-top, 0px);
    --sai-bottom:env(safe-area-inset-bottom, 0px);
    --sai-left:env(safe-area-inset-left, 0px);
    --sai-right:env(safe-area-inset-right, 0px);
}
html{height:100%;overflow:hidden}
body{
    font-family:'Inter',-apple-system,sans-serif;
    background:var(--bg);color:var(--text);
    -webkit-font-smoothing:antialiased;
    touch-action:manipulation;
    position:fixed;width:100%;height:100dvh;
    overflow:hidden;
    padding-top:var(--sai-top);
    padding-left:var(--sai-left);
    padding-right:var(--sai-right);
}

/* ── TOP BAR (44px) ── */
.top-bar{
    height:44px;flex-shrink:0;
    background:var(--card);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
    border-bottom:1px solid var(--border);
    display:flex;align-items:center;
    padding:0 12px;z-index:20;position:relative;
}
.top-bar img{height:20px;opacity:.85}
.top-bar h1{font-size:14px;font-weight:600;letter-spacing:-.3px;margin-left:8px}

/* ── 3D CANVAS AREA ── */
.canvas-area{
    position:relative;flex:1 1 55%;min-height:0;
    background:var(--scene);
}
#c3d{width:100%;height:100%}

/* ── SEAT PILLS (floating overlay) ── */
.seat-pills-wrap{
    position:absolute;top:8px;left:50%;transform:translateX(-50%);
    z-index:10;
    background:rgba(255,255,255,.65);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
    border-radius:12px;padding:3px;
    display:flex;gap:0;
    overflow-x:auto;-webkit-overflow-scrolling:touch;
    max-width:calc(100% - 24px);
}
.seat-pill{
    padding:7px 14px;border-radius:9px;border:none;
    background:transparent;color:rgba(0,0,0,.45);
    font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;
    transition:all .2s;display:flex;align-items:center;gap:5px;
    white-space:nowrap;min-height:44px;
}
.seat-pill:hover{color:var(--text)}
.seat-pill.sel{background:rgba(255,255,255,.85);color:#1d1d1f;box-shadow:0 1px 4px rgba(0,0,0,.08)}
.seat-pill .dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}

/* ── PRESSURE LEGEND (floating bottom-left of canvas) ── */
.legend{
    position:absolute;bottom:12px;left:12px;
    background:rgba(255,255,255,.7);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
    border-radius:10px;padding:5px 10px;
    display:flex;align-items:center;gap:6px;z-index:10;
}
.legend .lt{font-size:8px;color:var(--text2);font-weight:600}
.legend .ll{display:flex;justify-content:space-between;width:100px;font-size:6px;color:var(--text3);font-weight:500}

/* ── BOTTOM SHEET ── */
.bottom-sheet{
    position:relative;flex-shrink:0;
    background:var(--bg);
    border-top:1px solid var(--border);
    border-radius:16px 16px 0 0;
    z-index:15;
    display:flex;flex-direction:column;
    transition:height .35s cubic-bezier(.32,.72,0,1);
    will-change:height;
    padding-bottom:var(--sai-bottom);
}
.bottom-sheet.collapsed{height:56px !important;overflow:hidden}
.drag-handle{
    width:100%;padding:8px 0 4px;display:flex;flex-direction:column;align-items:center;
    cursor:grab;flex-shrink:0;min-height:44px;justify-content:flex-start;
}
.drag-bar{width:36px;height:4px;border-radius:2px;background:rgba(0,0,0,.12)}
.drag-label{
    font-size:11px;font-weight:600;color:var(--text2);margin-top:4px;
    display:flex;align-items:center;gap:6px;
}
.drag-label .dot{width:7px;height:7px;border-radius:50%}

.sheet-scroll{
    flex:1;overflow-y:auto;overflow-x:hidden;
    -webkit-overflow-scrolling:touch;
    padding:0 14px 16px;
}
.sheet-scroll::-webkit-scrollbar{width:2px}
.sheet-scroll::-webkit-scrollbar-thumb{background:rgba(0,0,0,.06);border-radius:1px}

/* ── SECTIONS ── */
.sec{margin-bottom:12px}
.sec-t{
    font-size:9px;font-weight:600;color:var(--text3);text-transform:uppercase;
    letter-spacing:.8px;margin-bottom:8px;display:flex;align-items:center;gap:5px;
}
.sec-t i{font-size:8px}
.sec-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}

/* Slider group card */
.slider-group{
    background:var(--card);border-radius:12px;border:1px solid var(--border);
    padding:10px 12px;margin-bottom:6px;
}
.slider-group:last-child{margin-bottom:0}
.sg-title{font-size:8px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.6px;margin-bottom:8px}

.ctrl{margin-bottom:8px}
.ctrl:last-child{margin-bottom:0}
.ctrl-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.ctrl-label{font-size:11px;color:var(--text2);font-weight:500;display:flex;align-items:center;gap:6px}
.ctrl-label i{width:14px;text-align:center;font-size:11px}
.ctrl-val{font-size:11px;font-weight:700;font-variant-numeric:tabular-nums;min-width:36px;text-align:right}

/* Styled range slider — large mobile thumbs */
input[type=range]{
    width:100%;height:6px;appearance:none;-webkit-appearance:none;
    background:#e5e5ea;border-radius:3px;outline:none;cursor:pointer;
}
input[type=range]::-webkit-slider-thumb{
    -webkit-appearance:none;width:var(--thumb-size);height:var(--thumb-size);
    border-radius:50%;background:white;cursor:pointer;
    box-shadow:0 1px 6px rgba(0,0,0,.25),0 0 0 1px rgba(0,0,0,.06);
}
input[type=range]::-moz-range-thumb{
    width:var(--thumb-size);height:var(--thumb-size);border-radius:50%;
    background:white;cursor:pointer;border:none;
    box-shadow:0 1px 6px rgba(0,0,0,.25),0 0 0 1px rgba(0,0,0,.06);
}

/* Preset + Weight row */
.preset-weight{display:flex;gap:8px;align-items:flex-start}
.preset-col{flex:1}
.weight-col{width:80px;flex-shrink:0}
.g6{display:grid;grid-template-columns:repeat(3,1fr);gap:5px}
.pb{
    padding:8px 4px;border-radius:10px;border:none;
    background:rgba(0,0,0,.03);color:#3a3a3c;
    font-size:10px;font-weight:600;cursor:pointer;text-align:center;
    transition:all .15s;font-family:inherit;
    min-height:44px;display:flex;align-items:center;justify-content:center;
}
.pb:hover{opacity:.8}.pb.on{background:var(--accent);color:white}

/* Reset button */
.btn-reset{
    padding:5px 10px;border-radius:8px;border:none;
    background:rgba(255,59,48,.1);color:var(--red);
    font-size:10px;font-weight:600;cursor:pointer;font-family:inherit;
    display:inline-flex;align-items:center;gap:4px;
    min-height:44px;min-width:44px;justify-content:center;
}

/* Tabs */
.tab-bar{display:flex;gap:0;background:rgba(0,0,0,.04);border-radius:10px;padding:2px;margin-bottom:8px}
.tab-btn{
    flex:1;padding:8px 0;border-radius:8px;border:none;
    background:transparent;color:var(--text2);font-size:11px;font-weight:600;
    cursor:pointer;font-family:inherit;transition:all .2s;min-height:44px;
}
.tab-btn.sel{background:var(--card);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,.06)}
.tab-content{display:none}.tab-content.vis{display:block}

/* Stats */
.sg{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.st{background:var(--card);border-radius:10px;padding:10px;border:1px solid var(--border)}
.st .v{font-size:18px;font-weight:700;font-variant-numeric:tabular-nums;letter-spacing:-.3px}
.st .l{font-size:8px;color:var(--text3);margin-top:2px;text-transform:uppercase;letter-spacing:.3px;font-weight:600}

.bone-vis{background:var(--card);border-radius:12px;border:1px solid var(--border);padding:10px}
.bone-vis canvas{display:block;margin:0 auto}
.bone-info{font-size:9px;color:var(--text2);text-align:center;margin-top:6px;font-weight:500}
#miniHeat{width:100%;border-radius:10px;border:1px solid var(--border);background:var(--bg)}

/* Loading */
.loading{
    position:fixed;inset:0;background:rgba(255,255,255,.92);
    backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    z-index:100;transition:opacity .5s;
}
.loading.done{opacity:0;pointer-events:none}
.spinner{width:32px;height:32px;border:2.5px solid rgba(0,0,0,.06);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.load-msg{margin-top:12px;font-size:13px;color:var(--text2);font-weight:500}
.toast{
    position:fixed;bottom:calc(16px + var(--sai-bottom));left:50%;transform:translateX(-50%) translateY(8px);
    background:var(--card);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
    border:1px solid var(--border);border-radius:12px;padding:10px 20px;
    font-size:12px;color:var(--text);font-weight:500;z-index:50;
    opacity:0;transition:all .25s;pointer-events:none;white-space:nowrap;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* App layout */
.app{display:flex;flex-direction:column;height:100dvh;overflow:hidden}
</style>
</head>
<body>
<div class="app">
    <!-- TOP BAR -->
    <div class="top-bar">
        <img src="keti.png" alt="KETI">
        <h1>Smart Seat</h1>
    </div>

    <!-- 3D CANVAS AREA -->
    <div class="canvas-area">
        <div id="c3d"></div>
        <!-- Seat pills overlay -->
        <div class="seat-pills-wrap" id="seatPills">
            <button class="seat-pill sel" onclick="sel(0)"><span class="dot" style="background:#007aff"></span>FL</button>
            <button class="seat-pill" onclick="sel(1)"><span class="dot" style="background:#34c759"></span>FR</button>
            <button class="seat-pill" onclick="sel(2)"><span class="dot" style="background:#ff9f0a"></span>RL</button>
            <button class="seat-pill" onclick="sel(3)"><span class="dot" style="background:#af52de"></span>RR</button>
        </div>
        <!-- Pressure legend -->
        <div class="legend">
            <span class="lt">Pressure</span>
            <div><canvas id="legCv" width="100" height="8" style="border-radius:4px;display:block"></canvas>
            <div class="ll"><span>0</span><span>50</span><span>100 kPa</span></div></div>
        </div>
    </div>

    <!-- BOTTOM SHEET -->
    <div class="bottom-sheet" id="bottomSheet" style="height:45%">
        <div class="drag-handle" id="dragHandle">
            <div class="drag-bar"></div>
            <div class="drag-label">
                <span class="dot" id="sheetDot" style="background:#007aff"></span>
                <span id="sheetLabel">FL Driver</span>
                <i class="fas fa-chevron-up" id="sheetChev" style="font-size:9px;margin-left:2px"></i>
            </div>
        </div>
        <div class="sheet-scroll" id="sheetScroll">
            <!-- Position -->
            <div class="sec">
                <div class="sec-head">
                    <div class="sec-t" style="margin-bottom:0"><i class="fas fa-arrows-alt"></i> Position</div>
                    <button class="btn-reset" onclick="resetPose()"><i class="fas fa-undo"></i> Reset</button>
                </div>
                <div class="slider-group">
                    <div class="sg-title">Base</div>
                    <div class="ctrl"><div class="ctrl-row"><span class="ctrl-label"><i class="fas fa-arrows-alt-h" style="color:var(--accent)"></i> Fore / Aft</span><span class="ctrl-val" id="vSlide">0</span></div><input type="range" min="-100" max="100" value="0" id="sSlide" oninput="setPose('slide',+this.value)"></div>
                    <div class="ctrl"><div class="ctrl-row"><span class="ctrl-label"><i class="fas fa-arrows-alt-v" style="color:var(--green)"></i> Height</span><span class="ctrl-val" id="vHeight">0</span></div><input type="range" min="0" max="100" value="0" id="sHeight" oninput="setPose('height',+this.value)"></div>
                    <div class="ctrl"><div class="ctrl-row"><span class="ctrl-label"><i class="fas fa-angle-double-down" style="color:var(--orange)"></i> Seat Tilt</span><span class="ctrl-val" id="vTilt">0°</span></div><input type="range" min="-10" max="10" value="0" id="sTilt" oninput="setPose('tilt',+this.value)"></div>
                </div>
                <div class="slider-group">
                    <div class="sg-title">Back</div>
                    <div class="ctrl"><div class="ctrl-row"><span class="ctrl-label"><i class="fas fa-couch" style="color:var(--purple)"></i> Recline</span><span class="ctrl-val" id="vRecline">0°</span></div><input type="range" min="0" max="40" value="0" id="sRecline" oninput="setPose('recline',+this.value)"></div>
                    <div class="ctrl"><div class="ctrl-row"><span class="ctrl-label"><i class="fas fa-arrow-up" style="color:var(--pink)"></i> Headrest</span><span class="ctrl-val" id="vHrH">0</span></div><input type="range" min="0" max="100" value="0" id="sHrH" oninput="setPose('hrH',+this.value)"></div>
                    <div class="ctrl"><div class="ctrl-row"><span class="ctrl-label"><i class="fas fa-redo" style="color:var(--cyan)"></i> Headrest Tilt</span><span class="ctrl-val" id="vHrT">0°</span></div><input type="range" min="-15" max="15" value="0" id="sHrT" oninput="setPose('hrT',+this.value)"></div>
                </div>
            </div>

            <!-- Support -->
            <div class="sec">
                <div class="sec-t"><i class="fas fa-compress-arrows-alt"></i> Support</div>
                <div class="slider-group">
                    <div class="ctrl"><div class="ctrl-row"><span class="ctrl-label"><i class="fas fa-compress-alt" style="color:var(--teal)"></i> Seat Bolster</span><span class="ctrl-val" id="vBol">0%</span></div><input type="range" min="0" max="100" value="0" id="sBol" oninput="setPose('bolster',+this.value)"></div>
                    <div class="ctrl"><div class="ctrl-row"><span class="ctrl-label"><i class="fas fa-hand-point-up" style="color:var(--red)"></i> Lumbar</span><span class="ctrl-val" id="vLum">0%</span></div><input type="range" min="0" max="100" value="0" id="sLum" oninput="setPose('lumbar',+this.value)"></div>
                    <div class="ctrl"><div class="ctrl-row"><span class="ctrl-label"><i class="fas fa-shield-alt" style="color:var(--purple)"></i> Back Bolster</span><span class="ctrl-val" id="vBBol">0%</span></div><input type="range" min="0" max="100" value="0" id="sBBol" oninput="setPose('bBolster',+this.value)"></div>
                </div>
            </div>

            <!-- Presets + Weight -->
            <div class="sec">
                <div class="sec-t"><i class="fas fa-bookmark"></i> Presets & Weight</div>
                <div class="preset-weight">
                    <div class="preset-col">
                        <div class="g6" id="presetBtns">
                            <button class="pb" onclick="goPreset('drive',this)">Drive</button>
                            <button class="pb" onclick="goPreset('sport',this)">Sport</button>
                            <button class="pb" onclick="goPreset('relax',this)">Relax</button>
                            <button class="pb" onclick="goPreset('entry',this)">Entry</button>
                            <button class="pb" onclick="goPreset('flat',this)">Flat</button>
                            <button class="pb" onclick="goPreset('hold',this)">Hold</button>
                        </div>
                    </div>
                    <div class="weight-col">
                        <div style="font-size:10px;color:var(--text2);font-weight:600;text-align:center;margin-bottom:4px"><i class="fas fa-weight-hanging"></i> <span id="wVal">75 kg</span></div>
                        <input type="range" min="0" max="130" value="75" id="wSl" oninput="setWt(+this.value)" style="width:100%">
                    </div>
                </div>
            </div>

            <!-- Analysis (Tabbed) -->
            <div class="sec">
                <div class="sec-t"><i class="fas fa-chart-area"></i> Analysis</div>
                <div class="tab-bar">
                    <button class="tab-btn sel" onclick="switchTab('diagram',this)">Diagram</button>
                    <button class="tab-btn" onclick="switchTab('pressure',this)">Pressure</button>
                </div>
                <div class="tab-content vis" id="tab-diagram">
                    <div class="bone-vis"><canvas id="boneCv" width="270" height="150"></canvas></div>
                    <div class="bone-info" id="boneInfo">10 bones · 9 axes · v2 GLB</div>
                </div>
                <div class="tab-content" id="tab-pressure">
                    <div class="sg" style="margin-bottom:6px">
                        <div class="st"><div class="v" id="pAvg">0</div><div class="l">Avg kPa</div></div>
                        <div class="st"><div class="v" style="color:var(--orange)" id="pPeak">0</div><div class="l">Peak kPa</div></div>
                    </div>
                    <canvas id="miniHeat" width="160" height="160"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="loading" id="loader"><div class="spinner"></div><div class="load-msg" id="lmsg">Loading 3D models...</div></div>
<div class="toast" id="toast"></div>

<script>
/* ═══════════════════════════════════════════
   CONFIG
   ═══════════════════════════════════════════ */
const SEATS=[
    {id:0,name:'Driver',label:'FL',pos:[-0.45,0,-0.55],weight:75},
    {id:1,name:'Passenger',label:'FR',pos:[0.45,0,-0.55],weight:65},
    {id:2,name:'Rear Left',label:'RL',pos:[-0.45,0,0.55],weight:55},
    {id:3,name:'Rear Right',label:'RR',pos:[0.45,0,0.55],weight:80},
];
const COL=['#007aff','#34c759','#ff9f0a','#af52de'];
const AXES=['slide','height','tilt','recline','hrH','hrT','bolster','lumbar','bBolster'];
const PRESETS={
    drive:  {slide:0,  height:20,tilt:2,  recline:8, hrH:30, hrT:-5, bolster:20, lumbar:40, bBolster:15},
    sport:  {slide:30, height:0, tilt:-3, recline:3, hrH:50, hrT:-8, bolster:80, lumbar:60, bBolster:70},
    relax:  {slide:-40,height:40,tilt:5,  recline:35,hrH:60, hrT:10, bolster:10, lumbar:50, bBolster:10},
    entry:  {slide:-80,height:0, tilt:0,  recline:0, hrH:0,  hrT:0,  bolster:0,  lumbar:0,  bBolster:0},
    flat:   {slide:0,  height:50,tilt:8,  recline:40,hrH:100,hrT:15, bolster:0,  lumbar:30, bBolster:0},
    hold:   {slide:10, height:10,tilt:-2, recline:5, hrH:40, hrT:-3, bolster:90, lumbar:70, bBolster:85},
};
const ZERO={slide:0,height:0,tilt:0,recline:0,hrH:0,hrT:0,bolster:0,lumbar:0,bBolster:0};

const seats=SEATS.map(s=>({
    ...s, model:null, hl:null, bones:{}, rest:{},
    p:{...ZERO}, target:null,
    grid:new Float32Array(256), avg:0, peak:0,
    hmC:null, hmB:null,
}));

let cur=0;
let scene,camera,renderer,controls;
const clock=new THREE.Clock();

/* ═══════════════════════════════════════════
   THREE.JS SCENE
   ═══════════════════════════════════════════ */
function initScene(){
    const el=document.getElementById('c3d');
    scene=new THREE.Scene();
    scene.background=new THREE.Color(0xf0f0f2);

    camera=new THREE.PerspectiveCamera(42,el.clientWidth/el.clientHeight,.01,100);
    camera.position.set(2,2.5,2.8);

    renderer=new THREE.WebGLRenderer({antialias:true});
    renderer.setPixelRatio(Math.min(devicePixelRatio,2));
    renderer.setSize(el.clientWidth,el.clientHeight);
    renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFSoftShadowMap;
    renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.8;
    el.appendChild(renderer.domElement);

    controls=new THREE.OrbitControls(camera,renderer.domElement);
    controls.enableDamping=true;controls.dampingFactor=.08;
    controls.target.set(0,.25,0);controls.minDistance=.5;controls.maxDistance=10;controls.maxPolarAngle=Math.PI*.85;

    scene.add(new THREE.AmbientLight(0xffffff,1.2));
    const key=new THREE.DirectionalLight(0xffffff,2.2);
    key.position.set(2,8,3);key.castShadow=true;
    key.shadow.mapSize.set(2048,2048);key.shadow.camera.near=.1;key.shadow.camera.far=20;
    key.shadow.camera.left=-3;key.shadow.camera.right=3;key.shadow.camera.top=3;key.shadow.camera.bottom=-3;key.shadow.bias=-.001;
    scene.add(key);
    scene.add(new THREE.DirectionalLight(0xc8d0ff,.8).translateX(-4).translateY(5).translateZ(-2));
    scene.add(new THREE.DirectionalLight(0xffffff,.5).translateZ(-6).translateY(2));
    scene.add(new THREE.HemisphereLight(0xffffff,0xe8e8ea,.6));

    const grid=new THREE.GridHelper(5,24,0xccccce,0xdddddf);
    grid.material.opacity=.4;grid.material.transparent=true;scene.add(grid);
    const floor=new THREE.Mesh(new THREE.PlaneGeometry(10,10),new THREE.MeshStandardMaterial({color:0xe8e8ea,roughness:.85}));
    floor.rotation.x=-Math.PI/2;floor.position.y=-.005;floor.receiveShadow=true;scene.add(floor);

    buildCar();loadGLB();

    window.addEventListener('resize',()=>{
        camera.aspect=el.clientWidth/el.clientHeight;camera.updateProjectionMatrix();
        renderer.setSize(el.clientWidth,el.clientHeight);
    });

    const rc=new THREE.Raycaster(),v2=new THREE.Vector2();
    renderer.domElement.addEventListener('click',e=>{
        const r=renderer.domElement.getBoundingClientRect();
        v2.x=((e.clientX-r.left)/r.width)*2-1;
        v2.y=-((e.clientY-r.top)/r.height)*2+1;
        rc.setFromCamera(v2,camera);
        for(let i=0;i<seats.length;i++){
            if(seats[i].model&&rc.intersectObject(seats[i].model,true).length){sel(i);break;}
        }
    });
}

function buildCar(){
    const s=new THREE.Shape(),W=.8,FL=-.95,RL=.9,R=.2;
    s.moveTo(-W+R,FL);s.lineTo(W-R,FL);s.quadraticCurveTo(W,FL,W,FL+R);
    s.lineTo(W,RL-R);s.quadraticCurveTo(W,RL,W-R,RL);
    s.lineTo(-W+R,RL);s.quadraticCurveTo(-W,RL,-W,RL-R);
    s.lineTo(-W,FL+R);s.quadraticCurveTo(-W,FL,-W+R,FL);
    const m=new THREE.Mesh(new THREE.ShapeGeometry(s),new THREE.MeshStandardMaterial({color:0xc0c0c2,transparent:true,opacity:.18,roughness:.8,side:THREE.DoubleSide}));
    m.rotation.x=-Math.PI/2;m.position.y=.002;scene.add(m);
    const a=new THREE.Shape();a.moveTo(-.1,-1.02);a.lineTo(0,-1.14);a.lineTo(.1,-1.02);
    const am=new THREE.Mesh(new THREE.ShapeGeometry(a),new THREE.MeshBasicMaterial({color:0x007aff,transparent:true,opacity:.35,side:THREE.DoubleSide}));
    am.rotation.x=-Math.PI/2;am.position.y=.004;scene.add(am);
}

function loadGLB(){
    const loader=new THREE.GLTFLoader();let cnt=0;
    seats.forEach((seat,i)=>{
        loader.load('models/car-seat-rigged-v2.glb',gltf=>{
            const model=gltf.scene;
            const box=new THREE.Box3().setFromObject(model);
            const size=box.getSize(new THREE.Vector3());
            const center=box.getCenter(new THREE.Vector3());
            const sc=.8/Math.max(size.x,size.y,size.z);
            model.scale.setScalar(sc);
            model.position.set(seat.pos[0]-center.x*sc,seat.pos[1]-box.min.y*sc,seat.pos[2]-center.z*sc);

            const fp=new Set(['01 Base','02 Base rim','03 Base controls']);
            const sp=new Set(['05 Bottom sides','07 Seat back sides']);
            model.traverse(c=>{
                if(c.isMesh){
                    c.castShadow=true;c.receiveShadow=true;
                    const n=c.name||(c.parent&&c.parent.name)||'';
                    let col=0x2a2a2e,ro=.55,me=.04;
                    if(fp.has(n)){col=0x18181c;ro=.25;me=.65}
                    else if(sp.has(n)){col=0x353538;ro=.48;me=.05}
                    if(c.material){c.material.color.setHex(col);c.material.roughness=ro;c.material.metalness=me;c.material.needsUpdate=true}
                    if(c.isSkinnedMesh&&c.skeleton)c.skeleton.bones.forEach(b=>{if(!seat.bones[b.name])seat.bones[b.name]=b});
                }
                if(c.isBone&&!seat.bones[c.name])seat.bones[c.name]=c;
            });

            Object.entries(seat.bones).forEach(([n,b])=>{
                seat.rest[n]={px:b.position.x,py:b.position.y,pz:b.position.z,rx:b.rotation.x,ry:b.rotation.y,rz:b.rotation.z};
            });

            scene.add(model);seat.model=model;

            const ring=new THREE.Mesh(new THREE.RingGeometry(.28,.31,32),
                new THREE.MeshBasicMaterial({color:new THREE.Color(COL[i]),transparent:true,opacity:0,side:THREE.DoubleSide}));
            ring.rotation.x=-Math.PI/2;ring.position.set(seat.pos[0],.008,seat.pos[2]);
            scene.add(ring);seat.hl=ring;

            seat.hmC=mkOv(model,.22,.18,{rx:-Math.PI/2,y:1.15,z:-.45});
            seat.hmB=mkOv(model,.18,.26,{rx:-1.1,y:2.3,z:-1.35});

            cnt++;
            document.getElementById('lmsg').textContent='Loading... '+cnt+'/4';
            if(cnt===4){
                hilite();
                document.getElementById('loader').classList.add('done');
                const bNames=Object.keys(seats[0].bones).sort();
                document.getElementById('boneInfo').textContent=bNames.length+' bones · '+AXES.length+' axes · v2 GLB';
            }
        });
    });
}

function mkOv(parent,w,h,p){
    const cv=document.createElement('canvas');cv.width=64;cv.height=64;
    const tex=new THREE.CanvasTexture(cv);tex.minFilter=THREE.LinearFilter;
    const mesh=new THREE.Mesh(new THREE.PlaneGeometry(w,h),
        new THREE.MeshBasicMaterial({map:tex,transparent:true,opacity:.6,side:THREE.DoubleSide,depthWrite:false}));
    mesh.rotation.x=p.rx||0;mesh.position.set(p.x||0,p.y||0,p.z||0);
    parent.add(mesh);
    return{cv,tex};
}

function hilite(){
    seats.forEach((s,i)=>{
        const on=i===cur;
        if(s.hl)s.hl.material.opacity=on?.65:.1;
        if(s.model)s.model.traverse(c=>{
            if(c.isMesh&&c.material&&c.material.isMeshStandardMaterial){c.material.emissive.setHex(on?parseInt(COL[i].slice(1),16):0);c.material.emissiveIntensity=on?.18:0}
        });
    });
}

/* ═══════════════════════════════════════════
   PRESSURE
   ═══════════════════════════════════════════ */
function g2d(x,y,sx,sy){return Math.exp(-(x*x)/(2*sx*sx)-(y*y)/(2*sy*sy))}

function simPress(s,t){
    const w=s.weight/80,off=s.id*1.7;let sum=0,mx=0,cnt=0;
    const bolF=s.p.bolster/100*.15;
    for(let y=0;y<16;y++)for(let x=0;x<16;x++){
        const nx=(x/15)*2-1,ny=(y/15)*2-1;
        let v=(g2d(nx+.35-bolF,ny-.1,.28,.32)+g2d(nx-.35+bolF,ny-.1,.28,.32)+g2d(nx+.3-bolF,ny+.25,.22,.4)*.35+g2d(nx-.3+bolF,ny+.25,.22,.4)*.35)*w;
        v+=Math.sin((t+off)*.3)*.01+(Math.random()-.5)*.005;
        v=Math.max(0,Math.min(1,v));
        s.grid[y*16+x]=v;
        if(v>.01){sum+=v;cnt++;mx=Math.max(mx,v)}
    }
    s.avg=cnt>0?(sum/cnt*100):0;s.peak=mx*100;
}

function updOv(s){
    [s.hmC,s.hmB].forEach(ov=>{
        if(!ov)return;
        const ctx=ov.cv.getContext('2d');ctx.clearRect(0,0,64,64);
        if(s.weight<1){ov.tex.needsUpdate=true;return}
        for(let y=0;y<16;y++)for(let x=0;x<16;x++){
            const v=s.grid[y*16+x];
            if(v>.02){ctx.fillStyle=pRGBA(v);ctx.fillRect(x*4,y*4,4,4)}
        }
        ov.tex.needsUpdate=true;
    });
}

/* ═══════════════════════════════════════════
   9-AXIS BONE CONTROL
   ═══════════════════════════════════════════ */
function setPose(axis,val){
    seats[cur].p[axis]=val;
    applyBone(seats[cur],axis,val);
    syncSliders();
}

function applyBone(s,axis,val){
    const R=s.rest,B=s.bones,d=THREE.MathUtils.degToRad;
    switch(axis){
        case'slide':   if(B.Slide&&R.Slide)       B.Slide.position.z   =R.Slide.pz    -(val/100)*.5; break;
        case'height':  if(B.Cushion&&R.Cushion)    B.Cushion.position.y =R.Cushion.py  +(val/100)*.3; break;
        case'tilt':    if(B.Cushion&&R.Cushion)    B.Cushion.rotation.x =R.Cushion.rx  +d(val); break;
        case'recline': if(B.Backrest&&R.Backrest)  B.Backrest.rotation.x=R.Backrest.rx +d(val); break;
        case'hrH':     if(B.Headrest&&R.Headrest)  B.Headrest.position.y=R.Headrest.py +(val/100)*.5; break;
        case'hrT':     if(B.Headrest&&R.Headrest)  B.Headrest.rotation.x=R.Headrest.rx +d(val); break;
        case'bolster':
            if(B.BolsterL&&R.BolsterL) B.BolsterL.position.x=R.BolsterL.px+(val/100)*.15;
            if(B.BolsterR&&R.BolsterR) B.BolsterR.position.x=R.BolsterR.px-(val/100)*.15;
            break;
        case'lumbar':
            if(B.Lumbar&&R.Lumbar) B.Lumbar.position.z=R.Lumbar.pz-(val/100)*.3;
            break;
        case'bBolster':
            if(B.BackBolsterL&&R.BackBolsterL) B.BackBolsterL.position.x=R.BackBolsterL.px+(val/100)*.12;
            if(B.BackBolsterR&&R.BackBolsterR) B.BackBolsterR.position.x=R.BackBolsterR.px-(val/100)*.12;
            break;
    }
}

function animTargets(dt){
    seats.forEach(s=>{
        if(!s.target)return;
        let done=true;
        AXES.forEach(k=>{
            const diff=s.target[k]-s.p[k];
            if(Math.abs(diff)>.3){s.p[k]+=diff*dt*5;done=false}
            else s.p[k]=s.target[k];
            applyBone(s,k,s.p[k]);
        });
        if(done)s.target=null;
    });
}

function goPreset(name,btn){
    document.getElementById('presetBtns').querySelectorAll('.pb').forEach(b=>b.classList.remove('on'));
    btn.classList.add('on');
    seats[cur].target={...PRESETS[name]};
}

function resetPose(){
    seats[cur].target={...ZERO};
    document.getElementById('presetBtns').querySelectorAll('.pb').forEach(b=>b.classList.remove('on'));
    toast('Reset to default');
}

/* ═══════════════════════════════════════════
   UI
   ═══════════════════════════════════════════ */
function sel(i){
    cur=i;hilite();syncSliders();
    document.querySelectorAll('.seat-pill').forEach((p,j)=>p.classList.toggle('sel',j===i));
    document.getElementById('sheetDot').style.background=COL[i];
    document.getElementById('sheetLabel').textContent=seats[i].label+' '+seats[i].name;
    document.getElementById('wSl').value=seats[i].weight;
    document.getElementById('wVal').textContent=seats[i].weight+' kg';
    document.getElementById('presetBtns').querySelectorAll('.pb').forEach(b=>b.classList.remove('on'));
}

function syncSliders(){
    const p=seats[cur].p;
    document.getElementById('sSlide').value=p.slide;   document.getElementById('vSlide').textContent=Math.round(p.slide);
    document.getElementById('sHeight').value=p.height;  document.getElementById('vHeight').textContent=Math.round(p.height);
    document.getElementById('sTilt').value=p.tilt;      document.getElementById('vTilt').textContent=Math.round(p.tilt)+'°';
    document.getElementById('sRecline').value=p.recline; document.getElementById('vRecline').textContent=Math.round(p.recline)+'°';
    document.getElementById('sHrH').value=p.hrH;        document.getElementById('vHrH').textContent=Math.round(p.hrH);
    document.getElementById('sHrT').value=p.hrT;        document.getElementById('vHrT').textContent=Math.round(p.hrT)+'°';
    document.getElementById('sBol').value=p.bolster;    document.getElementById('vBol').textContent=Math.round(p.bolster)+'%';
    document.getElementById('sLum').value=p.lumbar;     document.getElementById('vLum').textContent=Math.round(p.lumbar)+'%';
    document.getElementById('sBBol').value=p.bBolster;  document.getElementById('vBBol').textContent=Math.round(p.bBolster)+'%';
}

function updStats(){
    const s=seats[cur];
    document.getElementById('pAvg').textContent=s.avg.toFixed(1);
    document.getElementById('pPeak').textContent=s.peak.toFixed(1);
    const cv=document.getElementById('miniHeat'),ctx=cv.getContext('2d');
    ctx.clearRect(0,0,160,160);
    for(let y=0;y<16;y++)for(let x=0;x<16;x++){
        const v=s.grid[y*16+x];
        if(v>.01){ctx.fillStyle=pRGBA(v);ctx.fillRect(x*10,y*10,10,10)}
    }
}

function setWt(w){seats[cur].weight=w;document.getElementById('wVal').textContent=w+' kg'}

function switchTab(name,btn){
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('sel'));
    btn.classList.add('sel');
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('vis'));
    document.getElementById('tab-'+name).classList.add('vis');
}

/* ═══════════════════════════════════════════
   BONE DIAGRAM
   ═══════════════════════════════════════════ */
function drawBoneDiagram(){
    const cv=document.getElementById('boneCv'),ctx=cv.getContext('2d');
    const W=cv.width,H=cv.height,p=seats[cur].p;
    ctx.clearRect(0,0,W,H);
    const dim='#aeaeb2';

    // Side View
    const ox=75,oy=120;
    ctx.fillStyle=dim;ctx.font='600 7px Inter';ctx.textAlign='center';
    ctx.fillText('SIDE',75,10);
    ctx.fillStyle=dim;ctx.fillRect(ox-25,oy-2,50,4);

    const slideOff=-(p.slide/100)*25,sx=ox+slideOff;
    const cushH=-(p.height/100)*18,cushY=oy-8+cushH;
    const tiltRad=p.tilt*Math.PI/180;

    ctx.save();ctx.translate(sx,cushY);ctx.rotate(-tiltRad);
    ctx.fillStyle='rgba(0,122,255,.15)';ctx.fillRect(-20,-3,40,6);
    ctx.strokeStyle='#007aff';ctx.lineWidth=1.5;ctx.strokeRect(-20,-3,40,6);
    ctx.restore();

    const bx=sx-10,by=cushY-5;
    const recRad=(20+p.recline)*Math.PI/180,bLen=45;
    const btx=bx-Math.sin(recRad)*bLen,bty=by-Math.cos(recRad)*bLen;
    ctx.strokeStyle='#af52de';ctx.lineWidth=3;ctx.lineCap='round';
    ctx.beginPath();ctx.moveTo(bx,by);ctx.lineTo(btx,bty);ctx.stroke();
    ctx.fillStyle='#af52de';ctx.beginPath();ctx.arc(bx,by,3,0,Math.PI*2);ctx.fill();

    if(p.lumbar>1){
        const lFrac=.35,lx=bx-Math.sin(recRad)*bLen*lFrac,ly=by-Math.cos(recRad)*bLen*lFrac;
        const push=p.lumbar/100*8,nx=Math.cos(recRad)*push,ny=-Math.sin(recRad)*push;
        ctx.fillStyle='rgba(255,59,48,.3)';ctx.beginPath();ctx.arc(lx+nx,ly+ny,4+push*.3,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='#ff3b30';ctx.beginPath();ctx.arc(lx+nx,ly+ny,2,0,Math.PI*2);ctx.fill();
    }

    const hrOff=(p.hrH/100)*12,hrTR=p.hrT*Math.PI/180;
    const hx=btx-Math.sin(recRad)*hrOff,hy=bty-Math.cos(recRad)*hrOff;
    ctx.save();ctx.translate(hx,hy);ctx.rotate(-recRad-hrTR);
    ctx.fillStyle='rgba(255,100,130,.2)';ctx.fillRect(-7,-5,14,10);
    ctx.strokeStyle='#ff6482';ctx.lineWidth=1.2;ctx.strokeRect(-7,-5,14,10);
    ctx.restore();

    // Front View
    const cx=200,cy=80;
    ctx.fillStyle=dim;ctx.font='600 7px Inter';ctx.textAlign='center';
    ctx.fillText('FRONT',200,10);

    const cw=50,ch=12;
    ctx.fillStyle='rgba(0,122,255,.1)';ctx.fillRect(cx-cw/2,cy-ch/2,cw,ch);
    ctx.strokeStyle='#007aff';ctx.lineWidth=1;ctx.strokeRect(cx-cw/2,cy-ch/2,cw,ch);

    const bolS=p.bolster/100*10;
    ctx.fillStyle='rgba(48,176,199,.3)';
    ctx.fillRect(cx-cw/2-6+bolS,cy-ch/2-2,6,ch+4);ctx.strokeStyle='#30b0c7';ctx.lineWidth=1;ctx.strokeRect(cx-cw/2-6+bolS,cy-ch/2-2,6,ch+4);
    ctx.fillStyle='rgba(48,176,199,.3)';
    ctx.fillRect(cx+cw/2-bolS,cy-ch/2-2,6,ch+4);ctx.strokeStyle='#30b0c7';ctx.lineWidth=1;ctx.strokeRect(cx+cw/2-bolS,cy-ch/2-2,6,ch+4);
    if(p.bolster>5){ctx.fillStyle='#30b0c7';ctx.font='bold 9px Inter';ctx.fillText('→',cx-cw/2-12+bolS,cy+3);ctx.fillText('←',cx+cw/2+6-bolS,cy+3)}

    const bcy=cy-35,bcw=44,bch=30;
    ctx.fillStyle='rgba(175,82,222,.08)';ctx.fillRect(cx-bcw/2,bcy-bch/2,bcw,bch);
    ctx.strokeStyle='#af52de';ctx.lineWidth=1;ctx.strokeRect(cx-bcw/2,bcy-bch/2,bcw,bch);
    const bbS=p.bBolster/100*8;
    ctx.fillStyle='rgba(175,82,222,.25)';
    ctx.fillRect(cx-bcw/2-5+bbS,bcy-bch/2-1,5,bch+2);ctx.strokeStyle='#af52de';ctx.lineWidth=1;ctx.strokeRect(cx-bcw/2-5+bbS,bcy-bch/2-1,5,bch+2);
    ctx.fillStyle='rgba(175,82,222,.25)';
    ctx.fillRect(cx+bcw/2-bbS,bcy-bch/2-1,5,bch+2);ctx.strokeStyle='#af52de';ctx.lineWidth=1;ctx.strokeRect(cx+bcw/2-bbS,bcy-bch/2-1,5,bch+2);

    if(p.lumbar>1){
        const lPush=p.lumbar/100*6;
        ctx.fillStyle='rgba(255,59,48,.3)';ctx.beginPath();ctx.arc(cx,bcy+bch/4+2,3+lPush*.5,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='#ff3b30';ctx.beginPath();ctx.arc(cx,bcy+bch/4+2,2,0,Math.PI*2);ctx.fill();
    }

    ctx.fillStyle=dim;ctx.font='500 7px Inter';ctx.textAlign='center';
    ctx.fillText('Cushion',cx,cy+16);ctx.fillText('Backrest',cx,bcy-bch/2-4);

    ctx.strokeStyle='rgba(0,0,0,.06)';ctx.lineWidth=1;ctx.setLineDash([3,3]);
    ctx.beginPath();ctx.moveTo(135,15);ctx.lineTo(135,H-5);ctx.stroke();ctx.setLineDash([]);
}

/* ═══════════════════════════════════════════
   COLORS & UTILS
   ═══════════════════════════════════════════ */
function pRGBA(t){
    t=Math.max(0,Math.min(1,t));let r,g,b;
    if(t<.25){const f=t/.25;r=0;g=Math.round(f*255);b=255}
    else if(t<.5){const f=(t-.25)/.25;r=0;g=255;b=Math.round(255*(1-f))}
    else if(t<.75){const f=(t-.5)/.25;r=Math.round(255*f);g=255;b=0}
    else{const f=(t-.75)/.25;r=255;g=Math.round(255*(1-f));b=0}
    return'rgba('+r+','+g+','+b+','+(0.3+t*.7)+')';
}

let tt;
function toast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');clearTimeout(tt);tt=setTimeout(()=>t.classList.remove('show'),2000)}
function drawLeg(){const ctx=document.getElementById('legCv').getContext('2d');for(let x=0;x<100;x++){ctx.fillStyle=pRGBA(x/100);ctx.fillRect(x,0,1,8)}}

/* ═══════════════════════════════════════════
   BOTTOM SHEET TOUCH HANDLING
   ═══════════════════════════════════════════ */
(function initBottomSheet(){
    const sheet=document.getElementById('bottomSheet');
    const handle=document.getElementById('dragHandle');
    const scroll=document.getElementById('sheetScroll');
    const chev=document.getElementById('sheetChev');
    let startY=0, startH=0, dragging=false;
    const minH=56;
    const maxPct=75;
    const collapsedPct=45;

    function getMaxH(){return window.innerHeight*maxPct/100}
    function getCollH(){return window.innerHeight*collapsedPct/100}

    handle.addEventListener('touchstart',e=>{
        dragging=true;
        startY=e.touches[0].clientY;
        startH=sheet.offsetHeight;
        sheet.style.transition='none';
    },{passive:true});

    document.addEventListener('touchmove',e=>{
        if(!dragging)return;
        const dy=startY-e.touches[0].clientY;
        let newH=Math.max(minH,Math.min(getMaxH(),startH+dy));
        sheet.style.height=newH+'px';
    },{passive:true});

    document.addEventListener('touchend',()=>{
        if(!dragging)return;
        dragging=false;
        sheet.style.transition='height .35s cubic-bezier(.32,.72,0,1)';
        const h=sheet.offsetHeight;
        const snapCollapsed=minH;
        const snapExpanded=getCollH();
        const snapFull=getMaxH();
        const dC=Math.abs(h-snapCollapsed);
        const dE=Math.abs(h-snapExpanded);
        const dF=Math.abs(h-snapFull);
        if(dC<=dE&&dC<=dF){
            sheet.style.height=minH+'px';
            sheet.classList.add('collapsed');
            chev.className='fas fa-chevron-up';
        }else if(dF<=dE){
            sheet.style.height=maxPct+'%';
            sheet.classList.remove('collapsed');
            chev.className='fas fa-chevron-down';
        }else{
            sheet.style.height=collapsedPct+'%';
            sheet.classList.remove('collapsed');
            chev.className='fas fa-chevron-down';
        }
    });

    handle.addEventListener('click',()=>{
        if(sheet.classList.contains('collapsed')){
            sheet.classList.remove('collapsed');
            sheet.style.height=collapsedPct+'%';
            chev.className='fas fa-chevron-down';
        }else{
            sheet.classList.add('collapsed');
            sheet.style.height=minH+'px';
            chev.className='fas fa-chevron-up';
        }
    });

    scroll.addEventListener('touchstart',e=>{e.stopPropagation()},{passive:true});
})();

/* ═══════════════════════════════════════════
   LOOP
   ═══════════════════════════════════════════ */
let lastUI=0;
function animate(){
    requestAnimationFrame(animate);
    const dt=Math.min(clock.getDelta(),.1),t=clock.getElapsedTime();

    seats.forEach(s=>{simPress(s,t);updOv(s)});
    animTargets(dt);
    if(seats[cur].target)syncSliders();

    if(t-lastUI>.2){updStats();drawBoneDiagram();lastUI=t}
    controls.update();renderer.render(scene,camera);
}

/* ═══════════════════════════════════════════
   INIT
   ═══════════════════════════════════════════ */
initScene();drawLeg();syncSliders();animate();
</script>
</body>
</html>
